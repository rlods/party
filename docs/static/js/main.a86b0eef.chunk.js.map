{"version":3,"sources":["components/Common/Icon.tsx","components/Common/IconButton.tsx","utils/clipboard.ts","selectors/room.ts","utils/messages.ts","reducers/modals.ts","actions/index.ts","reducers/messages.ts","actions/messages.ts","actions/modals.ts","selectors/medias.ts","components/Room/Head.tsx","components/Common/LoadingIcon.tsx","components/Room/Cover.tsx","components/Room/Medias.tsx","components/Room/QueueItem.tsx","components/Room/QueueList.tsx","utils/index.ts","utils/games/seabattle/index.ts","utils/games/seabattle/mappings.ts","utils/games/seabattle/generator.ts","utils/rooms.ts","config/firebase.ts","utils/firebase/index.ts","utils/firebase/room.ts","utils/images.ts","utils/colorpicker.ts","utils/audio.ts","utils/player.ts","config/proxy.ts","utils/sign.ts","utils/proxy.ts","utils/providers/deezer.ts","utils/providers/spotify.ts","utils/providers/index.ts","reducers/medias.ts","reducers/room.ts","utils/medias.ts","actions/medias.ts","utils/history.ts","actions/room.ts","actions/player.ts","actions/queue.ts","selectors/queue.ts","components/Room/Queue.tsx","components/Room/AudioPlayerControls.tsx","components/Room/Progress.tsx","components/Room/QueueControls.tsx","components/Room/RoomControls.tsx","components/SeaBattle/PlayerControls.tsx","components/SeaBattle/Assets.tsx","components/SeaBattle/Weapons.tsx","components/SeaBattle/Hits.tsx","components/SeaBattle/Boats.tsx","components/SeaBattle/Fleet.tsx","components/SeaBattle/BattleAssets.tsx","utils/svg.ts","components/SeaBattle/Map.tsx","utils/games/seabattle/collision.ts","actions/games/seabattle.ts","components/SeaBattle/OpponentSelection.tsx","components/SeaBattle/WeaponSelection.tsx","components/SeaBattle/OpponentControls.tsx","pages/games/SeaBattle.tsx","utils/keyboards.ts","selectors/messages.ts","components/Common/Messages.tsx","pages/Room.tsx","utils/firebase/user.ts","utils/users.ts","reducers/user.ts","actions/user.ts","pages/Splash.tsx","components/Modals/Modal.tsx","components/Modals/FormModal.tsx","components/Common/CancelButton.tsx","components/Modals/ConfirmModal.tsx","components/Modals/ModalFields.tsx","components/Users/ConnectUserModal.tsx","components/Room/CreateRoomModal.tsx","components/Users/CreateUserModal.tsx","components/Modals/HelpModal.tsx","components/SeaBattle/GameOverModal.tsx","components/SeaBattle/HelpModal.tsx","components/Room/SearchResultCategory.tsx","components/Room/SearchModal.tsx","components/Room/JoinRoomModal.tsx","components/Room/UnlockRoomModal.tsx","components/Modals/index.tsx","reducers/app.ts","pages/App.tsx","locales/en.ts","locales/fr.ts","utils/i18n.ts","serviceWorker.ts","reducers/games/seabattle.ts","reducers/games/index.ts","reducers/index.ts","utils/redux.ts","index.tsx","utils/encoder.ts"],"names":["Icon","React","memo","className","color","icon","size","title","classNames","name","style","IconButton","disabled","displayTitle","kind","onClick","type","aria-label","clickable","copyToClipboard","value","a","Promise","resolve","elem","document","createElement","setAttribute","position","left","body","appendChild","selection","getSelection","selected","rangeCount","getRangeAt","select","execCommand","removeAllRanges","addRange","removeChild","selectRoomName","state","room","info","isRoomLoaded","_fbRoom","isRoomLocked","access","secret","extractErrorMessage","err","response","data","message","openModal","prereq","createAction","popModal","initialState","stack","payload","trySomething","options","dispatch","res","onAction","props","onFailure","onSuccess","displayError","removeMessage","id","clearMessages","tag","INITIAL_STATE","MESSAGE_ID_GENERATOR","displayMessage","autoclear","closable","duration","extra","text","weight","getState","messages","oldEntry","Object","entries","find","_","oldID","oldMessage","Number","timer","clearTimeout","addMessage","stamp","Date","getTime","setTimeout","displayInfo","displaySuccess","confirmModal","question","onConfirmed","onCanceled","window","confirm","selectTracks","medias","tracks","track","provider","push","selectTracksCount","length","Head","useDispatch","fetching","useSelector","t","useTranslation","history","useHistory","loaded","mediasCount","tracksCount","onCopy","useCallback","location","href","split","onExit","count","LoadingIcon","Cover","playable","playing","image","onPlay","onStop","backgroundImage","Media","actions","media","picture_small","link","target","rel","artist","user","preview","album","QueueItem","locked","onRemove","QueueList","playingIndex","map","index","key","EmptyQueueList","onSearch","sleep","delay","chunkArray","arr","chunkSize","slice","SeaBattleDirections","AngleToDirection","angle","augmentedArrayIndexAccess","idx","DirectionToAngle","E","S","W","N","SeaBattleBoatTypes","BoatsOffsetMappings","boat1","x","y","boat2","boat3","HitsOffsetInBoatMappings","hitted","missed","HitsOffsetInCellMappings","SeaBattleWeaponTypes","SeaBattleWeaponsOffsetMappings","bullet1","bullet2","bullet3","mine","extractOpponentMaps","maps","userId","values","filter","other","checkUserHasBatton","battle","currentMapIndex","passBatonToNextPlayer","decodeBattle","decode","encodeBattle","encode","SeaBattleBoatRotationTransformationMappings","SeaBattleKeyboardMoveMappings","SeaBattleBoatTranslationMappings","move_forward","move_backward","SeaBattleBoatLengthMappings","SeaBattleMovementIconMappings","generateBattle","console","debug","generateFleet","getCell","grid","setCell","checkAvailable","pos","dir","boatLength","i","generatePlace","Math","floor","random","getValidBoatTypes","maxLength","Array","fill","fleetSet","fleetCumulatedSize","typeChoices","typeChoice","fleet","reverse","boatSetting","rawType","boat","hits","status","newMap","opponentsWeapons","weapons","RoomTypes","createQueueMerging","accesses1","accesses2","forEach","createQueueRemoving","accesses","Error","copy","splice","initializeRoom","queue","playmode","0","1","2","3","config","dbIDs","process","dbPrefix","selectRoomDatabaseId","selectUserDatabaseId","APPS","createOrGetApp","dbId","databaseURL","firebaseConfig","app","firebase","database","rooms","ref","users","FirebaseRoom","roomId","_room","child","_extra","_info","_queue","_secret","wait","all","once","val","init","update","timestamp","ServerValue","TIMESTAMP","isLocked","setSecret","newSecret","oldSecret","subscribeExtra","cb","on","snapshot","subscribeInfo","subscribeQueue","unsubscribeExtra","handler","off","unsubscribeInfo","unsubscribeQueue","updateExtra","updateInfo","updateQueue","getImageMainColor","url","jimp","resize","getPixelColor","pixel","r","g","b","CACHE","DEFAULT_COLOR","bg","fg","pickColor","error","AUDIO_BUFFER_CACHES","AUDIO_CONTEXT","getContext","AudioContext","webkitAudioContext","getCurrentTime","currentTime","decodeAudioData","encodedBuffer","reject","loadAudioBuffer","req","XMLHttpRequest","open","responseType","addEventListener","send","getOrLoadAudioBuffer","buffer","findIndex","item","fixAudioContext","removeEventListener","context","createBuffer","source","createBufferSource","connect","destination","start","generateRandomPosition","PlayerImpl","_analyserNode","_gainNode","_node","_duration","_sourceNode","_startTime","_trackId","_trackPosition","getOrCreateNode","createGain","gain","createAnalyser","fftSize","play","trackPosition","trackId","trackUrl","offset","stop","loop","loopStart","loopEnd","onended","playbackRate","getPlayingTrackID","getPlayingTrackPercent","getPlayingTrackPosition","isPlaying","computePlayerNextPosition","playStarted","playingTrackID","playingTrackIndex","trackIndex","nextIndex","QUEUE_PLAYER","PREVIEW_PLAYER","sign","params","hmac","crypto","createHmac","sort","e1","e2","localeCompare","kvp","digest","callProxy","path","axios","get","proxyConfig","s","WWW_BASE","ConvertAlbum","toString","picture_big","cover_big","cover_small","readable","ConvertTrack","ConvertPlaylist","playlist","DeezerApiImpl","_call","_search","query","limit","q","encodeURIComponent","_load","ids","delayedIds","failedIds","loadedMedias","log","code","_loadWithRetry","first","remainingIds","searchAlbums","trim","searchPlaylists","public","searchTracks","loadAlbums","albums","loadPlaylists","playlists","creator","loadTracks","DEFAULT_IMPL","getDeezerApi","artists","images","items","preview_url","owner","display_name","SpotifyApiImpl","market","join","getSpotifyApi","loadMedias","deezer","spotify","deezerApi","spotifyApi","flatten","loadNewMedias","oldMedias","newAccesses","self","newMedias","newMediasAndTracks","searchMedias","providerType","mediaType","deezerAlbums","deezerPlaylists","deezerTracks","spotifyAlbums","spotifyPlaylists","spotifyTracks","collection","results","providerApi","setMedias","setRoom","MEDIA_TYPE_DEFINITIONS","label","findMediaInDict","findMedia","dist","list","findMediaInList","findPreview","extractTracks","contextId","contextType","container","findContextFromTrackIndex","allMedias","mediaIndex","mediaFirstTrackIndex","mediaSize","displayMediaInfo","renderMediaInToaster","previewMedia","createHashHistory","createRoom","v4","enterRoom","exitRoom","newFbRoom","_watchRoom","_watchPlayer","_unwatchPlayer","_unwatchRoom","lockRoom","unlockRoom","EXTRA_SUBSCRIPTION","INFO_SUBSCRIPTION","QUEUE_SUBSCRIPTION","fbRoom","newExtra","newInfo","newQueue","m1","m2","m","PLAYER_TIMER","player","_scheduleTimer","ms","nextTrackIndex","nextAccess","nextTrack","startPlayer","propagate","stopPlayer","clearQueue","appendToQueue","removeFromQueue","removedTrackIndex","removedMediaFirstTrackIndex","removedMediaIndex","removedTrackCount","keys","setQueuePosition","newPosition","oldPosition","moveToPreviousTrack","moveToNextTrack","selectQueuePosition","selectRoomPlaymode","isRoomPlaying","Queue","AudioPlayerControls","bigPlayer","onMoveBackward","onMoveForward","Progress","useState","setValue","useEffect","step","requestAnimationFrame","cancelAnimationFrame","max","QueueControls","onHelp","onClear","onLock","onUnlock","RoomControls","extended","SeaBattlePlayerControls","onRotateLeft","onRotateRight","Asset","stopPropagation","transform","visibility","e","Cell","asset","Weapon","Weapons","weapon","Hit","Hits","hit","Boat","hideFleet","Fleet","selectedBoatIndex","onSelectBoatIndex","BattleAssets","cx","cy","points","fillRule","d","width","height","patternUnits","getSVGNormalizedPosition","svg","pt","createSVGPoint","tx","matrixTransform","getScreenCTM","inverse","ty","getSVGPosition","Map","onCellClick","useRef","selectedPos","setSelectedPos","selectedVis","setSelectedVis","selectionPos","setSelectionPos","selectionVis","setSelectionVis","normalizedPos","current","onLeave","onOver","viewBox","clientX","clientY","onMouseLeave","onMouseMove","getGridCell","setGridCell","cell","checkPositionInZone","generateGrid","movingBoat","boatIndex","boatCount","boatLocalIndex","movementIsPossible","newPos","newDir","checkZone","checkCollisions","joinBattle","moveBoat","movement","playerMap","oldAngle","oldDirection","newAngle","newDirection","attackOpponent","opponentIndex","weaponType","opponentMaps","opponentMap","opponentBoat","OpponentSelection","opponentsCount","onSelectPreviousOpponent","onSelectNextOpponent","WeaponSelection","onSelect","indexOf","opponentId","SeaBattleOpponentControls","onSelectWeaponType","SeaBattle","previousMapIndex","setPreviousMapIndex","setSelectedBoatIndex","setSelectedOpponent","setSelectedWeaponType","playerMapIndex","extractBattleInfo","onJoinBattle","onMove","onKeyDown","repeat","keyCode","preventDefault","onConnectUser","onOpponentCellClick","selectMessages","Messages","bottomPosition","bottom","timeout","enter","exit","Room","search","useLocation","useParams","qs","parse","substr","backgroundColor","FirebaseUser","_user","_values","online","installDisconnect","onDisconnect","cancel","loadUserAccess","localStorage","getItem","deleteUserAccess","removeItem","setUser","_fbUser","createUser","connectUser","disconnectUser","newFbUser","reconnectUser","Splash","loggedIn","onCreateRoom","onCreateUser","onShowHelp","to","src","alt","Modal","children","renderFoot","onSubmit","has_prev_modal","modals","onClose","onPop","event","hidden","FormModal","renderButtons","CancelButton","ConfirmModal","onCancel","ModalField","InputField","forwardRef","htmlFor","SecretField","onChange","placeholder","onCopyToClipboard","display","flexDirection","justifyContent","flexGrow","marginRight","autoComplete","minLength","required","SelectField","option","ConnectUserModal","setUserId","userIdRef","focus","onConnect","ROOM_COUNTER","CreateRoomModal","defaultType","setName","setType","nameRef","onCreate","USER_COUNTER","CreateUserModal","HelpModal","onJoinRoom","SeaBattleGameOverModal","onRestart","SeaBattleHelpModal","SearchResultCategory","onViewMore","SearchModal","queryRef","playingMediaId","setPlayingMediaId","playingMediaProvider","setPlayingMediaProvider","playingMediaType","setPlayingMediaType","setQuery","setResults","onStartPreview","onStopPreview","JoinRoomModal","setDbId","setRoomId","roomIdRef","onJoin","s1","s2","otherId","UnlockRoomModal","secretRef","Modals","currPrereq","setCurrPrereq","prevPrereq","setPrevPrereq","onPopModal","keyDown","modal","getModal","in","unmountOnExit","role","navigator","onLine","App","onOnlineStatusChange","exact","component","audio","errors","cannot_decode_audio_data","cannot_load_audio_buffer","splash","CGU","powered_with","description","help","rules","rule1","rule1b","rule2","rule2b","notes","note1","note2","invalid","confirm_disconnect","connection","create","disconnect","id_is_invalid","id_placeholder","name_is_invalid","name_placeholder","secret_is_invalid","secret_placeholder","user_creation","not_connected","types","blind","dj","seabattle","clear","confirm_clear","confirm_exit","confirm_lock","copy_link","empty","empty_for_now","server_id","server_id_placeholder","key_placeholder","type_placeholder","link_copied_to_clipboard","loading","room_creation","room_join","room_unlocking","unlock","unlocked","media_count","media_count_plural","track_count","track_count_plural","by","add","remove","search_placeholder","medias_search","backward","forward","copy_to_clipboard","secret_copied_to_clipboard","games","you_can","move_boat","attack_opponent","to_move","select_boat","move_with_keyboard","or_use_the_buttons","to_attack","select_weapon","click_opponent_cell","to_react","hitted_hit","missed_hit","turn_left","turn_right","move_down","move_left","move_right","move_up","movement_not_possible","movement_not_possible_because_hitted","opponent_index","join_battle","ship_already_hitted","ship_already_killed","hitted_opponent","killed_opponent_boat","missed_opponent","no_weapon_selected","weapon_not_available","not_your_turn","opponent_turn","player_turn","you_lost1","you_lost2","you_won1","you_won2","gameover","max_players_count","no_opponents","no_opponents_to_attack","connect_to_join","watch_or_join","initLocales","language","userLanguage","i18next","use","initReactI18next","fallbackLng","lng","resources","en","translation","fr","interpolation","escapeValue","format","isLocalhost","Boolean","hostname","match","registerValidSW","swUrl","serviceWorker","register","then","registration","onupdatefound","installingWorker","installing","onstatechange","controller","onUpdate","catch","gamesReducer","combineReducers","action","rootReducer","pop","setItem","initStore","composeEnhancers","compose","store","createStore","applyMiddleware","thunk","withExtraArgument","bind","URL","origin","fetch","headers","contentType","ready","unregister","reload","checkValidServiceWorker","registerServiceWorker","ReactDOM","getElementById","Buffer","from","JSON","stringify"],"mappings":"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","file":"static/js/main.a86b0eef.chunk.js","sourcesContent":["import React, { FC } from \"react\";\nimport FontAwesome from \"react-fontawesome\";\nimport classNames from \"classnames\";\n//\nimport \"./Icon.scss\";\n\n// ------------------------------------------------------------------\n\nexport type IconSize = \"S\" | \"M\" | \"L\" | \"XL\";\n\n// ------------------------------------------------------------------\n\nexport const Icon: FC<{\n\tclassName?: string;\n\tcolor?: string;\n\ticon: string;\n\tsize?: IconSize;\n\ttitle?: string;\n}> = React.memo(({ className, color, icon, size = \"M\", title }) => (\n\t<FontAwesome\n\t\tclassName={classNames(\"Icon\", className, size)}\n\t\tname={icon}\n\t\tstyle={{ color }}\n\t\ttitle={title}\n\t/>\n));\n","import React, { FC } from \"react\";\nimport classNames from \"classnames\";\n//\nimport { Icon, IconSize } from \"./Icon\";\nimport \"./IconButton.scss\";\n\n// ------------------------------------------------------------------\n\ntype ButtonType = \"button\" | \"submit\";\n\nexport const IconButton: FC<{\n\tclassName?: string;\n\tcolor?: string;\n\tdisabled?: boolean;\n\tdisplayTitle?: boolean;\n\ticon: string;\n\tkind?: \"default\" | \"primary\" | \"danger\" | \"special\";\n\tonClick?: () => void;\n\tsize?: IconSize;\n\ttitle: string;\n\ttype?: ButtonType;\n}> = React.memo(\n\t({\n\t\tclassName,\n\t\tcolor,\n\t\tdisabled = false,\n\t\tdisplayTitle = false,\n\t\ticon,\n\t\tkind = \"default\",\n\t\tonClick,\n\t\tsize,\n\t\ttitle,\n\t\ttype = \"button\"\n\t}) => (\n\t\t<button\n\t\t\ttype={type}\n\t\t\taria-label={title}\n\t\t\tclassName={classNames(\"IconButton\", className, kind, {\n\t\t\t\tclickable: !disabled && (!!onClick || type === \"submit\")\n\t\t\t})}\n\t\t\tonClick={disabled ? void 0 : onClick}\n\t\t\ttitle={title}>\n\t\t\t<Icon color={color} icon={icon} size={size} />\n\t\t\t{displayTitle && (\n\t\t\t\t<div className={classNames(\"IconButtonTitle\", size)}>\n\t\t\t\t\t{title}\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</button>\n\t)\n);\n","// https://hackernoon.com/copying-text-to-clipboard-with-javascript-df4d4988697f\nexport const copyToClipboard = async (value: string): Promise<void> =>\n\tawait new Promise(resolve => {\n\t\tconst elem = document.createElement(\"textarea\");\n\t\telem.value = value;\n\t\telem.setAttribute(\"readonly\", \"\");\n\t\telem.style.position = \"absolute\";\n\t\telem.style.left = \"-9999px\";\n\n\t\tdocument.body.appendChild(elem);\n\t\tconst selection = document.getSelection();\n\t\tif (selection !== null) {\n\t\t\tconst selected =\n\t\t\t\tselection.rangeCount > 0 ? selection.getRangeAt(0) : false;\n\t\t\telem.select();\n\t\t\tdocument.execCommand(\"copy\");\n\t\t\tif (selected !== false) {\n\t\t\t\tselection.removeAllRanges();\n\t\t\t\tselection.addRange(selected);\n\t\t\t}\n\t\t}\n\t\tdocument.body.removeChild(elem);\n\t\tresolve();\n\t});\n","import { RootState } from \"../reducers\";\n\n// ------------------------------------------------------------------\n\nexport const selectRoomName = (state: RootState): string =>\n\tstate.room.info?.name || \"\";\n\nexport const isRoomLoaded = (state: RootState): boolean => !!state.room._fbRoom;\n\nexport const isRoomLocked = (state: RootState): boolean =>\n\t!state.room.access.secret;\n","export type MessageType = \"error\" | \"info\" | \"success\";\n\nexport type Message = {\n\tclosable: boolean;\n\textra?: () => React.ReactNode;\n\tid: number;\n\tstamp: number;\n\ttag?: string;\n\ttext?: string;\n\ttimer?: NodeJS.Timeout;\n\ttype: MessageType;\n\tweight: number;\n};\n\nexport const extractErrorMessage = (err: any) =>\n\terr.response && err.response.data && err.response.data.message\n\t\t? err.response.data.message\n\t\t: err.message;\n","import { Reducer } from \"redux\";\nimport { createAction } from \"../actions\";\nimport { ConnectUserModalProps } from \"../components/Users/ConnectUserModal\";\nimport { CreateRoomModalProps } from \"../components/Room/CreateRoomModal\";\nimport { CreateUserModalProps } from \"../components/Users/CreateUserModal\";\nimport { ConfirmModalProps } from \"../components/Modals/ConfirmModal\";\nimport { UnlockRoomModalProps } from \"../components/Room/UnlockRoomModal\";\nimport { SeaBattleGameOverModalProps } from \"../components/SeaBattle/GameOverModal\";\n\n// ------------------------------------------------------------------\n\nexport type ModalPrereqT<T extends string, P> = {\n\ttype: T;\n\tprops: P;\n};\n\nexport type ModalPrereq =\n\t| ModalPrereqT<\"General/Confirm\", ConfirmModalProps>\n\t| ModalPrereqT<\"General/Help\", null>\n\t| ModalPrereqT<\"Room/Create\", CreateRoomModalProps>\n\t| ModalPrereqT<\"Room/Join\", null>\n\t| ModalPrereqT<\"Room/Search\", null>\n\t| ModalPrereqT<\"Room/Unlock\", UnlockRoomModalProps>\n\t| ModalPrereqT<\"SeaBattle/GameOver\", SeaBattleGameOverModalProps>\n\t| ModalPrereqT<\"SeaBattle/Help\", null>\n\t| ModalPrereqT<\"User/Connect\", ConnectUserModalProps>\n\t| ModalPrereqT<\"User/Create\", CreateUserModalProps>;\n\ntype PropType<TObj, TProp extends keyof TObj> = TObj[TProp];\n\ntype Filter<T, U> = T extends U ? T : never;\n\nexport type ModalType = PropType<ModalPrereq, \"type\">;\n\nexport type ModalProps<TYPE> = Filter<ModalPrereq, { type: TYPE }>[\"props\"];\n\n// ------------------------------------------------------------------\n\ntype ModalsAction =\n\t| ReturnType<typeof closeModal>\n\t| ReturnType<typeof openModal>\n\t| ReturnType<typeof popModal>\n\t| ReturnType<typeof pushModal>;\n\n// ------------------------------------------------------------------\n\nexport const openModal = (prereq: ModalPrereq) =>\n\tcreateAction(\"modals/OPEN\", prereq);\n\nexport const closeModal = () => createAction(\"modals/CLOSE\");\n\n// ------------------------------------------------------------------\n\nexport const pushModal = (prereq: ModalPrereq) =>\n\tcreateAction(\"modals/PUSH\", prereq);\n\nexport const popModal = () => createAction(\"modals/POP\");\n\n// ------------------------------------------------------------------\n\nexport type ModalsState = {\n\tstack: ModalPrereq[];\n};\n\n// ------------------------------------------------------------------\n\nexport const initialState: ModalsState = {\n\tstack: []\n};\n\n// ------------------------------------------------------------------\n\nexport const modalsReducer: Reducer<ModalsState, ModalsAction> = (\n\tstate = initialState,\n\taction\n): ModalsState => {\n\tswitch (action.type) {\n\t\tcase \"modals/OPEN\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tstack: [action.payload]\n\t\t\t};\n\t\tcase \"modals/CLOSE\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tstack: []\n\t\t\t};\n\t\tcase \"modals/PUSH\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tstack: [...state.stack, action.payload]\n\t\t\t};\n\t\tcase \"modals/POP\":\n\t\t\tconst copy = [...state.stack];\n\t\t\tcopy.pop();\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tstack: copy\n\t\t\t};\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import { AnyAction } from \"redux\";\nimport { ThunkAction, ThunkDispatch } from \"redux-thunk\";\n//\nimport { Player } from \"../utils/player\";\nimport { RootState } from \"../reducers\";\nimport { displayError } from \"./messages\";\nimport { extractErrorMessage } from \"../utils/messages\";\nimport { openModal } from \"../reducers/modals\";\n\n// ------------------------------------------------------------------\n\nexport type Action<T extends string> = {\n\ttype: T;\n};\n\nexport type ActionWithPayload<T extends string, P> = {\n\ttype: T;\n\tpayload: P;\n};\n\nexport type Extended = {\n\tplayer: Player;\n};\n\nexport type Dispatch = ThunkDispatch<RootState, Extended, AnyAction>;\n\nexport type AsyncAction = ThunkAction<void, RootState, Extended, AnyAction>;\n\nexport function createAction<T extends string>(type: T): Action<T>;\n\nexport function createAction<T extends string, P>(\n\ttype: T,\n\tpayload: P\n): ActionWithPayload<T, P>;\n\nexport function createAction<T extends string, P>(type: T, payload?: P) {\n\treturn payload === void 0 ? { type } : { type, payload };\n}\n\nexport type ActionOptions = { onFailure?: () => void; onSuccess?: () => void };\n\n// ------------------------------------------------------------------\n\nexport type TrySomethingStatus =\n\t| true\n\t| false\n\t| \"connect-and-retry\"\n\t| \"unlock-and-retry\";\n\nexport type TrySomethingOptions = {\n\tonAction: () => Promise<TrySomethingStatus>;\n\tonFailure?: () => void;\n\tonSuccess?: () => void;\n};\n\nexport const trySomething = (\n\toptions: TrySomethingOptions\n): AsyncAction => async dispatch => {\n\tlet res: TrySomethingStatus = false;\n\ttry {\n\t\tres = await options.onAction();\n\t\tif (res === \"unlock-and-retry\") {\n\t\t\tdispatch(\n\t\t\t\topenModal({\n\t\t\t\t\ttype: \"Room/Unlock\",\n\t\t\t\t\tprops: {\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tonFailure: options.onFailure,\n\t\t\t\t\t\t\tonSuccess: () => dispatch(trySomething(options))\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn; // Delegated to UnlockRoom\n\t\t}\n\t\tif (res === \"connect-and-retry\") {\n\t\t\tdispatch(\n\t\t\t\topenModal({\n\t\t\t\t\ttype: \"User/Create\",\n\t\t\t\t\tprops: {\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tonFailure: options.onFailure,\n\t\t\t\t\t\t\tonSuccess: () => dispatch(trySomething(options))\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t);\n\t\t\treturn; // Delegated to CreateUser\n\t\t}\n\t} catch (err) {\n\t\tdispatch(displayError(extractErrorMessage(err)));\n\t}\n\tif (!res) {\n\t\tif (options.onFailure) {\n\t\t\toptions.onFailure();\n\t\t\treturn;\n\t\t}\n\t}\n\tif (options.onSuccess) {\n\t\toptions.onSuccess();\n\t}\n};\n","import { Reducer } from \"redux\";\nimport { Message } from \"../utils/messages\";\nimport { createAction } from \"../actions\";\n\n// ------------------------------------------------------------------\n\ntype MessagesAction =\n\t| ReturnType<typeof addMessage>\n\t| ReturnType<typeof clearMessages>\n\t| ReturnType<typeof removeMessage>;\n\nexport const addMessage = (\n\tid: number,\n\tmessage: Message,\n\ttimer?: NodeJS.Timeout\n) => createAction(\"message/ADD\", { timer, id, message });\nexport const removeMessage = (id: number) =>\n\tcreateAction(\"message/REMOVE\", { id });\nexport const clearMessages = (tag?: string) =>\n\tcreateAction(\"message/RESET\", { tag });\n\n// ------------------------------------------------------------------\n\nexport type State = { [id: string]: Message };\n\nexport const INITIAL_STATE: State = {};\n\n// ------------------------------------------------------------------\n\nexport const messagesReducer: Reducer<State, MessagesAction> = (\n\tstate = INITIAL_STATE,\n\taction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"message/ADD\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\t[action.payload.id]: {\n\t\t\t\t\ttimer: action.payload.timer,\n\t\t\t\t\t...action.payload.message\n\t\t\t\t}\n\t\t\t};\n\t\tcase \"message/REMOVE\": {\n\t\t\tconst copy = { ...state };\n\t\t\tdelete copy[action.payload.id];\n\t\t\treturn copy;\n\t\t}\n\t\tcase \"message/RESET\": {\n\t\t\tif (!action.payload.tag) {\n\t\t\t\treturn INITIAL_STATE;\n\t\t\t}\n\t\t\tconst copy = { ...state };\n\t\t\tObject.entries(state).forEach(([id, message]) => {\n\t\t\t\tif (message.tag === action.payload.tag) {\n\t\t\t\t\tdelete copy[id];\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn copy;\n\t\t}\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import { AsyncAction } from \".\";\nimport { MessageType } from \"../utils/messages\";\nimport { addMessage, removeMessage } from \"../reducers/messages\";\n\n// ------------------------------------------------------------------\n\nlet MESSAGE_ID_GENERATOR: number = 0;\n\ntype MessageCreationData = {\n\tautoclear?: boolean;\n\tclosable?: boolean;\n\tduration?: number;\n\textra?: () => React.ReactNode;\n\ttag?: string;\n\ttext?: string;\n\tweight?: number;\n};\n\nexport const displayMessage = (\n\ttype: MessageType,\n\t{\n\t\tautoclear = true,\n\t\tclosable = true,\n\t\tduration = 3000,\n\t\textra,\n\t\ttag,\n\t\ttext,\n\t\tweight = 0\n\t}: MessageCreationData\n): AsyncAction => (dispatch, getState) => {\n\tconst { messages } = getState();\n\n\tconst oldEntry = Object.entries(messages).find(\n\t\t([_, message]) => message.tag === tag && message.text === text\n\t);\n\tlet id = 0;\n\tif (oldEntry) {\n\t\tconst [oldID, oldMessage] = oldEntry;\n\t\tid = Number(oldID); // Reuse message id and renqueue\n\t\tif (oldMessage.timer) {\n\t\t\tclearTimeout(oldMessage.timer);\n\t\t}\n\t} else {\n\t\tid = MESSAGE_ID_GENERATOR++;\n\t}\n\n\tdispatch(\n\t\taddMessage(\n\t\t\tid,\n\t\t\t{\n\t\t\t\tclosable,\n\t\t\t\textra,\n\t\t\t\tid,\n\t\t\t\tstamp: new Date().getTime(),\n\t\t\t\ttag,\n\t\t\t\ttext,\n\t\t\t\ttype,\n\t\t\t\tweight\n\t\t\t},\n\t\t\tautoclear\n\t\t\t\t? setTimeout(() => dispatch(removeMessage(id)), duration)\n\t\t\t\t: void 0\n\t\t)\n\t);\n};\n\n// ------------------------------------------------------------------\n\nexport const displayError = (text: string, data?: MessageCreationData) =>\n\tdisplayMessage(\"error\", {\n\t\ttext,\n\t\t...data\n\t});\n\nexport const displayInfo = (text: string, data?: MessageCreationData) =>\n\tdisplayMessage(\"info\", {\n\t\ttext,\n\t\t...data\n\t});\n\nexport const displaySuccess = (text: string, data?: MessageCreationData) =>\n\tdisplayMessage(\"success\", {\n\t\ttext,\n\t\t...data\n\t});\n","import { AsyncAction } from \".\";\n\n// ------------------------------------------------------------------\n\nexport const confirmModal = (\n\tquestion: string,\n\tonConfirmed: () => void,\n\tonCanceled?: () => void\n): AsyncAction => () => {\n\t// TODO: open custom ConfirmModal instead of system popup\n\tif (window.confirm(question)) {\n\t\tonConfirmed();\n\t\treturn;\n\t}\n\tif (onCanceled) {\n\t\tonCanceled();\n\t}\n};\n","import { RootState } from \"../reducers\";\nimport { Track } from \"../utils/medias\";\n\n// ------------------------------------------------------------------\n\nexport const selectTracks = (state: RootState): Array<Track | null> => {\n\tconst res: Array<Track | null> = [];\n\tconst {\n\t\tmedias: { medias },\n\t\troom: { tracks }\n\t} = state;\n\tfor (const access of tracks) {\n\t\tconst track = medias[access.provider][access.type][access.id];\n\t\tif (!!track) {\n\t\t\tres.push(track);\n\t\t} else {\n\t\t\tres.push(null); // Stiil loading or cannot be loaded or to reload later because of rate limit\n\t\t}\n\t}\n\treturn res;\n};\n\nexport const selectTracksCount = (state: RootState) => state.room.tracks.length;\n","import React, { FC, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\nimport { useHistory } from \"react-router-dom\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { copyToClipboard } from \"../../utils/clipboard\";\nimport { Dispatch } from \"../../actions\";\nimport { RootState } from \"../../reducers\";\nimport { isRoomLoaded, selectRoomName } from \"../../selectors/room\";\nimport { displaySuccess } from \"../../actions/messages\";\nimport { confirmModal } from \"../../actions/modals\";\nimport { selectTracksCount } from \"../../selectors/medias\";\nimport { Icon } from \"../Common/Icon\";\nimport \"./Head.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Head: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst fetching = useSelector<RootState, boolean>(\n\t\tstate => state.room.fetching\n\t);\n\tconst { t } = useTranslation();\n\tconst history = useHistory();\n\tconst name = useSelector<RootState, string>(selectRoomName);\n\tconst loaded = useSelector<RootState, boolean>(isRoomLoaded);\n\tconst mediasCount = useSelector<RootState, number>(\n\t\tstate => state.room.medias.length\n\t);\n\tconst tracksCount = useSelector<RootState, number>(selectTracksCount);\n\n\tconst onCopy = useCallback(async () => {\n\t\tawait copyToClipboard(document.location.href.split(\"?\")[0]);\n\t\tdispatch(displaySuccess(\"rooms.link_copied_to_clipboard\"));\n\t}, [dispatch]);\n\n\tconst onExit = useCallback(() => {\n\t\tdispatch(\n\t\t\tconfirmModal(t(\"rooms.confirm_exit\"), () => {\n\t\t\t\thistory.push(\"/\");\n\t\t\t})\n\t\t);\n\t}, [t, dispatch, history]);\n\n\treturn (\n\t\t<div className=\"Head\">\n\t\t\t<div className=\"HeadInner\">\n\t\t\t\t<div className=\"RoomLink\">\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"link\"\n\t\t\t\t\t\tonClick={onCopy}\n\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\ttitle={t(\"rooms.copy_link\")}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"RoomMeta\">\n\t\t\t\t\t{fetching ? (\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\tclassName=\"rotating\"\n\t\t\t\t\t\t\ticon=\"refresh\"\n\t\t\t\t\t\t\ttitle={t(\"loading\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t) : loaded ? (\n\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclassName=\"RoomName\"\n\t\t\t\t\t\t\t\ttitle={`${t(\"rooms.media_count\", {\n\t\t\t\t\t\t\t\t\tcount: mediasCount\n\t\t\t\t\t\t\t\t})} / ${t(\"rooms.track_count\", {\n\t\t\t\t\t\t\t\t\tcount: tracksCount\n\t\t\t\t\t\t\t\t})}`}>\n\t\t\t\t\t\t\t\t{name}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</>\n\t\t\t\t\t) : null}\n\t\t\t\t</div>\n\t\t\t\t<div className=\"RoomExit\">\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tonClick={onExit}\n\t\t\t\t\t\ticon=\"sign-out\"\n\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\ttitle={t(\"rooms.exit\")}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import React, { FC } from \"react\";\nimport { Icon, IconSize } from \"./Icon\";\n\n// ------------------------------------------------------------------\n\nexport const LoadingIcon: FC<{ size?: IconSize }> = React.memo(({ size }) => (\n\t<Icon\n\t\tclassName=\"rotating\"\n\t\ticon=\"circle-o-notch\"\n\t\tsize={size}\n\t\ttitle=\"Loading\"\n\t/>\n));\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport classNames from \"classnames\";\n//\nimport { Icon } from \"../Common/Icon\";\nimport \"./Cover.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Cover: FC<{\n\timage: string;\n\tonPlay?: () => void;\n\tonStop?: () => void;\n\tplayable: boolean;\n\tplaying: boolean;\n}> = React.memo(({ playable, playing, image, onPlay, onStop }) => {\n\tconst { t } = useTranslation();\n\tif (playable) {\n\t\treturn (\n\t\t\t<div\n\t\t\t\tclassName={classNames(\"Cover\", { playable, playing })}\n\t\t\t\tstyle={image ? { backgroundImage: `url('${image}')` } : {}}\n\t\t\t\tonClick={!playing ? onPlay : onStop}>\n\t\t\t\t{!playing ? (\n\t\t\t\t\t<Icon icon=\"play\" size=\"S\" title={t(\"player.play\")} />\n\t\t\t\t) : (\n\t\t\t\t\t<Icon icon=\"pause\" size=\"S\" title={t(\"player.stop\")} />\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t} else {\n\t\treturn (\n\t\t\t<div\n\t\t\t\tclassName={classNames(\"Cover\", { playing })}\n\t\t\t\tstyle={image ? { backgroundImage: `url('${image}')` } : {}}>\n\t\t\t\t{playing ? (\n\t\t\t\t\t<Icon icon=\"music\" size=\"S\" title={t(\"player.playing\")} />\n\t\t\t\t) : null}\n\t\t\t</div>\n\t\t);\n\t}\n});\n","import React, { FC, ReactNode } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { Cover } from \"./Cover\";\nimport { LoadingIcon } from \"../Common/LoadingIcon\";\nimport { Media as MediaData } from \"../../utils/medias\";\nimport \"./Medias.scss\";\n\n// ------------------------------------------------------------------\n\nexport const renderMediaInToaster = (media: MediaData): React.ReactNode => (\n\t<Media media={media} playable={false} playing={true} />\n);\n\n// ------------------------------------------------------------------\n\nexport const Media: FC<{\n\tactions?: ReactNode;\n\tmedia: MediaData | null;\n\tplayable: boolean;\n\tplaying: boolean;\n\tonPlay?: () => void;\n\tonStop?: () => void;\n}> = React.memo(({ actions, media, playable, playing, onPlay, onStop }) => {\n\tconst { t } = useTranslation();\n\tif (!media) {\n\t\treturn (\n\t\t\t<div className=\"Media\">\n\t\t\t\t<Cover\n\t\t\t\t\tplayable={playable}\n\t\t\t\t\tplaying={playing}\n\t\t\t\t\timage={\"\"}\n\t\t\t\t\tonPlay={onPlay}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t\t<div className=\"Metas\">\n\t\t\t\t\t<LoadingIcon size=\"M\" />\n\t\t\t\t</div>\n\t\t\t\t{actions ? <div className=\"Actions\">{actions}</div> : null}\n\t\t\t</div>\n\t\t);\n\t}\n\tif (media.type === \"album\") {\n\t\treturn (\n\t\t\t<div className=\"Media Album\">\n\t\t\t\t<Cover\n\t\t\t\t\tplayable={playable}\n\t\t\t\t\tplaying={playing}\n\t\t\t\t\timage={media.picture_small}\n\t\t\t\t\tonPlay={onPlay}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t\t<div className=\"Metas\">\n\t\t\t\t\t<div className=\"Meta AlbumTitle\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{media.name}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"Meta AlbumArtist\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.artist.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{t(\"medias.by\", { artist: media.artist.name })}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{actions ? <div className=\"Actions\">{actions}</div> : null}\n\t\t\t</div>\n\t\t);\n\t}\n\tif (media.type === \"playlist\") {\n\t\treturn (\n\t\t\t<div className=\"Media Playlist\">\n\t\t\t\t<Cover\n\t\t\t\t\tplayable={playable}\n\t\t\t\t\tplaying={playing}\n\t\t\t\t\timage={media.picture_small}\n\t\t\t\t\tonPlay={onPlay}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t\t<div className=\"Metas\">\n\t\t\t\t\t<div className=\"Meta PlaylistTitle\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{media.name}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"Meta PlaylistCreator\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.user.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{t(\"medias.by\", { artist: media.user.name })}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{actions ? <div className=\"Actions\">{actions}</div> : null}\n\t\t\t</div>\n\t\t);\n\t}\n\tif (media.type === \"track\") {\n\t\treturn (\n\t\t\t<div className=\"Media Track\">\n\t\t\t\t<Cover\n\t\t\t\t\tplayable={playable && !!media.preview}\n\t\t\t\t\tplaying={playing}\n\t\t\t\t\timage={media.album.picture_small}\n\t\t\t\t\tonPlay={onPlay}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t\t<div className=\"Metas\">\n\t\t\t\t\t<div className=\"Meta TrackTitle\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{media.name}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"Meta TrackArtist\">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\thref={media.artist.link}\n\t\t\t\t\t\t\ttarget=\"_blank\"\n\t\t\t\t\t\t\trel=\"noopener noreferrer\">\n\t\t\t\t\t\t\t{t(\"medias.by\", { artist: media.artist.name })}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t{actions ? <div className=\"Actions\">{actions}</div> : null}\n\t\t\t</div>\n\t\t);\n\t}\n\treturn null;\n});\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { Media } from \"./Medias\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { Track } from \"../../utils/medias\";\n\n// ------------------------------------------------------------------\n\nexport const QueueItem: FC<{\n\tlocked: boolean;\n\ttrack: Track | null; // if null : stiil loading or cannot be loaded or to reload later because of rate limit\n\tplaying: boolean;\n\tonPlay: () => void;\n\tonRemove: () => void;\n\tonStop: () => void;\n}> = React.memo(({ locked, track, playing, onPlay, onRemove, onStop }) => {\n\tconst { t } = useTranslation();\n\treturn (\n\t\t<div className=\"QueueItem\">\n\t\t\t<Media\n\t\t\t\tmedia={track}\n\t\t\t\tplayable={!!track && !locked}\n\t\t\t\tplaying={playing}\n\t\t\t\tonPlay={onPlay}\n\t\t\t\tonStop={onStop}\n\t\t\t\tactions={\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={locked}\n\t\t\t\t\t\ttitle={t(\"medias.remove\")}\n\t\t\t\t\t\ticon=\"trash\"\n\t\t\t\t\t\tonClick={onRemove}\n\t\t\t\t\t/>\n\t\t\t\t}\n\t\t\t/>\n\t\t</div>\n\t);\n});\n","import React, { memo } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { LoadingIcon } from \"../Common/LoadingIcon\";\nimport { QueueItem } from \"./QueueItem\";\nimport { Track } from \"../../utils/medias\";\n\n// ------------------------------------------------------------------\n\nexport const QueueList = memo(\n\t({\n\t\tlocked,\n\t\ttracks,\n\t\tplaying,\n\t\tplayingIndex,\n\t\tonPlay,\n\t\tonRemove,\n\t\tonStop\n\t}: {\n\t\tlocked: boolean;\n\t\ttracks: Array<Track | null>;\n\t\tplaying: boolean;\n\t\tplayingIndex: number;\n\t\tonPlay: (index: number) => void;\n\t\tonRemove: (index: number) => void;\n\t\tonStop: () => void;\n\t}) => (\n\t\t<>\n\t\t\t{tracks.map((track, index) => (\n\t\t\t\t<QueueItem\n\t\t\t\t\tkey={index}\n\t\t\t\t\tlocked={locked}\n\t\t\t\t\tplaying={playing && playingIndex === index}\n\t\t\t\t\ttrack={track}\n\t\t\t\t\tonPlay={() => onPlay(index)}\n\t\t\t\t\tonRemove={() => onRemove(index)}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</>\n\t)\n);\n\n// ------------------------------------------------------------------\n\nexport const EmptyQueueList = React.memo(\n\t({\n\t\tloaded,\n\t\tlocked,\n\t\tonSearch\n\t}: {\n\t\tloaded: boolean;\n\t\tlocked: boolean;\n\t\tonSearch: () => void;\n\t}) => {\n\t\tconst { t } = useTranslation();\n\t\treturn (\n\t\t\t<div className=\"QueueEmpty\">\n\t\t\t\t{loaded ? (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ttitle=\"...\"\n\t\t\t\t\t\t\ticon=\"shower\"\n\t\t\t\t\t\t\tonClick={onSearch}\n\t\t\t\t\t\t\tsize=\"L\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<span onClick={onSearch}>\n\t\t\t\t\t\t\t{t(locked ? \"rooms.empty_for_now\" : \"rooms.empty\")}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</>\n\t\t\t\t) : (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<LoadingIcon size=\"L\" />\n\t\t\t\t\t\t<span>{t(\"rooms.loading\")}</span>\n\t\t\t\t\t</>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t);\n\t}\n);\n","export const sleep = (delay: number) =>\n\tnew Promise(resolve => setTimeout(resolve, delay));\n\nexport const augmentedArrayIndexAccess = <T>(arr: T[], idx: number): T =>\n\tarr[(idx < 0 ? (idx % arr.length) + arr.length : idx) % arr.length];\n\nexport const chunkArray = <T>(arr: T[], chunkSize: number) => {\n\tconst length = arr.length;\n\tconst res: T[][] = [];\n\tfor (let index = 0; index < length; index += chunkSize) {\n\t\tres.push(arr.slice(index, index + chunkSize));\n\t}\n\treturn res;\n};\n","import { decode, encode } from \"../../encoder\";\nimport { augmentedArrayIndexAccess } from \"../../\";\n\n// ------------------------------------------------------------------\n\nexport const GRID_CELL_COUNT = 10;\nexport const GRID_CELL_UNIT_SIZE = 40;\nexport const MAX_PLAYER_COUNT = 3;\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleGridCell =\n\t| {\n\t\t\tboatIndex: number;\n\t\t\tboatLocalIndex: number;\n\t\t\ttype: \"boat\";\n\t  }\n\t| {\n\t\t\tweaponType: SeaBattleWeaponType;\n\t\t\ttype: \"weapon\";\n\t  }\n\t| null;\n\nexport type SeaBattleGrid = SeaBattleGridCell[][];\n\n// ------------------------------------------------------------------\n\nexport type SeaBattlePosition = { x: number; y: number };\n\nexport type SeaBattleAssetVisibility = \"hidden\" | \"visible\";\n\nexport type SeaBattleCellType =\n\t| \"cell-crossed\"\n\t| \"cell-selected\"\n\t| \"cell-selection\";\n\nexport type SeaBattleAssetType =\n\t| SeaBattleBoatType\n\t| SeaBattleCellType\n\t| SeaBattleHitType\n\t| SeaBattleWeaponType;\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleDirection = \"E\" | \"S\" | \"W\" | \"N\";\n\nexport const SeaBattleDirections: SeaBattleDirection[] = [\"E\", \"S\", \"W\", \"N\"]; // order is important for AngleToDirection\n\nexport const AngleToDirection = (angle: number): SeaBattleDirection =>\n\taugmentedArrayIndexAccess(SeaBattleDirections, angle);\n\nexport const DirectionToAngle: {\n\t[type in SeaBattleDirection]: number;\n} = {\n\tE: 0,\n\tS: 1,\n\tW: 2,\n\tN: 3\n};\n\nexport type SeaBattleRotationType = \"rotate_left\" | \"rotate_right\";\n\nexport type SeaBattleTranslationType = \"move_forward\" | \"move_backward\";\n\nexport type SeaBattleMovementType =\n\t| SeaBattleTranslationType\n\t| SeaBattleRotationType;\n\nexport type SeaBattleBoatStatus = \"ok\" | \"ko\";\n\nexport type SeaBattleBoatType = \"boat1\" | \"boat2\" | \"boat3\";\n\nexport const SeaBattleBoatTypes: SeaBattleBoatType[] = [\n\t\"boat1\",\n\t\"boat2\",\n\t\"boat3\"\n];\n\nexport type SeaBattleBoatData = {\n\tangle: number;\n\thits: SeaBattleHitData[];\n\tposition: SeaBattlePosition;\n\tstatus: SeaBattleBoatStatus;\n\ttype: SeaBattleBoatType;\n};\n\nexport const BoatsOffsetMappings: {\n\t[type in SeaBattleBoatType]: SeaBattlePosition;\n} = {\n\tboat1: { x: 6, y: 6 },\n\tboat2: { x: 6, y: 6 },\n\tboat3: { x: 6, y: 6 }\n};\n\nexport type SeaBattleFleetSet = {\n\t[type in SeaBattleBoatType]: number;\n};\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleCellData = {\n\tposition: SeaBattlePosition;\n\ttype: SeaBattleCellType;\n\tvisibility?: SeaBattleAssetVisibility;\n};\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleHitType = \"hitted\" | \"missed\";\n\nexport type SeaBattleHitData = {\n\tposition: SeaBattlePosition;\n\ttype: SeaBattleHitType;\n};\n\nexport const HitsOffsetInBoatMappings: {\n\t[type in SeaBattleHitType]: SeaBattlePosition;\n} = {\n\thitted: { x: 4, y: 4 },\n\tmissed: { x: 4, y: 4 }\n};\n\nexport const HitsOffsetInCellMappings: {\n\t[type in SeaBattleHitType]: SeaBattlePosition;\n} = {\n\thitted: { x: 10, y: 10 },\n\tmissed: { x: 10, y: 10 }\n};\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleWeaponType = \"bullet1\" | \"bullet2\" | \"bullet3\" | \"mine\";\n\nexport const SeaBattleWeaponTypes: SeaBattleWeaponType[] = [\n\t\"bullet1\",\n\t\"bullet2\",\n\t\"bullet3\",\n\t\"mine\"\n];\n\nexport type SeaBattleWeaponData = {\n\topponentId: string;\n\tposition: SeaBattlePosition;\n\ttype: SeaBattleWeaponType;\n};\n\nexport const SeaBattleWeaponsOffsetMappings: {\n\t[type in SeaBattleWeaponType]: SeaBattlePosition;\n} = {\n\tbullet1: { x: 12, y: 16 },\n\tbullet2: { x: 12, y: 16 },\n\tbullet3: { x: 12, y: 16 },\n\tmine: { x: 12, y: 12 }\n};\n\nexport type SeaBattleWeaponsSet = {\n\t[type in SeaBattleWeaponType]: number;\n};\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleMapStatus = \"ok\" | \"ko\";\n\nexport type SeaBattleMapData = {\n\tfleet: SeaBattleBoatData[];\n\thits: SeaBattleHitData[];\n\topponentsWeapons: SeaBattleWeaponData[]; // Weapons placed by opponents\n\tstatus: SeaBattleMapStatus;\n\tuserId: string;\n\tweapons: SeaBattleWeaponsSet;\n};\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleData = {\n\tcurrentMapIndex: number;\n\tmaps: SeaBattleMapData[];\n};\n\n// ------------------------------------------------------------------\n\nexport const extractOpponentMaps = (maps: SeaBattleMapData[], userId: string) =>\n\tObject.values(maps).filter(other => other.userId !== userId);\n\n// ------------------------------------------------------------------\n\nexport const extractBattleInfo = ({\n\textra,\n\tuserId,\n\tboatIndex\n}: {\n\textra: string;\n\tuserId: string;\n\tboatIndex: number;\n}): {\n\tboat?: SeaBattleBoatData;\n\tcurrentMapIndex: number;\n\topponentMaps?: SeaBattleMapData[];\n\tplayerMap?: SeaBattleMapData;\n\tplayerMapIndex: number;\n} => {\n\tlet boat: SeaBattleBoatData | undefined = void 0;\n\tlet currentMapIndex = -1;\n\tlet opponentMaps: SeaBattleMapData[] | undefined = void 0;\n\tlet playerMap: SeaBattleMapData | undefined = void 0;\n\tlet playerMapIndex = -1;\n\tif (extra) {\n\t\tconst battle = decodeBattle(extra);\n\t\tif (userId) {\n\t\t\tcurrentMapIndex = battle.currentMapIndex;\n\t\t\tplayerMapIndex = battle.maps.findIndex(\n\t\t\t\tother => other.userId === userId\n\t\t\t);\n\t\t\tif (playerMapIndex >= 0) {\n\t\t\t\tplayerMap = battle.maps[playerMapIndex];\n\t\t\t\tif (boatIndex >= 0 && boatIndex < playerMap.fleet.length) {\n\t\t\t\t\tboat = playerMap.fleet[boatIndex];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\topponentMaps = extractOpponentMaps(battle.maps, userId);\n\t}\n\treturn {\n\t\tboat,\n\t\tcurrentMapIndex,\n\t\topponentMaps,\n\t\tplayerMap,\n\t\tplayerMapIndex\n\t};\n};\n\n// ------------------------------------------------------------------\n\nexport const checkUserHasBatton = (battle: SeaBattleData, userId: string) =>\n\tbattle.maps[battle.currentMapIndex]?.userId === userId;\n\nexport const passBatonToNextPlayer = (battle: SeaBattleData) => {\n\tbattle.currentMapIndex = (battle.currentMapIndex + 1) % battle.maps.length;\n};\n\n// ------------------------------------------------------------------\n\nexport const decodeBattle = (data: string): SeaBattleData =>\n\tdecode<SeaBattleData>(data);\n\nexport const encodeBattle = (data: SeaBattleData): string =>\n\tencode<SeaBattleData>(data);\n","import {\n\tSeaBattlePosition,\n\tSeaBattleMovementType,\n\tSeaBattleBoatType,\n\tSeaBattleDirection,\n\tSeaBattleTranslationType\n} from \".\";\nimport { KEY_RIGHT, KEY_LEFT, KEY_DOWN, KEY_UP } from \"../../keyboards\";\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleBoatRotationTransformationMappings: {\n\t[type in SeaBattleBoatType]: {\n\t\t[direction in SeaBattleDirection]: SeaBattlePosition;\n\t};\n} = {\n\tboat1: {\n\t\tN: { x: 0, y: 0 },\n\t\tE: { x: 0, y: 0 },\n\t\tS: { x: 0, y: 0 },\n\t\tW: { x: 0, y: 0 }\n\t},\n\tboat2: {\n\t\tN: { x: 0, y: -1 },\n\t\tE: { x: 1, y: 0 },\n\t\tS: { x: 0, y: 1 },\n\t\tW: { x: -1, y: 0 }\n\t},\n\tboat3: {\n\t\tN: { x: 0, y: -2 },\n\t\tE: { x: 2, y: 0 },\n\t\tS: { x: 0, y: 2 },\n\t\tW: { x: -2, y: 0 }\n\t}\n};\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleKeyboardMoveMappings: {\n\t[direction in SeaBattleDirection]: { [key: string]: SeaBattleMovementType };\n} = {\n\tN: {\n\t\t[KEY_UP]: \"move_forward\",\n\t\t[KEY_DOWN]: \"move_backward\",\n\t\t[KEY_LEFT]: \"rotate_left\",\n\t\t[KEY_RIGHT]: \"rotate_right\"\n\t},\n\tE: {\n\t\t[KEY_UP]: \"rotate_left\",\n\t\t[KEY_DOWN]: \"rotate_right\",\n\t\t[KEY_LEFT]: \"move_backward\",\n\t\t[KEY_RIGHT]: \"move_forward\"\n\t},\n\tS: {\n\t\t[KEY_UP]: \"move_backward\",\n\t\t[KEY_DOWN]: \"move_forward\",\n\t\t[KEY_LEFT]: \"rotate_right\",\n\t\t[KEY_RIGHT]: \"rotate_left\"\n\t},\n\tW: {\n\t\t[KEY_UP]: \"rotate_right\",\n\t\t[KEY_DOWN]: \"rotate_left\",\n\t\t[KEY_LEFT]: \"move_forward\",\n\t\t[KEY_RIGHT]: \"move_backward\"\n\t}\n};\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleBoatTranslationMappings: {\n\t[direction in SeaBattleDirection]: {\n\t\t[translation in SeaBattleTranslationType]: SeaBattlePosition;\n\t};\n} = {\n\tN: {\n\t\tmove_forward: { x: 0, y: -1 },\n\t\tmove_backward: { x: 0, y: 1 }\n\t},\n\tE: {\n\t\tmove_forward: { x: 1, y: 0 },\n\t\tmove_backward: { x: -1, y: 0 }\n\t},\n\tS: {\n\t\tmove_forward: { x: 0, y: 1 },\n\t\tmove_backward: { x: 0, y: -1 }\n\t},\n\tW: {\n\t\tmove_forward: { x: -1, y: 0 },\n\t\tmove_backward: { x: 1, y: 0 }\n\t}\n};\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleBoatLengthMappings: {\n\t[type in SeaBattleBoatType]: number;\n} = {\n\tboat1: 1,\n\tboat2: 2,\n\tboat3: 3\n};\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleMovementIconMappings: {\n\t[direction in SeaBattleDirection]: {\n\t\t[translation in SeaBattleTranslationType]: string;\n\t};\n} = {\n\tN: {\n\t\tmove_forward: \"arrow-up\",\n\t\tmove_backward: \"arrow-down\"\n\t},\n\tE: {\n\t\tmove_forward: \"arrow-right\",\n\t\tmove_backward: \"arrow-left\"\n\t},\n\tS: {\n\t\tmove_forward: \"arrow-down\",\n\t\tmove_backward: \"arrow-up\"\n\t},\n\tW: {\n\t\tmove_forward: \"arrow-left\",\n\t\tmove_backward: \"arrow-right\"\n\t}\n};\n","import {\n\tDirectionToAngle,\n\tGRID_CELL_COUNT,\n\tSeaBattleBoatData,\n\tSeaBattleBoatType,\n\tSeaBattleBoatTypes,\n\tSeaBattleData,\n\tSeaBattleDirection,\n\tSeaBattleDirections,\n\tSeaBattleFleetSet,\n\tSeaBattleMapData,\n\tSeaBattlePosition,\n\tSeaBattleWeaponsSet\n} from \".\";\nimport { SeaBattleBoatLengthMappings } from \"./mappings\";\n\n// ------------------------------------------------------------------\n\nconst FLEET_CUMULATED_SIZE = 16;\n// for example 16 as a fleet cumulated size means:\n//     4 x boat1 + 3 x boat2 + 3 x boat3\n// or 10 x boat1 + 2 x boat3\n// or ...\n\n// ------------------------------------------------------------------\n\nexport const generateWeaponsSet = (): SeaBattleWeaponsSet => ({\n\t// Following counts are arbitrary choices (to validate or adjust ^_^) - TODO\n\tbullet1: 100,\n\tbullet2: 6,\n\tbullet3: 3,\n\tmine: 3\n});\n\n// ------------------------------------------------------------------\n\nexport const generateBattle = (userId: string): SeaBattleData => {\n\tconsole.debug(\"[SeaBattle] Genering battle...\");\n\tconst battle: SeaBattleData = {\n\t\tcurrentMapIndex: 0,\n\t\tmaps: []\n\t};\n\tgenerateFleet(battle, userId);\n\treturn battle;\n};\n\n// ------------------------------------------------------------------\n\nconst getCell = (grid: number[][], x: number, y: number): number => {\n\tif (x < 0 || x >= GRID_CELL_COUNT || y < 0 || y >= GRID_CELL_COUNT) {\n\t\treturn -1;\n\t}\n\treturn grid[y][x];\n};\n\nconst setCell = (grid: number[][], x: number, y: number) => {\n\tgrid[y][x] = 1;\n};\n\nexport const checkAvailable = (\n\tgrid: number[][],\n\tpos: SeaBattlePosition,\n\tdir: SeaBattleDirection,\n\tboatLength: number\n) => {\n\tswitch (dir) {\n\t\tcase \"N\":\n\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\tconst cell = getCell(grid, pos.x, pos.y - i);\n\t\t\t\tif (0 !== cell) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"E\":\n\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\tconst cell = getCell(grid, pos.x + i, pos.y);\n\t\t\t\tif (0 !== cell) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"S\":\n\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\tconst cell = getCell(grid, pos.x, pos.y + i);\n\t\t\t\tif (0 !== cell) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"W\":\n\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\tconst cell = getCell(grid, pos.x - i, pos.y);\n\t\t\t\tif (0 !== cell) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t}\n\treturn true;\n};\n\n// ------------------------------------------------------------------\n\nexport const generatePlace = (grid: number[][], boatLength: number) => {\n\twhile (true) {\n\t\tconst pos = {\n\t\t\tx: Math.floor(Math.random() * GRID_CELL_COUNT),\n\t\t\ty: Math.floor(Math.random() * GRID_CELL_COUNT)\n\t\t};\n\t\tconst dir =\n\t\t\tSeaBattleDirections[\n\t\t\t\tMath.floor(Math.random() * SeaBattleDirections.length)\n\t\t\t];\n\t\tif (checkAvailable(grid, pos, dir, boatLength)) {\n\t\t\tswitch (dir) {\n\t\t\t\tcase \"N\":\n\t\t\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\t\t\tsetCell(grid, pos.x, pos.y - i);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"E\":\n\t\t\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\t\t\tsetCell(grid, pos.x + i, pos.y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"S\":\n\t\t\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\t\t\tsetCell(grid, pos.x, pos.y + i);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"W\":\n\t\t\t\t\tfor (let i = 0; i < boatLength; ++i) {\n\t\t\t\t\t\tsetCell(grid, pos.x - i, pos.y);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tangle: DirectionToAngle[dir],\n\t\t\t\tposition: pos\n\t\t\t};\n\t\t}\n\t}\n};\n\n// ------------------------------------------------------------------\n\nconst getValidBoatTypes = (maxLength: number) =>\n\tSeaBattleBoatTypes.filter(\n\t\ttype => SeaBattleBoatLengthMappings[type] <= maxLength\n\t);\n\nexport const generateFleet = (battle: SeaBattleData, userId: string) => {\n\tconst oldMap = battle.maps.find(other => other.userId === userId);\n\tif (oldMap) {\n\t\treturn; // User already has a map in the battle\n\t}\n\tconsole.debug(\"[SeaBattle] Genering fleet...\", {\n\t\tuserId\n\t});\n\n\tconst grid: number[][] = Array<number>(GRID_CELL_COUNT)\n\t\t.fill(0)\n\t\t.map(_ => Array<number>(GRID_CELL_COUNT).fill(0));\n\n\t// Generate random fleet set based on specified cumulated size\n\tconst fleetSet: SeaBattleFleetSet = {\n\t\tboat1: 0,\n\t\tboat2: 0,\n\t\tboat3: 0\n\t};\n\tlet fleetCumulatedSize = FLEET_CUMULATED_SIZE;\n\twhile (fleetCumulatedSize > 0) {\n\t\tconst typeChoices = getValidBoatTypes(fleetCumulatedSize);\n\t\tconst typeChoice =\n\t\t\ttypeChoices[Math.floor(Math.random() * typeChoices.length)];\n\t\tfleetSet[typeChoice]++;\n\t\tfleetCumulatedSize -= SeaBattleBoatLengthMappings[typeChoice];\n\t}\n\n\t// Place boats\n\tconst fleet: SeaBattleBoatData[] = [];\n\tfor (const boatSetting of Object.entries(fleetSet).reverse()) {\n\t\tconst [rawType, count] = boatSetting;\n\t\tconst type = rawType as SeaBattleBoatType;\n\t\tconst boatLength = SeaBattleBoatLengthMappings[type];\n\t\tfor (let i = 0; i < count; ++i) {\n\t\t\tconst { angle, position } = generatePlace(grid, boatLength);\n\t\t\tconst boat: SeaBattleBoatData = {\n\t\t\t\thits: [],\n\t\t\t\ttype,\n\t\t\t\tangle,\n\t\t\t\tposition,\n\t\t\t\tstatus: \"ok\"\n\t\t\t};\n\t\t\tfleet.push(boat);\n\t\t}\n\t}\n\n\tconst newMap: SeaBattleMapData = {\n\t\tfleet,\n\t\thits: [\n\t\t\t/*\n\t\t\t\t{ position: { x: 0, y: 1 }, type: \"hitted\" },\n\t\t\t\t{ position: { x: 0, y: 2 }, type: \"hitted\" },\n\t\t\t\t{ position: { x: 0, y: 3 }, type: \"missed\" }\n\t\t\t\t*/\n\t\t],\n\t\topponentsWeapons: [\n\t\t\t/*\n\t\t\t\t{position: { x: 0, y: 5 }, opponentId: '', type:'mine'}\n\t\t\t\t*/\n\t\t],\n\t\tstatus: \"ok\",\n\t\tuserId,\n\t\tweapons: generateWeaponsSet()\n\t};\n\tbattle.maps.push(newMap);\n};\n","import { MediaAccess } from \"./medias\";\nimport { generateBattle } from \"./games/seabattle/generator\";\nimport { encodeBattle } from \"./games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport type PlayMode = \"default\" | \"shuffle\"; // TODO: Implement Shuffle mode\n\nexport type RoomType = \"blind\" | \"dj\" | \"seabattle\";\n\nexport const DEFAULT_PLAY_MODE: PlayMode = \"default\";\n\nexport const DEFAULT_ROOM_TYPE: RoomType = \"seabattle\";\n\nexport const RoomTypes = [\n\t// \"blind\",\n\t\"dj\",\n\t\"seabattle\"\n];\n\nexport type RoomInfo = {\n\tname: string;\n\ttype: RoomType;\n};\n\nexport type RoomAccess = {\n\tdbId: string;\n\troomId: string;\n\tsecret: string;\n};\n\nexport type RoomQueue = {\n\tmedias?: RoomQueueMedias;\n\tposition: number;\n\tplaying: boolean;\n\tplaymode: PlayMode;\n};\n\nexport type RoomQueueMedias = {\n\t[index: string]: MediaAccess;\n};\n\n// ------------------------------------------------------------------\n\nexport const createQueueMerging = (\n\taccesses1: MediaAccess[],\n\taccesses2: MediaAccess[]\n): RoomQueueMedias => {\n\tconst medias: RoomQueueMedias = {};\n\t[...accesses1, ...accesses2].forEach(({ id, provider, type }, index) => {\n\t\tmedias[index] = { id, provider, type };\n\t});\n\treturn medias;\n};\n\n// ------------------------------------------------------------------\n\nexport const createQueueRemoving = (\n\taccesses: MediaAccess[],\n\tindex: number,\n\tcount: number\n): RoomQueueMedias => {\n\tif (index < 0 || index >= accesses.length) {\n\t\tthrow new Error(\"Media index is out of range\");\n\t}\n\tconst medias: RoomQueueMedias = {};\n\tconst copy = [...accesses];\n\tcopy.splice(index, count);\n\tcopy.forEach(({ id, provider, type }, index) => {\n\t\tmedias[index] = { id, provider, type };\n\t});\n\treturn medias;\n};\n\n// ------------------------------------------------------------------\n\nexport const initializeRoom = ({\n\ttype,\n\tuserId\n}: {\n\ttype: RoomType;\n\tuserId: string;\n}): { extra: string; queue: RoomQueue } => {\n\tswitch (type) {\n\t\tcase \"blind\":\n\t\t\treturn {\n\t\t\t\textra: \"\",\n\t\t\t\tqueue: {\n\t\t\t\t\tmedias: {},\n\t\t\t\t\tplaying: false,\n\t\t\t\t\tplaymode: \"default\",\n\t\t\t\t\tposition: 0\n\t\t\t\t}\n\t\t\t};\n\t\tcase \"dj\":\n\t\t\treturn {\n\t\t\t\textra: \"\",\n\t\t\t\tqueue: {\n\t\t\t\t\tmedias: {},\n\t\t\t\t\tplaying: false,\n\t\t\t\t\tplaymode: \"default\",\n\t\t\t\t\tposition: 0\n\t\t\t\t}\n\t\t\t};\n\t\tcase \"seabattle\":\n\t\t\treturn {\n\t\t\t\textra: encodeBattle(generateBattle(userId)),\n\t\t\t\tqueue: {\n\t\t\t\t\tmedias: {\n\t\t\t\t\t\t0: {\n\t\t\t\t\t\t\tid: \"301013\", // Pirates Of The Caribbean OST\n\t\t\t\t\t\t\tprovider: \"deezer\",\n\t\t\t\t\t\t\ttype: \"album\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t1: {\n\t\t\t\t\t\t\tid: \"7358507\", // Stalingrad OST\n\t\t\t\t\t\t\tprovider: \"deezer\",\n\t\t\t\t\t\t\ttype: \"album\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t2: {\n\t\t\t\t\t\t\tid: \"558976\", // Master & Commander OST\n\t\t\t\t\t\t\tprovider: \"deezer\",\n\t\t\t\t\t\t\ttype: \"album\"\n\t\t\t\t\t\t},\n\t\t\t\t\t\t3: {\n\t\t\t\t\t\t\tid: \"87375582\", // Le chant du loup OST\n\t\t\t\t\t\t\tprovider: \"deezer\",\n\t\t\t\t\t\t\ttype: \"album\"\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tplaying: true,\n\t\t\t\t\tplaymode: \"shuffle\",\n\t\t\t\t\tposition: 0\n\t\t\t\t}\n\t\t\t};\n\t}\n};\n","const config = {\n\tdbIDs: (process.env.REACT_APP_DATABASE_IDS || \"\").split(\",\"),\n\tdbPrefix: process.env.REACT_APP_DATABASE_PREFIX || \"\"\n};\n\nexport const selectRoomDatabaseId = () =>\n\tconfig.dbIDs[Math.floor(Math.random() * config.dbIDs.length)];\n\nexport const selectUserDatabaseId = () => config.dbIDs[0];\n\n// console.debug('[Firebase] Config', config);\n\nexport default config;\n","import * as firebase from \"firebase/app\";\nimport \"firebase/database\";\n//\nimport firebaseConfig from \"../../config/firebase\";\n\n// ------------------------------------------------------------------\n\nconst APPS: {\n\t[id: string]: {\n\t\tapp: firebase.app.App;\n\t\tdatabase: firebase.database.Database;\n\t\trooms: firebase.database.Reference;\n\t\tusers: firebase.database.Reference;\n\t};\n} = {};\n\nexport const createOrGetApp = (dbId: string) => {\n\tlet res = APPS[dbId];\n\tif (!res) {\n\t\tconsole.debug(\"[Firebase] Creating app\", { dbId });\n\t\tconst databaseURL = `https://${firebaseConfig.dbPrefix}${dbId}.firebaseio.com`;\n\t\tconst app = firebase.initializeApp({ databaseURL }, dbId);\n\t\tconst database = firebase.database(app);\n\t\tAPPS[dbId] = res = {\n\t\t\tapp,\n\t\t\tdatabase,\n\t\t\trooms: database.ref(\"rooms\"),\n\t\t\tusers: database.ref(\"users\")\n\t\t};\n\t}\n\treturn res;\n};\n","import * as firebase from \"firebase/app\";\nimport \"firebase/database\";\n//\nimport { createOrGetApp } from \"./\";\nimport { RoomInfo, RoomQueue } from \"../rooms\";\n\n// ------------------------------------------------------------------\n\nexport const FirebaseRoom = ({\n\tdbId,\n\troomId,\n\tsecret\n}: {\n\tdbId: string;\n\troomId: string;\n\tsecret?: string;\n}) => {\n\tconst app = createOrGetApp(dbId);\n\tconst _room = app.rooms.child(roomId);\n\tconst _extra = _room.child(\"extra\");\n\tconst _info = _room.child(\"info\");\n\tconst _queue = _room.child(\"queue\");\n\tlet _secret = secret || \"\";\n\n\tconst isLocked = () => !_secret;\n\n\tconst setSecret = (newSecret: string) => {\n\t\tconsole.debug(\"[Firebase] Setting room secret\", {\n\t\t\toldSecret: _secret,\n\t\t\tnewSecret\n\t\t});\n\t\t_secret = newSecret;\n\t};\n\n\tconst wait = async (): Promise<{\n\t\textra: string;\n\t\tinfo: RoomInfo;\n\t\tqueue: RoomQueue;\n\t}> => {\n\t\ttry {\n\t\t\tconsole.debug(\"[Firebase] Waiting room...\");\n\t\t\tconst [extra, info, queue] = await Promise.all([\n\t\t\t\t_extra.once(\"value\"),\n\t\t\t\t_info.once(\"value\"),\n\t\t\t\t_queue.once(\"value\")\n\t\t\t]);\n\t\t\treturn {\n\t\t\t\textra: extra.val(),\n\t\t\t\tinfo: info.val(),\n\t\t\t\tqueue: queue.val()\n\t\t\t};\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"rooms.errors.invalid\");\n\t\t}\n\t};\n\n\tconst subscribeExtra = (cb: (extra: string) => void) => {\n\t\tconsole.debug(\"[Firebase] Subscribing room extra...\");\n\t\treturn _extra.on(\n\t\t\t\"value\",\n\t\t\t(snapshot: firebase.database.DataSnapshot) => {\n\t\t\t\tconst extra = snapshot.val() as string | null;\n\t\t\t\tif (!extra) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tcb(extra);\n\t\t\t}\n\t\t);\n\t};\n\n\tconst subscribeInfo = (cb: (info: RoomInfo) => void) => {\n\t\tconsole.debug(\"[Firebase] Subscribing room info...\");\n\t\treturn _info.on(\"value\", (snapshot: firebase.database.DataSnapshot) => {\n\t\t\tconst info = snapshot.val() as RoomInfo | null;\n\t\t\tif (!info) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcb(info);\n\t\t});\n\t};\n\n\tconst subscribeQueue = (cb: (info: RoomQueue) => void) => {\n\t\tconsole.debug(\"[Firebase] Subscribing room queue...\");\n\t\treturn _queue.on(\n\t\t\t\"value\",\n\t\t\t(snapshot: firebase.database.DataSnapshot) => {\n\t\t\t\tconst queue = snapshot.val() as RoomQueue | null;\n\t\t\t\tif (!queue) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tcb(queue);\n\t\t\t}\n\t\t);\n\t};\n\n\tconst unsubscribeExtra = (handler: any) => {\n\t\tconsole.debug(\"[Firebase] Unsubscribing room extra...\");\n\t\t_extra.off(\"value\", handler);\n\t};\n\n\tconst unsubscribeInfo = (handler: any) => {\n\t\tconsole.debug(\"[Firebase] Unsubscribing room info...\");\n\t\t_info.off(\"value\", handler);\n\t};\n\n\tconst unsubscribeQueue = (handler: any) => {\n\t\tconsole.debug(\"[Firebase] Unsubscribing room queue...\");\n\t\t_queue.off(\"value\", handler);\n\t};\n\n\tconst init = async ({\n\t\textra,\n\t\tinfo,\n\t\tqueue\n\t}: {\n\t\textra: string;\n\t\tinfo: RoomInfo;\n\t\tqueue: RoomQueue;\n\t}) => {\n\t\tconsole.debug(\"[Firebase] Initializing room...\", {\n\t\t\textra: !!extra,\n\t\t\tinfo,\n\t\t\tqueue\n\t\t});\n\t\tawait _room.update({\n\t\t\textra,\n\t\t\tinfo,\n\t\t\tqueue,\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t};\n\n\tconst updateExtra = async (extra: string) => {\n\t\tconsole.debug(\"[Firebase] Updating room extra...\");\n\t\tawait _room.update({\n\t\t\textra,\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t};\n\n\tconst updateInfo = async ({\n\t\tname,\n\t\ttype\n\t}: Pick<RoomInfo, \"name\" | \"type\">) => {\n\t\tconsole.debug(\"[Firebase] Updating room info...\", {\n\t\t\tname,\n\t\t\ttype\n\t\t});\n\t\tawait _room.update({\n\t\t\tinfo: {\n\t\t\t\tname,\n\t\t\t\ttype\n\t\t\t},\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t};\n\n\tconst updateQueue = async (queue: RoomQueue) => {\n\t\tconsole.debug(\"[Firebase] Updating room info...\", {\n\t\t\tqueue\n\t\t});\n\t\tawait _room.update({\n\t\t\tqueue,\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t};\n\n\treturn {\n\t\tdbId,\n\t\troomId,\n\t\tinit,\n\t\tisLocked,\n\t\tsetSecret,\n\t\twait,\n\t\tsubscribeExtra,\n\t\tsubscribeInfo,\n\t\tsubscribeQueue,\n\t\tunsubscribeExtra,\n\t\tunsubscribeInfo,\n\t\tunsubscribeQueue,\n\t\tupdateExtra,\n\t\tupdateInfo,\n\t\tupdateQueue\n\t};\n};\n","import * as jimp from \"jimp\";\n\n// ------------------------------------------------------------------\n\nexport const getImageMainColor = async (url: string) => {\n\tconst image = await jimp.read(url);\n\tconst pixel = await image.resize(1, 1).getPixelColor(0, 0);\n\tconst { r, g, b } = jimp.intToRGBA(pixel);\n\treturn { r, g, b };\n};\n","import { getImageMainColor } from \"./images\";\n\n// ------------------------------------------------------------------\n\nexport type Color = {\n\tr: number;\n\tg: number;\n\tb: number;\n};\n\nexport type CombinedColor = {\n\tbg: Color;\n\tfg: string;\n};\n\nconst CACHE: { [url: string]: CombinedColor } = {};\n\nconst DEFAULT_COLOR = {\n\tbg: { r: 255, g: 255, b: 255 },\n\tfg: \"dark\"\n};\n\n// ------------------------------------------------------------------\n\n// https://stackoverflow.com/questions/3942878/how-to-decide-font-color-in-white-or-black-depending-on-background-color\nexport const pickColor = async (url: string) => {\n\tlet res = DEFAULT_COLOR;\n\tif (url) {\n\t\tres = CACHE[url];\n\t\tif (!res) {\n\t\t\ttry {\n\t\t\t\tconst { r, g, b } = await getImageMainColor(url);\n\t\t\t\tCACHE[url] = res = {\n\t\t\t\t\tbg: { r, g, b },\n\t\t\t\t\tfg:\n\t\t\t\t\t\tr * 0.299 + g * 0.587 + b * 0.114 > 186\n\t\t\t\t\t\t\t? \"dark\"\n\t\t\t\t\t\t\t: \"light\"\n\t\t\t\t};\n\t\t\t} catch (err) {\n\t\t\t\tconsole.error(\"An error prevented colorpicking\", err);\n\t\t\t\tCACHE[url] = res = DEFAULT_COLOR;\n\t\t\t}\n\t\t}\n\t}\n\treturn res;\n};\n","const AUDIO_BUFFER_CACHES: Array<{ buffer: AudioBuffer; url: string }> = [];\nconst AUDIO_BUFFER_CACHES_MAX_SIZE = 10;\nlet AUDIO_CONTEXT: AudioContext | null = null;\n\n// ------------------------------------------------------------------\n\nconst getContext = (): AudioContext => {\n\tif (!AUDIO_CONTEXT) {\n\t\tconsole.debug(\"[Audio] Creating context\");\n\t\tAUDIO_CONTEXT = new (window.AudioContext ||\n\t\t\t(window as any).webkitAudioContext)();\n\t}\n\treturn AUDIO_CONTEXT;\n};\n\n// ------------------------------------------------------------------\n\nexport const createAnalyzerNode = () => getContext().createAnalyser();\n\n// ------------------------------------------------------------------\n\nexport const createGainNode = () => getContext().createGain();\n\n// ------------------------------------------------------------------\n\nexport const createSourceNode = () => getContext().createBufferSource();\n\n// ------------------------------------------------------------------\n\nexport const getCurrentTime = () => getContext().currentTime;\n\n// ------------------------------------------------------------------\n\nexport const getDestinationNode = () => getContext().destination;\n\n// ------------------------------------------------------------------\n\nexport const decodeAudioData = (\n\tencodedBuffer: ArrayBuffer\n): Promise<AudioBuffer> =>\n\tnew Promise((resolve, reject) =>\n\t\tgetContext().decodeAudioData(encodedBuffer, resolve, reject)\n\t);\n\n// ------------------------------------------------------------------\n\nexport const loadAudioBuffer = (url: string): Promise<AudioBuffer> =>\n\tnew Promise((resolve, reject) => {\n\t\tconst req = new XMLHttpRequest();\n\t\treq.open(\"GET\", url, true);\n\t\treq.responseType = \"arraybuffer\";\n\t\treq.addEventListener(\n\t\t\t\"error\",\n\t\t\t() => reject(new Error(\"audio.errors.cannot_load_audio_buffer\")),\n\t\t\tfalse\n\t\t);\n\t\treq.addEventListener(\n\t\t\t\"load\",\n\t\t\tasync () => {\n\t\t\t\ttry {\n\t\t\t\t\tresolve(await decodeAudioData(req.response as ArrayBuffer));\n\t\t\t\t} catch (error) {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"[Audio] An error occurred while decoding data\",\n\t\t\t\t\t\t{ error, url }\n\t\t\t\t\t);\n\t\t\t\t\treject(new Error(\"audio.errors.cannot_decode_audio_data\"));\n\t\t\t\t}\n\t\t\t},\n\t\t\tfalse\n\t\t);\n\t\treq.send();\n\t});\n\n// ------------------------------------------------------------------\n\nexport const getOrLoadAudioBuffer = async (\n\turl: string\n): Promise<AudioBuffer> => {\n\tif (!url) {\n\t\tthrow new Error(\"URL is invalid\");\n\t}\n\tlet buffer: AudioBuffer | null = null;\n\tconst index = AUDIO_BUFFER_CACHES.findIndex(item => item.url === url);\n\tif (index >= 0) {\n\t\t// Found: extract old buffer, it will be repush at the end of cache\n\t\tconsole.debug(\"[Audio] Reusing cached buffer...\", {\n\t\t\turl\n\t\t});\n\t\tbuffer = AUDIO_BUFFER_CACHES.splice(index, 1)[0].buffer;\n\t} else {\n\t\t// Not Found\n\t\tconsole.debug(\"[Audio] Loading buffer...\", { url });\n\t\tbuffer = await loadAudioBuffer(url);\n\t}\n\tAUDIO_BUFFER_CACHES.push({ buffer, url });\n\tAUDIO_BUFFER_CACHES.splice(AUDIO_BUFFER_CACHES_MAX_SIZE);\n\treturn buffer;\n};\n\n// ------------------------------------------------------------------\n\n// Fix Safari and iOS Audio Context\n(() => {\n\tconst fixAudioContext = () => {\n\t\tdocument.removeEventListener(\"click\", fixAudioContext);\n\t\tdocument.removeEventListener(\"touchstart\", fixAudioContext);\n\t\tconsole.debug(\"[Audio] Fixing context...\");\n\t\tconst context = getContext();\n\t\t// Create empty buffer, connect to output, play sound\n\t\tvar buffer = context.createBuffer(1, 1, 22050);\n\t\tvar source = context.createBufferSource();\n\t\tsource.buffer = buffer;\n\t\tsource.connect(context.destination);\n\t\tsource.start(0);\n\t};\n\tdocument.addEventListener(\"click\", fixAudioContext);\n\tdocument.addEventListener(\"touchstart\", fixAudioContext);\n})();\n","import {\n\tcreateAnalyzerNode,\n\tcreateGainNode,\n\tcreateSourceNode,\n\tgetCurrentTime,\n\tgetDestinationNode,\n\tgetOrLoadAudioBuffer\n} from \"./audio\";\nimport { PlayMode } from \"./rooms\";\nimport { TrackAccess } from \"./medias\";\n\n// ------------------------------------------------------------------\n\nexport const generateRandomPosition = () => Math.floor(Math.random() * 1000000);\n\n// ------------------------------------------------------------------\n\nexport type Player = {\n\tisPlaying: () => boolean;\n\tgetPlayingTrackID: () => string;\n\tgetPlayingTrackPosition: () => number;\n\tgetPlayingTrackPercent: () => number;\n\tplay: (\n\t\ttrackPosition: number,\n\t\ttrackId: string,\n\t\ttrackUrl: string,\n\t\toffset: number,\n\t\toptions?: {\n\t\t\tplaymode: PlayMode;\n\t\t}\n\t) => Promise<void>;\n\tstop: () => Promise<void>;\n};\n\n// ------------------------------------------------------------------\n\nconst PlayerImpl = (): Player => {\n\tlet _analyserNode: AnalyserNode | null = null;\n\tlet _gainNode: GainNode | null = null;\n\tlet _node: AudioNode | null = null;\n\tlet _duration = 0;\n\tlet _sourceNode: AudioBufferSourceNode | null = null;\n\tlet _startTime = 0;\n\tlet _trackId = \"\";\n\tlet _trackPosition = -1;\n\n\tconst getOrCreateNode = () => {\n\t\tif (!_node) {\n\t\t\t_node = getDestinationNode();\n\n\t\t\t_gainNode = createGainNode();\n\t\t\t_gainNode.gain.value = 1.0;\n\t\t\t_gainNode.connect(_node);\n\t\t\t_node = _gainNode;\n\n\t\t\t_analyserNode = createAnalyzerNode();\n\t\t\t_analyserNode.fftSize = 128;\n\t\t\t// _analyserNode.minDecibels = -90;\n\t\t\t// _analyserNode.maxDecibels = -10;\n\t\t\t_analyserNode.connect(_node);\n\t\t\t_node = _analyserNode;\n\t\t}\n\t\treturn _node;\n\t};\n\n\tconst isPlaying = () => !!_sourceNode;\n\n\tconst getPlayingTrackID = () => _trackId;\n\n\tconst getPlayingTrackPosition = () => _trackPosition;\n\n\t// Percentage [0, 1]\n\tconst getPlayingTrackPercent = () => {\n\t\tif (_sourceNode) {\n\t\t\treturn (getCurrentTime() - _startTime) / _duration;\n\t\t}\n\t\treturn 0;\n\t};\n\n\tconst play = async (\n\t\ttrackPosition: number,\n\t\ttrackId: string,\n\t\ttrackUrl: string,\n\t\toffset: number,\n\t\toptions?: {\n\t\t\tplaymode: PlayMode;\n\t\t}\n\t) => {\n\t\tawait stop();\n\t\tconst buffer = await getOrLoadAudioBuffer(trackUrl); // TODO: warning if loadBuffer takes long for some reason and user clicks stop before end, next part of this function will continue after stop have been requested\n\t\tconsole.debug(\"[Player] Starting audio...\", {\n\t\t\ttrackPosition,\n\t\t\ttrackId,\n\t\t\ttrackUrl\n\t\t});\n\t\t_duration = buffer.duration;\n\t\t_trackId = trackId;\n\t\t_trackPosition = trackPosition;\n\t\t_sourceNode = createSourceNode();\n\t\t_sourceNode.buffer = buffer;\n\t\t_sourceNode.loop = false;\n\t\t_sourceNode.loopStart = 0;\n\t\t_sourceNode.loopEnd = 0;\n\t\t_sourceNode.onended = () => {\n\t\t\tconsole.debug(\"[Player] Audio terminated...\");\n\t\t\t_duration = 0;\n\t\t\t_sourceNode = null;\n\t\t\t_startTime = 0;\n\t\t\t_trackId = \"\";\n\t\t\tif (options?.playmode === \"shuffle\") {\n\t\t\t\t_trackPosition += generateRandomPosition();\n\t\t\t} else {\n\t\t\t\t_trackPosition++;\n\t\t\t}\n\t\t};\n\t\t_sourceNode.playbackRate.value = 1.0;\n\t\t_sourceNode.connect(getOrCreateNode());\n\t\t_sourceNode.start(0, offset); // A new BufferSource must be created for each start\n\t\t_startTime = getCurrentTime();\n\t};\n\n\tconst stop = (): Promise<void> =>\n\t\tnew Promise(resolve => {\n\t\t\tif (null !== _sourceNode) {\n\t\t\t\tconsole.debug(\"[Player] Stopping play...\");\n\t\t\t\t_sourceNode.onended = () => {\n\t\t\t\t\tconsole.debug(\"[Player] Forced audio termination...\");\n\t\t\t\t\tresolve();\n\t\t\t\t};\n\t\t\t\t_sourceNode.stop();\n\t\t\t\t_duration = 0;\n\t\t\t\t_sourceNode = null;\n\t\t\t\t_startTime = 0;\n\t\t\t\t_trackId = \"\";\n\t\t\t\t_trackPosition = -1;\n\t\t\t} else {\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\n\treturn {\n\t\tgetPlayingTrackID,\n\t\tgetPlayingTrackPercent,\n\t\tgetPlayingTrackPosition,\n\t\tisPlaying,\n\t\tplay,\n\t\tstop\n\t};\n};\n\n// ------------------------------------------------------------------\n\nexport const computePlayerNextPosition = (\n\tplayStarted: boolean,\n\tplaying: boolean,\n\tplayingTrackID: string,\n\tplayingTrackIndex: number,\n\ttracks: TrackAccess[],\n\ttrackIndex: number\n) => {\n\tif (!playStarted || tracks.length === 0) {\n\t\treturn -1;\n\t}\n\tlet nextIndex = -1;\n\tif (playingTrackIndex !== trackIndex) {\n\t\tif (playing) {\n\t\t\t// User has clicked an other track or added/removed a track in queue\n\t\t\tif (playingTrackID !== tracks[trackIndex].id) {\n\t\t\t\tnextIndex = trackIndex;\n\t\t\t}\n\t\t} else {\n\t\t\t// Not playing which means previous track has terminated\n\t\t\tnextIndex = playingTrackIndex >= 0 ? playingTrackIndex : trackIndex;\n\t\t}\n\t} else if (playingTrackID !== tracks[trackIndex].id) {\n\t\t// User has deleted playing track\n\t\tnextIndex = trackIndex;\n\t}\n\treturn nextIndex;\n};\n\n// ------------------------------------------------------------------\n\nexport const QUEUE_PLAYER = PlayerImpl();\n\nexport const PREVIEW_PLAYER = PlayerImpl();\n","const config = {\n\tsecret: process.env.REACT_APP_PROXY_SECRET || \"\",\n\turl: process.env.REACT_APP_PROXY_URL || \"\"\n};\n\n// console.debug('[Proxy] Config', config);\n\nexport default config;\n","import crypto from \"crypto\";\n\n// ------------------------------------------------------------------\n\nexport const sign = (\n\tcontext: string,\n\tparams: { [key: string]: string },\n\tsecret: string\n): string => {\n\tconst hmac = crypto.createHmac(\"sha256\", secret);\n\tconst entries = Object.entries(params).sort((e1, e2) =>\n\t\te1[0].localeCompare(e2[0])\n\t);\n\thmac.update(context);\n\tfor (const kvp of entries) {\n\t\thmac.update(kvp[0]);\n\t\thmac.update(kvp[1]);\n\t}\n\treturn hmac.digest(\"hex\");\n};\n","import axios from \"axios\";\n//\nimport proxyConfig from \"../config/proxy\";\nimport { sign } from \"./sign\";\n\n// ------------------------------------------------------------------\n\nexport const callProxy = async (\n\tpath: string,\n\tparams: { [key: string]: string }\n) => {\n\tconsole.debug(\"[Proxy] Requesting... \", { path, params });\n\treturn (\n\t\tawait axios.get(`${proxyConfig.url}${path}`, {\n\t\t\tparams: {\n\t\t\t\t...params,\n\t\t\t\ts: sign(path, params, proxyConfig.secret)\n\t\t\t}\n\t\t})\n\t).data;\n};\n","import { sleep } from \"../\";\nimport { Album, MediaType, Playlist, Track } from \"../medias\";\nimport { SearchOptions, ProviderApi } from \"../providers\";\nimport { callProxy } from \"../proxy\";\n\n// ------------------------------------------------------------------\n\nconst WWW_BASE = \"https://www.deezer.com\";\nconst RATE_LIMIT_DELAY = 5000; // ms\nconst DEFAULT_LIMIT = 10;\n\n// ------------------------------------------------------------------\n\nexport type DeezerApiError = {\n\tcode: number;\n\tmessage: string;\n\ttype: string;\n};\n\nexport type DeezerApiDataCollection<T> = {\n\tdata: T[];\n};\n\nexport type DeezerApiSearchResult<T> = {\n\tdata: T[];\n\ttotal: number;\n};\n\n// ------------------------------------------------------------------\n\nexport type DeezerApiArtist = {\n\tid: number;\n\tname: string;\n};\n\nexport type DeezerApiUser = {\n\tid: number;\n\tname: string;\n};\n\n// ------------------------------------------------------------------\n\nexport type DeezerApiAlbum = {\n\terror?: DeezerApiError;\n\tartist: DeezerApiArtist;\n\tcover_big: string;\n\tcover_small: string;\n\tid: number;\n\ttitle: string;\n\ttracks?: DeezerApiDataCollection<DeezerApiTrack>;\n};\n\nexport type DeezerApiAlbumLight = {\n\tcover_big: string;\n\tcover_small: string;\n\tid: number;\n\ttitle: string;\n};\n\nexport type DeezerApiPlaylist = {\n\terror?: DeezerApiError;\n\tcreator?: DeezerApiUser;\n\tid: number;\n\tpicture_big: string;\n\tpicture_small: string;\n\tpublic: boolean;\n\ttitle: string;\n\ttracks?: DeezerApiDataCollection<DeezerApiTrack>;\n\tuser?: DeezerApiUser;\n};\n\nexport type DeezerApiTrack = {\n\terror?: DeezerApiError;\n\talbum?: DeezerApiAlbumLight;\n\tartist: DeezerApiArtist;\n\tid: number;\n\tpreview: string;\n\treadable: boolean;\n\ttitle: string;\n};\n\n// ------------------------------------------------------------------\n\nconst ConvertAlbum = (album: DeezerApiAlbum): Album => ({\n\tartist: {\n\t\tid: album.artist.id.toString(),\n\t\tname: album.artist.name,\n\t\tlink: `${WWW_BASE}/artist/${album.artist.id}`\n\t},\n\tid: album.id.toString(),\n\tlink: `${WWW_BASE}/album/${album.id}`,\n\tname: album.title,\n\tpicture_big: album.cover_big,\n\tpicture_small: album.cover_small,\n\tprovider: \"deezer\",\n\ttracks:\n\t\talbum.tracks !== void 0\n\t\t\t? album.tracks.data\n\t\t\t\t\t.filter(track => track.readable && track.preview)\n\t\t\t\t\t.map(track => ConvertTrack(track, album))\n\t\t\t: [],\n\ttype: \"album\"\n});\n\nconst ConvertPlaylist = (\n\tplaylist: DeezerApiPlaylist,\n\tuser: DeezerApiUser\n): Playlist => ({\n\tid: playlist.id.toString(),\n\tlink: `${WWW_BASE}/playlist/${playlist.id}`,\n\tname: playlist.title,\n\tpicture_big: playlist.picture_big,\n\tpicture_small: playlist.picture_small,\n\tprovider: \"deezer\",\n\ttracks:\n\t\tplaylist.tracks !== void 0\n\t\t\t? playlist.tracks.data\n\t\t\t\t\t.filter(track => track.readable && track.preview)\n\t\t\t\t\t.map(track => ConvertTrack(track, track.album!))\n\t\t\t: [],\n\ttype: \"playlist\",\n\tuser: {\n\t\tid: user.id.toString(),\n\t\tlink: `${WWW_BASE}/profile/${user.id}`,\n\t\tname: user.name\n\t}\n});\n\nconst ConvertTrack = (\n\ttrack: DeezerApiTrack,\n\talbum: DeezerApiAlbumLight\n): Track => ({\n\talbum: {\n\t\tid: album.id.toString(),\n\t\tlink: `${WWW_BASE}/album/${album.id}`,\n\t\tname: album.title,\n\t\tpicture_big: album.cover_big,\n\t\tpicture_small: album.cover_small\n\t},\n\tartist: {\n\t\tid: track.artist.id.toString(),\n\t\tlink: `${WWW_BASE}/artist/${track.artist.id}`,\n\t\tname: track.artist.name\n\t},\n\tid: track.id.toString(),\n\tlink: `${WWW_BASE}/track/${track.id}`,\n\tname: track.title,\n\tpreview: track.preview,\n\tprovider: \"deezer\",\n\ttype: \"track\"\n});\n\n// ------------------------------------------------------------------\n\nconst DeezerApiImpl = (): ProviderApi => {\n\tconst _call = <T>(\n\t\tpath: string,\n\t\tparams: { [key: string]: string }\n\t): Promise<T> => callProxy(`/deezer/${path}`, params);\n\n\tconst _search = <T>(\n\t\ttype: MediaType,\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t) =>\n\t\t_call<DeezerApiSearchResult<T>>(\"search\", {\n\t\t\tlimit: (options?.limit || DEFAULT_LIMIT).toString(),\n\t\t\tq: encodeURIComponent(query),\n\t\t\ttype: type\n\t\t});\n\n\tconst _load = async <T extends { error?: DeezerApiError }>(\n\t\ttype: MediaType,\n\t\tids: string[]\n\t): Promise<{\n\t\tdelayedIds: string[];\n\t\tfailedIds: string[];\n\t\tloadedMedias: T[];\n\t}> => {\n\t\tconst delayedIds: string[] = [];\n\t\tconst failedIds: string[] = [];\n\t\tconst loadedMedias: T[] = [];\n\t\tawait Promise.all(\n\t\t\tids.map(async id => {\n\t\t\t\tconst media = await _call<T>(\"load\", { id, type });\n\t\t\t\tif (!media.error) {\n\t\t\t\t\tconsole.log(\"[Deezer] Loaded media\", { type, id, media });\n\t\t\t\t\tloadedMedias.push(media);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (media.error.code === 4) {\n\t\t\t\t\tdelayedIds.push(id);\n\t\t\t\t\treturn; // Quota limit exceeded, do not throw so that it will be retried later\n\t\t\t\t}\n\t\t\t\tconsole.error(\n\t\t\t\t\t`[Deezer] An error occured while loading ${type}:`,\n\t\t\t\t\tmedia.error\n\t\t\t\t);\n\t\t\t\tfailedIds.push(id);\n\t\t\t})\n\t\t);\n\t\treturn { delayedIds, failedIds, loadedMedias };\n\t};\n\n\tconst _loadWithRetry = async <T extends { error?: DeezerApiError }>(\n\t\ttype: MediaType,\n\t\tids: string[]\n\t): Promise<T[]> => {\n\t\tlet first = true;\n\t\tconst res: T[] = [];\n\t\tlet remainingIds = [...ids];\n\t\twhile (remainingIds.length > 0) {\n\t\t\tif (!first) {\n\t\t\t\tconsole.debug(`[Deezer] Handling rate limit delayed batch...`, {\n\t\t\t\t\tremainingIds\n\t\t\t\t});\n\t\t\t\tawait sleep(RATE_LIMIT_DELAY);\n\t\t\t}\n\t\t\tconst { delayedIds, loadedMedias } = await _load<T>(\n\t\t\t\ttype,\n\t\t\t\tremainingIds\n\t\t\t);\n\t\t\tres.push(...loadedMedias);\n\t\t\tremainingIds = delayedIds;\n\t\t\tfirst = false;\n\t\t}\n\t\treturn res;\n\t};\n\n\tconst searchAlbums = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Album[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\treturn (\n\t\t\tawait _search<DeezerApiAlbum>(\"album\", query, options)\n\t\t).data.map(ConvertAlbum);\n\t};\n\n\tconst searchPlaylists = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Playlist[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\treturn (\n\t\t\tawait _search<DeezerApiPlaylist>(\"playlist\", query, options)\n\t\t).data\n\t\t\t.filter(playlist => playlist.public)\n\t\t\t.map(playlist => ConvertPlaylist(playlist, playlist.user!));\n\t};\n\n\tconst searchTracks = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Track[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\treturn (await _search<DeezerApiTrack>(\"track\", query, options)).data\n\t\t\t.filter(track => track.readable && track.preview)\n\t\t\t.map(track => ConvertTrack(track, track.album!));\n\t};\n\n\tconst loadAlbums = async (ids: string[]): Promise<Album[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Deezer] Loading albums...\", { ids });\n\t\tconst albums = await _loadWithRetry<DeezerApiAlbum>(\"album\", ids);\n\t\treturn albums.map(ConvertAlbum);\n\t};\n\n\tconst loadPlaylists = async (ids: string[]): Promise<Playlist[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Deezer] Loading playlists...\", { ids });\n\t\tconst playlists = await _loadWithRetry<DeezerApiPlaylist>(\n\t\t\t\"playlist\",\n\t\t\tids\n\t\t);\n\t\treturn playlists.map(playlist =>\n\t\t\tConvertPlaylist(playlist, playlist.creator!)\n\t\t);\n\t};\n\n\tconst loadTracks = async (ids: string[]): Promise<Track[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Deezer] Loading tracks...\", { ids });\n\t\tconst tracks = await _loadWithRetry<DeezerApiTrack>(\"track\", ids);\n\t\treturn tracks.map(track => ConvertTrack(track, track.album!));\n\t};\n\n\treturn {\n\t\tsearchAlbums,\n\t\tsearchPlaylists,\n\t\tsearchTracks,\n\t\tloadAlbums,\n\t\tloadPlaylists,\n\t\tloadTracks\n\t};\n};\n\n// ------------------------------------------------------------------\n\nlet DEFAULT_IMPL: ProviderApi | null = null;\n\nexport const getDeezerApi = (): ProviderApi => {\n\tif (!DEFAULT_IMPL) {\n\t\tDEFAULT_IMPL = DeezerApiImpl();\n\t}\n\treturn DEFAULT_IMPL;\n};\n","import { sleep, chunkArray } from \"..\";\nimport { Album, MediaType, Playlist, Track } from \"../medias\";\nimport { SearchOptions, ProviderApi } from \"../providers\";\nimport { callProxy } from \"../proxy\";\n\n// ------------------------------------------------------------------\n\nconst WWW_BASE = \"https://open.spotify.com\";\nconst RATE_LIMIT_DELAY = 5000; // ms\nconst BATCH_CHUNK_SIZE = 50;\nconst DEFAULT_LIMIT = 10;\n\n// ------------------------------------------------------------------\n\nexport type SpotifyApiArtist = {\n\tid: string;\n\tname: string;\n};\n\nexport type SpotifyApiImage = {\n\theight: number;\n\turl: string;\n\twidth: number;\n};\n\nexport type SpotifyApiUser = {\n\tdisplay_name: string;\n\tid: string;\n};\n\n// ------------------------------------------------------------------\n\nexport type SpotifyApiAlbum = {\n\tartists: SpotifyApiArtist[];\n\tid: string;\n\timages: SpotifyApiImage[];\n\tname: string;\n\ttracks?: {\n\t\titems: SpotifyApiTrack[];\n\t\ttotal: number;\n\t};\n\ttotal_tracks: number;\n};\n\nexport type SpotifyApiPlaylist = {\n\tdescription: string;\n\tid: string;\n\timages: SpotifyApiImage[];\n\tname: string;\n\towner: SpotifyApiUser;\n\tpublic: boolean | null;\n\ttracks: {\n\t\titems?: Array<{ track: SpotifyApiTrack }>;\n\t\ttotal: number;\n\t};\n};\n\nexport type SpotifyApiTrack = {\n\talbum?: SpotifyApiAlbum;\n\tartists: SpotifyApiArtist[];\n\tid: string;\n\tname: string;\n\tpreview_url: string | null;\n};\n\n// ------------------------------------------------------------------\n\nconst ConvertAlbum = (album: SpotifyApiAlbum): Album => ({\n\tartist: {\n\t\tid: album.artists[0].id.toString(),\n\t\tname: album.artists[0].name,\n\t\tlink: `${WWW_BASE}/artist/${album.artists[0].id}`\n\t},\n\tid: album.id,\n\tlink: `${WWW_BASE}/album/${album.id}`,\n\tname: album.name,\n\tpicture_big: album.images[0].url, // TODO\n\tpicture_small: album.images[0].url, // TODO\n\tprovider: \"spotify\",\n\ttracks:\n\t\talbum.tracks !== void 0\n\t\t\t? album.tracks.items\n\t\t\t\t\t.filter(track => track.preview_url)\n\t\t\t\t\t.map(track => ConvertTrack(track, album))\n\t\t\t: [],\n\ttype: \"album\"\n});\n\nconst ConvertPlaylist = (playlist: SpotifyApiPlaylist): Playlist => ({\n\tid: playlist.id,\n\tlink: `${WWW_BASE}/playlist/${playlist.id}`,\n\tname: playlist.name,\n\tpicture_big: playlist.images[0].url, // TODO\n\tpicture_small: playlist.images[0].url, // TODO\n\tprovider: \"spotify\",\n\ttracks:\n\t\tplaylist.tracks.items !== void 0\n\t\t\t? playlist.tracks.items\n\t\t\t\t\t.filter(track => track.track.preview_url)\n\t\t\t\t\t.map(track => ConvertTrack(track.track, track.track.album!))\n\t\t\t: [],\n\ttype: \"playlist\",\n\tuser: {\n\t\tid: playlist.owner.id,\n\t\tlink: `${WWW_BASE}/user/${playlist.owner.id}`,\n\t\tname: playlist.owner.display_name\n\t}\n});\n\nconst ConvertTrack = (\n\ttrack: SpotifyApiTrack,\n\talbum: SpotifyApiAlbum\n): Track => ({\n\talbum: {\n\t\tid: album.id,\n\t\tlink: `${WWW_BASE}/album/${album.id}`,\n\t\tname: album.name,\n\t\tpicture_big: album.images[0].url, // TODO\n\t\tpicture_small: album.images[0].url // TODO\n\t},\n\tartist: {\n\t\tid: track.artists[0].id,\n\t\tname: track.artists[0].name,\n\t\tlink: `${WWW_BASE}/artist/${track.artists[0].id}`\n\t},\n\tid: track.id,\n\tlink: `${WWW_BASE}/track/${track.id}`,\n\tname: track.name,\n\tpreview: track.preview_url || \"\",\n\tprovider: \"spotify\",\n\ttype: \"track\"\n});\n\n// ------------------------------------------------------------------\n\nconst SpotifyApiImpl = (): ProviderApi => {\n\tconst _call = (path: string, params: { [key: string]: string }) =>\n\t\tcallProxy(`/spotify/${path}`, params);\n\n\tconst _search = (type: MediaType, query: string, options?: SearchOptions) =>\n\t\t_call(\"search\", {\n\t\t\tlimit: (options?.limit || DEFAULT_LIMIT).toString(),\n\t\t\tmarket: \"US\",\n\t\t\tq: encodeURIComponent(query),\n\t\t\ttype: type\n\t\t});\n\n\tconst _load = async <T>(\n\t\ttype: MediaType,\n\t\tids: string[]\n\t): Promise<{\n\t\tdelayedIds: string[];\n\t\tfailedIds: string[];\n\t\tloadedMedias: T[];\n\t}> => {\n\t\tconst delayedIds: string[] = [];\n\t\tconst failedIds: string[] = [];\n\t\tconst loadedMedias: T[] = [];\n\t\tawait Promise.all(\n\t\t\tchunkArray(ids, BATCH_CHUNK_SIZE).map(async ids => {\n\t\t\t\tconst medias = (\n\t\t\t\t\tawait _call(\"load\", {\n\t\t\t\t\t\tids: ids.join(\",\"),\n\t\t\t\t\t\tmarket: \"US\",\n\t\t\t\t\t\ttype\n\t\t\t\t\t})\n\t\t\t\t)[`${type}s`] as T[];\n\t\t\t\tconsole.log(\"[Spotify] Loaded media\", { type, ids, medias });\n\t\t\t\tloadedMedias.push(...medias);\n\t\t\t\t/*\n\t\t\t\tif (!media.error) {\n\t\t\t\t\tloadedMedias.push(media);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (media.error.code === 4) {\n\t\t\t\t\tdelayedIds.push(id);\n\t\t\t\t\treturn; // Quota limit exceeded, do not throw so that it will be retried later\n\t\t\t\t}\n\t\t\t\tconsole.error(\n\t\t\t\t\t`[Spotify] An error occured while loading ${type}:`,\n\t\t\t\t\tmedia.error\n\t\t\t\t);\n\t\t\t\tfailedIds.push(id);\n\t\t\t\t*/\n\t\t\t})\n\t\t);\n\t\treturn { delayedIds, failedIds, loadedMedias };\n\t};\n\n\tconst _loadWithRetry = async <T>(\n\t\ttype: MediaType,\n\t\tids: string[]\n\t): Promise<T[]> => {\n\t\tconst res: T[] = [];\n\t\tlet first = true;\n\t\tlet remainingIds = [...ids];\n\t\twhile (remainingIds.length > 0) {\n\t\t\tif (!first) {\n\t\t\t\tconsole.debug(\n\t\t\t\t\t`[Spotify] Handling rate limit delayed batch...`,\n\t\t\t\t\t{\n\t\t\t\t\t\tremainingIds\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\tawait sleep(RATE_LIMIT_DELAY);\n\t\t\t}\n\t\t\tconst { delayedIds, loadedMedias } = await _load<T>(\n\t\t\t\ttype,\n\t\t\t\tremainingIds\n\t\t\t);\n\t\t\tres.push(...loadedMedias);\n\t\t\tremainingIds = delayedIds;\n\t\t\tfirst = false;\n\t\t}\n\t\treturn res;\n\t};\n\n\tconst searchAlbums = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Album[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconst res = (await _search(\"album\", query, options)) as {\n\t\t\talbums: {\n\t\t\t\titems: SpotifyApiAlbum[];\n\t\t\t\ttotal: number;\n\t\t\t};\n\t\t};\n\t\treturn res.albums.items.map(ConvertAlbum);\n\t};\n\n\tconst searchPlaylists = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Playlist[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconst res = (await _search(\"playlist\", query, options)) as {\n\t\t\tplaylists: {\n\t\t\t\titems: SpotifyApiPlaylist[];\n\t\t\t\ttotal: number;\n\t\t\t};\n\t\t};\n\t\treturn res.playlists.items\n\t\t\t.filter(playlist => playlist.public !== false)\n\t\t\t.map(ConvertPlaylist);\n\t};\n\n\tconst searchTracks = async (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t): Promise<Track[]> => {\n\t\tif (query.trim().length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconst res = (await _search(\"track\", query, options)) as {\n\t\t\ttracks: {\n\t\t\t\titems: SpotifyApiTrack[];\n\t\t\t\ttotal: number;\n\t\t\t};\n\t\t};\n\t\treturn res.tracks.items\n\t\t\t.filter(track => track.preview_url)\n\t\t\t.map(track => ConvertTrack(track, track.album!));\n\t};\n\n\tconst loadAlbums = async (ids: string[]): Promise<Album[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Spotify] Loading albums...\", { ids });\n\t\tconst albums = await _loadWithRetry<SpotifyApiAlbum>(\"album\", ids);\n\t\treturn albums.map(ConvertAlbum);\n\t};\n\n\tconst loadPlaylists = async (ids: string[]): Promise<Playlist[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Spotify] Loading playlists...\", { ids });\n\t\tconst playlists = await _loadWithRetry<SpotifyApiPlaylist>(\n\t\t\t\"playlist\",\n\t\t\tids\n\t\t);\n\t\treturn playlists.map(ConvertPlaylist);\n\t};\n\n\tconst loadTracks = async (ids: string[]): Promise<Track[]> => {\n\t\tif (ids.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\tconsole.debug(\"[Spotify] Loading tracks...\", { ids });\n\t\tconst tracks = await _loadWithRetry<SpotifyApiTrack>(\"track\", ids);\n\t\treturn tracks.map(track => ConvertTrack(track, track.album!));\n\t};\n\n\treturn {\n\t\tsearchAlbums,\n\t\tsearchPlaylists,\n\t\tsearchTracks,\n\t\tloadAlbums,\n\t\tloadPlaylists,\n\t\tloadTracks\n\t};\n};\n\n// ------------------------------------------------------------------\n\nlet DEFAULT_IMPL: ProviderApi | null = null;\n\nexport const getSpotifyApi = (): ProviderApi => {\n\tif (!DEFAULT_IMPL) {\n\t\tDEFAULT_IMPL = SpotifyApiImpl();\n\t}\n\treturn DEFAULT_IMPL;\n};\n","import {\n\tMedia,\n\tMediaAccess,\n\tStructuredMedias,\n\tAlbum,\n\tPlaylist,\n\tTrack,\n\tMediaType,\n\tProviderType\n} from \"../medias\";\nimport { getDeezerApi } from \"./deezer\";\nimport { getSpotifyApi } from \"./spotify\";\n\n// ------------------------------------------------------------------\n\nexport type SearchOptions = {\n\tlimit?: number;\n};\n\nexport type SearchResults = {\n\t[provider in ProviderType]: {\n\t\talbum: Album[];\n\t\tplaylist: Playlist[];\n\t\ttrack: Track[];\n\t};\n};\n\nexport type ProviderApi = {\n\tloadAlbums: (ids: string[]) => Promise<Album[]>;\n\n\tloadPlaylists: (ids: string[]) => Promise<Playlist[]>;\n\n\tloadTracks: (ids: string[]) => Promise<Track[]>;\n\n\tsearchAlbums: (query: string, options?: SearchOptions) => Promise<Album[]>;\n\n\tsearchPlaylists: (\n\t\tquery: string,\n\t\toptions?: SearchOptions\n\t) => Promise<Playlist[]>;\n\n\tsearchTracks: (query: string, options?: SearchOptions) => Promise<Track[]>;\n};\n\n// ------------------------------------------------------------------\n\nexport const loadMedias = async (accesses: MediaAccess[]): Promise<Media[]> => {\n\tconst ids: {\n\t\t[provider in ProviderType]: {\n\t\t\t[media in MediaType]: string[];\n\t\t};\n\t} = {\n\t\tdeezer: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t},\n\t\tspotify: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t}\n\t};\n\tfor (const access of accesses) {\n\t\tids[access.provider][access.type].push(access.id);\n\t}\n\tconst deezerApi = getDeezerApi();\n\tconst spotifyApi = getSpotifyApi();\n\tconst medias: SearchResults = {\n\t\tdeezer: {\n\t\t\talbum: await deezerApi.loadAlbums(ids.deezer.album),\n\t\t\tplaylist: await deezerApi.loadPlaylists(ids.deezer.playlist),\n\t\t\ttrack: await deezerApi.loadTracks(ids.deezer.track)\n\t\t},\n\t\tspotify: {\n\t\t\talbum: await spotifyApi.loadAlbums(ids.spotify.album),\n\t\t\tplaylist: await spotifyApi.loadPlaylists(ids.spotify.playlist),\n\t\t\ttrack: await spotifyApi.loadTracks(ids.spotify.track)\n\t\t}\n\t};\n\tconst flatten: Media[] = [];\n\tfor (const access of accesses) {\n\t\tconst media = (medias[access.provider][access.type] as Media[]).find(\n\t\t\tother => other.id === access.id\n\t\t);\n\t\tif (media) {\n\t\t\tflatten.push(media);\n\t\t}\n\t}\n\treturn flatten;\n};\n\n// ------------------------------------------------------------------\n\nexport const loadNewMedias = async (\n\taccesses: MediaAccess[],\n\toldMedias: StructuredMedias\n): Promise<{\n\tnewMedias: Media[];\n\tnewMediasAndTracks: Media[];\n}> => {\n\tconst newAccesses: MediaAccess[] = accesses\n\t\t// Only not already loaded\n\t\t.filter(access => !oldMedias[access.provider][access.type][access.id])\n\t\t// Only unique\n\t\t.filter(\n\t\t\t(value, index, self) =>\n\t\t\t\tindex ===\n\t\t\t\tself.findIndex(\n\t\t\t\t\tother =>\n\t\t\t\t\t\tother.id === value.id &&\n\t\t\t\t\t\tother.provider === value.provider &&\n\t\t\t\t\t\tother.type === value.type\n\t\t\t\t)\n\t\t);\n\tconst newMedias = await loadMedias(newAccesses);\n\tconst newMediasAndTracks: Media[] = [];\n\tfor (const media of newMedias) {\n\t\tnewMediasAndTracks.push(media);\n\t\tif (media.type !== \"track\") {\n\t\t\tnewMediasAndTracks.push(...media.tracks);\n\t\t}\n\t}\n\treturn { newMedias, newMediasAndTracks };\n};\n// ------------------------------------------------------------------\n\nexport const searchMedias = async (\n\tq: string,\n\toptions?: SearchOptions,\n\tproviderType?: ProviderType,\n\tmediaType?: MediaType\n): Promise<SearchResults> => {\n\tconst deezerApi = getDeezerApi();\n\tconst spotifyApi = getSpotifyApi();\n\tif (!providerType || !mediaType) {\n\t\tconst [\n\t\t\tdeezerAlbums,\n\t\t\tdeezerPlaylists,\n\t\t\tdeezerTracks,\n\t\t\tspotifyAlbums,\n\t\t\tspotifyPlaylists,\n\t\t\tspotifyTracks\n\t\t] = await Promise.all([\n\t\t\tdeezerApi.searchAlbums(q, options),\n\t\t\tdeezerApi.searchPlaylists(q, options),\n\t\t\tdeezerApi.searchTracks(q, options),\n\t\t\tspotifyApi.searchAlbums(q, options),\n\t\t\tspotifyApi.searchPlaylists(q, options),\n\t\t\tspotifyApi.searchTracks(q, options)\n\t\t]);\n\t\treturn {\n\t\t\tdeezer: {\n\t\t\t\talbum: deezerAlbums,\n\t\t\t\tplaylist: deezerPlaylists,\n\t\t\t\ttrack: deezerTracks\n\t\t\t},\n\t\t\tspotify: {\n\t\t\t\talbum: spotifyAlbums,\n\t\t\t\tplaylist: spotifyPlaylists,\n\t\t\t\ttrack: spotifyTracks\n\t\t\t}\n\t\t};\n\t}\n\tconst results: SearchResults = {\n\t\tdeezer: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t},\n\t\tspotify: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t}\n\t};\n\tconst collection = results[providerType];\n\tconst providerApi = providerType === \"deezer\" ? deezerApi : spotifyApi;\n\tswitch (mediaType) {\n\t\tcase \"album\":\n\t\t\tcollection.album = await providerApi.searchAlbums(q, options);\n\t\t\tbreak;\n\t\tcase \"playlist\":\n\t\t\tcollection.playlist = await providerApi.searchPlaylists(q, options);\n\t\t\tbreak;\n\t\tcase \"track\":\n\t\t\tcollection.track = await providerApi.searchTracks(q, options);\n\t\t\tbreak;\n\t}\n\treturn results;\n};\n","import { Reducer } from \"redux\";\nimport { StructuredMedias, Media } from \"../utils/medias\";\nimport { createAction } from \"../actions\";\n\n// ------------------------------------------------------------------\n\ntype MediasAction =\n\t| ReturnType<typeof fetching>\n\t| ReturnType<typeof error>\n\t| ReturnType<typeof resetMedias>\n\t| ReturnType<typeof setMedias>;\n\nexport const fetching = () => createAction(\"medias/FETCHING\");\nexport const error = (error: string) => createAction(\"medias/ERROR\", error);\nexport const resetMedias = () => createAction(\"medias/RESET\");\nexport const setMedias = (medias: Media[]) =>\n\tcreateAction(\"medias/SET\", medias);\n\n// ------------------------------------------------------------------\n\nexport type State = {\n\terror: null | string;\n\tfetching: boolean;\n\tmedias: StructuredMedias;\n};\n\nconst INITIAL_STATE: State = {\n\terror: null,\n\tfetching: false,\n\tmedias: {\n\t\tdeezer: {\n\t\t\talbum: {},\n\t\t\tplaylist: {},\n\t\t\ttrack: {}\n\t\t},\n\t\tspotify: {\n\t\t\talbum: {},\n\t\t\tplaylist: {},\n\t\t\ttrack: {}\n\t\t}\n\t}\n};\n\n// ------------------------------------------------------------------\n\nexport const mediasReducer: Reducer<State, MediasAction> = (\n\tstate = INITIAL_STATE,\n\taction: MediasAction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"medias/FETCHING\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: true,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"medias/ERROR\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: false,\n\t\t\t\terror: action.payload\n\t\t\t};\n\t\tcase \"medias/SET\": {\n\t\t\tconst copy: State = {\n\t\t\t\t...state,\n\t\t\t\tfetching: false,\n\t\t\t\terror: null,\n\t\t\t\tmedias: {\n\t\t\t\t\tdeezer: {\n\t\t\t\t\t\talbum: { ...state.medias.deezer.album },\n\t\t\t\t\t\tplaylist: { ...state.medias.deezer.playlist },\n\t\t\t\t\t\ttrack: { ...state.medias.deezer.track }\n\t\t\t\t\t},\n\t\t\t\t\tspotify: {\n\t\t\t\t\t\talbum: { ...state.medias.deezer.album },\n\t\t\t\t\t\tplaylist: { ...state.medias.deezer.playlist },\n\t\t\t\t\t\ttrack: { ...state.medias.deezer.track }\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\tfor (const media of action.payload) {\n\t\t\t\tcopy.medias[media.provider][media.type][media.id] = media;\n\t\t\t}\n\t\t\treturn copy;\n\t\t}\n\t\tcase \"medias/RESET\":\n\t\t\treturn INITIAL_STATE;\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import { Reducer } from \"redux\";\nimport { RoomAccess, RoomInfo, RoomQueue } from \"../utils/rooms\";\nimport { CombinedColor } from \"../utils/colorpicker\";\nimport { FirebaseRoom } from \"../utils/firebase/room\";\nimport { ContextualizedTrackAccess, MediaAccess } from \"../utils/medias\";\nimport { createAction } from \"../actions\";\n\n// ------------------------------------------------------------------\n\ntype RoomAction =\n\t| ReturnType<typeof fetching>\n\t| ReturnType<typeof error>\n\t| ReturnType<typeof resetRoom>\n\t| ReturnType<typeof setRoom>;\n\nexport const fetching = () => createAction(\"room/FETCHING\");\nexport const error = (error: string) => createAction(\"room/ERROR\", error);\nexport const resetRoom = () => createAction(\"room/RESET\");\nexport const setRoom = (values: Partial<RoomData>) =>\n\tcreateAction(\"room/SET\", values);\n\n// ------------------------------------------------------------------\n\nexport type RoomData = {\n\t_fbRoom: ReturnType<typeof FirebaseRoom> | null;\n\taccess: RoomAccess;\n\tcolor: CombinedColor;\n\textra: string;\n\tinfo: RoomInfo | null;\n\tmedias: MediaAccess[];\n\tqueue: RoomQueue | null;\n\ttracks: Array<ContextualizedTrackAccess>;\n};\n\nexport type State = RoomData & {\n\tfetching: boolean;\n\terror: null | string;\n};\n\nconst INITIAL_STATE: State = {\n\t_fbRoom: null,\n\taccess: { dbId: \"\", roomId: \"\", secret: \"\" },\n\tcolor: { fg: \"dark\", bg: { r: 255, g: 255, b: 255 } },\n\terror: null,\n\textra: \"\",\n\tfetching: false,\n\tinfo: null,\n\tmedias: [],\n\tqueue: null,\n\ttracks: []\n};\n\n// ------------------------------------------------------------------\n\nexport const roomReducer: Reducer<State, RoomAction> = (\n\tstate = INITIAL_STATE,\n\taction: RoomAction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"room/FETCHING\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: true,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"room/ERROR\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: false,\n\t\t\t\terror: action.payload\n\t\t\t};\n\t\tcase \"room/SET\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\t...action.payload,\n\t\t\t\tfetching: false,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"room/RESET\":\n\t\t\treturn INITIAL_STATE;\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","export type ContainerType = \"album\" | \"playlist\";\n\nexport type MediaType = ContainerType | \"track\";\n\nexport const MediaTypes: MediaType[] = [\"album\", \"playlist\", \"track\"];\n\nexport type MediaTypeDefinition = {\n\tlabel: string;\n\tprovider: ProviderType;\n\ttype: MediaType;\n};\n\nexport type ProviderType = \"deezer\" | \"spotify\";\n\nexport type TrackType = \"track\";\n\n// ------------------------------------------------------------------\n\nexport type AlbumAccess = {\n\tid: string;\n\tprovider: ProviderType;\n\ttype: \"album\";\n};\n\nexport type PlaylistAccess = {\n\tid: string;\n\tprovider: ProviderType;\n\ttype: \"playlist\";\n};\n\nexport type TrackAccess = {\n\tid: string;\n\tprovider: ProviderType;\n\ttype: \"track\";\n};\n\nexport type ContainerAccess = AlbumAccess | PlaylistAccess;\n\nexport type MediaAccess = ContainerAccess | TrackAccess;\n\nexport type ContextualizedTrackAccess = {\n\tcontextId: string;\n\tcontextType: MediaType;\n} & TrackAccess;\n\n// ------------------------------------------------------------------\n\nexport type Album = {\n\tartist: Artist;\n\tid: string;\n\tlink: string;\n\tname: string;\n\tpicture_big: string;\n\tpicture_small: string;\n\tprovider: ProviderType;\n\ttracks: Track[];\n\ttype: \"album\";\n};\n\nexport type AlbumLight = {\n\tid: string;\n\tlink: string;\n\tname: string;\n\tpicture_big: string;\n\tpicture_small: string;\n};\n\nexport type Artist = {\n\tid: string;\n\tlink: string;\n\tname: string;\n};\n\nexport type Playlist = {\n\tid: string;\n\tlink: string;\n\tname: string;\n\tpicture_big: string;\n\tpicture_small: string;\n\tprovider: ProviderType;\n\ttracks: Track[];\n\ttype: \"playlist\";\n\tuser: {\n\t\tid: string;\n\t\tlink: string;\n\t\tname: string;\n\t};\n};\n\nexport type Track = {\n\talbum: AlbumLight;\n\tartist: Artist;\n\tid: string;\n\tlink: string;\n\tname: string;\n\tpreview: string;\n\tprovider: ProviderType;\n\ttype: \"track\";\n};\n\nexport type Container = Album | Playlist;\n\nexport type Media = Container | Track;\n\nexport type StructuredMedias = {\n\t[provider in ProviderType]: {\n\t\t// keys are MediaType\n\t\talbum: { [id: string]: Album };\n\t\tplaylist: { [id: string]: Playlist };\n\t\ttrack: { [id: string]: Track };\n\t};\n};\n\n// ------------------------------------------------------------------\n\nexport const MEDIA_TYPE_DEFINITIONS: MediaTypeDefinition[] = [\n\t{\n\t\tlabel: \"medias.deezer.albums\",\n\t\tprovider: \"deezer\",\n\t\ttype: \"album\"\n\t},\n\t{\n\t\tlabel: \"medias.deezer.playlists\",\n\t\tprovider: \"deezer\",\n\t\ttype: \"playlist\"\n\t},\n\t{\n\t\tlabel: \"medias.deezer.tracks\",\n\t\tprovider: \"deezer\",\n\t\ttype: \"track\"\n\t},\n\t{\n\t\tlabel: \"medias.spotify.albums\",\n\t\tprovider: \"spotify\",\n\t\ttype: \"album\"\n\t},\n\t{\n\t\tlabel: \"medias.spotify.playlists\",\n\t\tprovider: \"spotify\",\n\t\ttype: \"playlist\"\n\t},\n\t{\n\t\tlabel: \"medias.spotify.tracks\",\n\t\tprovider: \"spotify\",\n\t\ttype: \"track\"\n\t}\n];\n\n// ------------------------------------------------------------------\n\nconst findMediaInDict = (\n\taccess: MediaAccess,\n\tmedias: StructuredMedias\n): Media | undefined => medias[access.provider][access.type][access.id];\n\n// ------------------------------------------------------------------\n\nconst findMediaInList = (\n\taccess: MediaAccess,\n\tmedias: Media[]\n): Media | undefined =>\n\tmedias.find(\n\t\titem =>\n\t\t\titem.id === access.id &&\n\t\t\titem.provider === access.provider &&\n\t\t\titem.type === access.type\n\t);\n\n// ------------------------------------------------------------------\n\nexport const findMedia = (\n\taccess: MediaAccess,\n\tdist: StructuredMedias,\n\tlist: Media[]\n): Media | undefined =>\n\tfindMediaInDict(access, dist) || findMediaInList(access, list);\n\n// ------------------------------------------------------------------\n\nexport const findPreview = (\n\taccess: MediaAccess,\n\toldMedias: StructuredMedias,\n\tnewMedias: Media[]\n): Track | null => {\n\tconst media = findMedia(access, oldMedias, newMedias);\n\tif (!media) {\n\t\treturn null;\n\t}\n\tif (media.type === \"track\") {\n\t\treturn media;\n\t}\n\tif (media.tracks && media.tracks.length > 0) {\n\t\treturn media.tracks[0];\n\t}\n\treturn null;\n};\n\n// ------------------------------------------------------------------\n\nexport const extractTracks = (\n\taccesses: MediaAccess[],\n\toldMedias: StructuredMedias,\n\tnewMedias: Media[]\n): ContextualizedTrackAccess[] => {\n\tconst tracks: ContextualizedTrackAccess[] = [];\n\tfor (const access of accesses) {\n\t\tif (access.type === \"track\") {\n\t\t\ttracks.push({\n\t\t\t\tcontextId: access.id,\n\t\t\t\tcontextType: access.type,\n\t\t\t\tid: access.id,\n\t\t\t\tprovider: access.provider,\n\t\t\t\ttype: access.type\n\t\t\t});\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst container = findMedia(access, oldMedias, newMedias);\n\t\tif (!container) {\n\t\t\tthrow new Error(\"Media is unknown\");\n\t\t}\n\n\t\tif (\n\t\t\tcontainer.type !== \"track\" &&\n\t\t\tcontainer.tracks &&\n\t\t\tcontainer.tracks.length > 0\n\t\t) {\n\t\t\tfor (const track of container.tracks) {\n\t\t\t\ttracks.push({\n\t\t\t\t\tcontextId: container.id,\n\t\t\t\t\tcontextType: container.type,\n\t\t\t\t\tid: track.id,\n\t\t\t\t\tprovider: track.provider,\n\t\t\t\t\ttype: track.type\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\treturn tracks;\n};\n\n// ------------------------------------------------------------------\n\nexport const findContextFromTrackIndex = (\n\tmedias: MediaAccess[],\n\ttrackIndex: number,\n\tallMedias: StructuredMedias\n): {\n\tmediaFirstTrackIndex: number;\n\tmediaIndex: number;\n\tmediaSize: number;\n} => {\n\tif (trackIndex < 0) {\n\t\tthrow new Error(\"Track index is out of range\");\n\t}\n\tlet index = 0;\n\tfor (let mediaIndex = 0; mediaIndex < medias.length; ++mediaIndex) {\n\t\tconst media = medias[mediaIndex];\n\t\tif (media.type === \"track\") {\n\t\t\tif (trackIndex === index) {\n\t\t\t\treturn {\n\t\t\t\t\tmediaFirstTrackIndex: trackIndex,\n\t\t\t\t\tmediaIndex,\n\t\t\t\t\tmediaSize: 1\n\t\t\t\t};\n\t\t\t}\n\t\t\tindex++;\n\t\t} else {\n\t\t\tconst container = findMediaInDict(media, allMedias);\n\t\t\tif (!container) {\n\t\t\t\tthrow new Error(\"Media is unknown\");\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\tcontainer.type !== \"track\" &&\n\t\t\t\tcontainer.tracks &&\n\t\t\t\tcontainer.tracks.length > 0\n\t\t\t) {\n\t\t\t\tconst mediaFirstTrackIndex = index;\n\t\t\t\tfor (let i = 0; i < container.tracks.length; ++i) {\n\t\t\t\t\tif (trackIndex === index) {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tmediaFirstTrackIndex,\n\t\t\t\t\t\t\tmediaIndex,\n\t\t\t\t\t\t\tmediaSize: container.tracks.length\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\tindex++;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tthrow new Error(\"Track index is out of range\");\n};\n","import { AsyncAction, trySomething } from \".\";\nimport { MediaAccess, findPreview, Media } from \"../utils/medias\";\nimport { PREVIEW_PLAYER } from \"../utils/player\";\nimport { loadNewMedias } from \"../utils/providers\";\nimport { displayMessage } from \"./messages\";\nimport { renderMediaInToaster } from \"../components/Room/Medias\";\n\n// ------------------------------------------------------------------\n\nexport const displayMediaInfo = (media: Media): AsyncAction => dispatch =>\n\tdispatch(\n\t\tdisplayMessage(\"info\", {\n\t\t\tduration: 5000,\n\t\t\textra: () => renderMediaInToaster(media)\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const previewMedia = (access: MediaAccess): AsyncAction => (\n\tdispatch,\n\tgetState\n) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tmedias: { medias: oldMedias }\n\t\t\t\t} = getState();\n\t\t\t\tconst { newMedias } = await loadNewMedias([access], oldMedias);\n\t\t\t\tconst track = findPreview(access, oldMedias, newMedias);\n\t\t\t\tif (!track) {\n\t\t\t\t\tthrow new Error(\"[Medias] Cannot find track to preview...\");\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Medias] Previewing track...\", { track });\n\t\t\t\tawait PREVIEW_PLAYER.play(0, track.id, track.preview, 0);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n","import { createHashHistory } from \"history\";\n\nexport default createHashHistory();\n","import { v4 } from \"uuid\";\n//\nimport { AsyncAction, Dispatch, ActionOptions, trySomething } from \".\";\nimport { displayError } from \"./messages\";\nimport { RoomInfo, RoomType, initializeRoom, RoomQueue } from \"../utils/rooms\";\nimport { FirebaseRoom } from \"../utils/firebase/room\";\nimport { extractErrorMessage } from \"../utils/messages\";\nimport { pickColor } from \"../utils/colorpicker\";\nimport { Player } from \"../utils/player\";\nimport { computePlayerNextPosition } from \"../utils/player\";\nimport { loadNewMedias } from \"../utils/providers\";\nimport { RootState } from \"../reducers\";\nimport { setMedias } from \"../reducers/medias\";\nimport { setRoom, resetRoom, fetching, error } from \"../reducers/room\";\nimport { displayMediaInfo } from \"./medias\";\nimport history from \"../utils/history\";\nimport {\n\tMediaAccess,\n\textractTracks,\n\tContextualizedTrackAccess\n} from \"../utils/medias\";\n\n// ------------------------------------------------------------------\n\nexport const createRoom = ({\n\tdbId,\n\tname,\n\tsecret,\n\ttype,\n\toptions\n}: {\n\tdbId: string;\n\tname: string;\n\tsecret: string;\n\ttype: RoomType;\n\toptions?: ActionOptions;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { userId }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!userId) {\n\t\t\t\t\tdispatch(displayError(\"user.not_connected\"));\n\t\t\t\t\treturn \"connect-and-retry\";\n\t\t\t\t}\n\t\t\t\tconst roomId = v4();\n\t\t\t\tconsole.debug(\"[Room] Creating...\", {\n\t\t\t\t\tdbId,\n\t\t\t\t\troomId,\n\t\t\t\t\tsecret\n\t\t\t\t});\n\n\t\t\t\tconst { extra, queue } = initializeRoom({ type, userId });\n\t\t\t\tawait FirebaseRoom({ dbId, roomId, secret }).init({\n\t\t\t\t\textra,\n\t\t\t\t\tinfo: {\n\t\t\t\t\t\tname,\n\t\t\t\t\t\ttype\n\t\t\t\t\t},\n\t\t\t\t\tqueue\n\t\t\t\t});\n\t\t\t\tdispatch(enterRoom({ dbId, roomId, secret, options }));\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => {\n\t\t\t\tif (options?.onFailure) {\n\t\t\t\t\toptions.onFailure();\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const enterRoom = ({\n\tdbId,\n\troomId,\n\tsecret,\n\toptions\n}: {\n\tdbId: string;\n\troomId: string;\n\tsecret: string;\n\toptions?: ActionOptions;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom },\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { userId }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (\n\t\t\t\t\t_fbRoom &&\n\t\t\t\t\t_fbRoom.dbId === dbId &&\n\t\t\t\t\t_fbRoom.roomId === roomId\n\t\t\t\t) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\n\t\t\t\tdispatch(exitRoom());\n\n\t\t\t\tif (!userId) {\n\t\t\t\t\tdispatch(displayError(\"user.not_connected\"));\n\t\t\t\t\treturn \"connect-and-retry\";\n\t\t\t\t}\n\n\t\t\t\tdispatch(fetching());\n\n\t\t\t\tconsole.debug(\"[Room] Entering...\", { dbId, roomId, secret });\n\t\t\t\tconst newFbRoom = FirebaseRoom({ dbId, roomId, secret });\n\t\t\t\tconst { extra, info } = await newFbRoom.wait();\n\t\t\t\tdispatch(\n\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t_fbRoom: newFbRoom,\n\t\t\t\t\t\taccess: { dbId, roomId, secret },\n\t\t\t\t\t\textra,\n\t\t\t\t\t\tinfo\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t\tdispatch(_watchRoom(newFbRoom));\n\t\t\t\tdispatch(_watchPlayer());\n\t\t\t\thistory.push(`/room/${dbId}/${roomId}?secret=${secret}`); // TODO: should push only if we're not already in it\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => {\n\t\t\t\tdispatch(error(\"Cannot enter\")); // TODO: wording\n\t\t\t\tdispatch(exitRoom());\n\t\t\t\tif (options?.onFailure) {\n\t\t\t\t\toptions.onFailure();\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t})\n\t);\n\nexport const exitRoom = (): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Room] Exiting...\");\n\t\t\t\tdispatch(_unwatchPlayer());\n\t\t\t\tdispatch(_unwatchRoom(_fbRoom));\n\t\t\t\tdispatch(resetRoom());\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const lockRoom = (): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: {\n\t\t\t\t\t\t_fbRoom,\n\t\t\t\t\t\taccess: { dbId, roomId, secret: oldSecret }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (\n\t\t\t\t\t!_fbRoom ||\n\t\t\t\t\t_fbRoom.dbId !== dbId ||\n\t\t\t\t\t_fbRoom.roomId !== roomId ||\n\t\t\t\t\t!oldSecret\n\t\t\t\t) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Room] Locking...\", { dbId, roomId });\n\t\t\t\t_fbRoom.setSecret(\"\");\n\t\t\t\t// TODO : not history.replace(`/room/${dbId}/${roomId}`); as it would trigger a page refresh\n\t\t\t\tdispatch(setRoom({ access: { dbId, roomId, secret: \"\" } }));\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n\nexport const unlockRoom = ({\n\tsecret,\n\toptions\n}: {\n\tsecret: string;\n\toptions?: ActionOptions;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: {\n\t\t\t\t\t\t_fbRoom,\n\t\t\t\t\t\taccess: { dbId, roomId, secret: oldSecret }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (\n\t\t\t\t\t!_fbRoom ||\n\t\t\t\t\t_fbRoom.dbId !== dbId ||\n\t\t\t\t\t_fbRoom.roomId !== roomId ||\n\t\t\t\t\toldSecret === secret\n\t\t\t\t) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Room] Unlocking...\", { dbId, roomId, secret });\n\t\t\t\t_fbRoom.setSecret(secret);\n\t\t\t\t// TODO : not history.replace(`/room/${id}?secret=${secret}`); as it would trigger a page refresh\n\t\t\t\tdispatch(setRoom({ access: { dbId, roomId, secret } }));\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\t...options\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n// ------------------------------------------------------------------\n// ------------------------------------------------------------------\n\nlet EXTRA_SUBSCRIPTION: any = null;\nlet INFO_SUBSCRIPTION: any = null;\nlet QUEUE_SUBSCRIPTION: any = null;\n\nconst _watchRoom = (\n\tfbRoom: ReturnType<typeof FirebaseRoom>\n): AsyncAction => async (dispatch, getState) => {\n\tconsole.debug(\"[Room] Watching...\");\n\tif (!!EXTRA_SUBSCRIPTION || !!INFO_SUBSCRIPTION || !!QUEUE_SUBSCRIPTION) {\n\t\treturn; // Nothing to do\n\t}\n\tEXTRA_SUBSCRIPTION = fbRoom.subscribeExtra(async (newExtra: string) => {\n\t\tconsole.debug(\"[Room] Received room extra update...\", { newExtra });\n\t\tdispatch(\n\t\t\tsetRoom({\n\t\t\t\textra: newExtra\n\t\t\t})\n\t\t);\n\t});\n\tINFO_SUBSCRIPTION = fbRoom.subscribeInfo(async (newInfo: RoomInfo) => {\n\t\tconsole.debug(\"[Room] Received room info update...\", { newInfo });\n\t\tdispatch(\n\t\t\tsetRoom({\n\t\t\t\tinfo: newInfo\n\t\t\t})\n\t\t);\n\t});\n\tQUEUE_SUBSCRIPTION = fbRoom.subscribeQueue(async (newQueue: RoomQueue) => {\n\t\tconsole.debug(\"[Room] Received room queue update...\", { newQueue });\n\t\tconst {\n\t\t\tmedias: { medias: oldMedias }\n\t\t} = getState();\n\t\tconst medias: MediaAccess[] = !newQueue.medias\n\t\t\t? []\n\t\t\t: Object.entries(newQueue.medias)\n\t\t\t\t\t.sort((m1, m2) => Number(m1[0]) - Number(m2[0]))\n\t\t\t\t\t.map(m => m[1]);\n\t\tlet tracks: ContextualizedTrackAccess[] = [];\n\t\tif (medias.length > 0) {\n\t\t\tconst { newMedias, newMediasAndTracks } = await loadNewMedias(\n\t\t\t\tmedias,\n\t\t\t\toldMedias\n\t\t\t);\n\t\t\tif (newMediasAndTracks.length > 0) {\n\t\t\t\tdispatch(setMedias(newMediasAndTracks));\n\t\t\t}\n\t\t\ttracks = extractTracks(medias, oldMedias, newMedias);\n\t\t}\n\t\tdispatch(\n\t\t\tsetRoom({\n\t\t\t\tqueue: newQueue,\n\t\t\t\tmedias,\n\t\t\t\ttracks\n\t\t\t})\n\t\t);\n\t});\n};\n\nconst _unwatchRoom = (\n\troom: ReturnType<typeof FirebaseRoom>\n): AsyncAction => async () => {\n\tif (!!EXTRA_SUBSCRIPTION) {\n\t\tconsole.debug(\"Unwatching room extra...\");\n\t\troom.unsubscribeExtra(EXTRA_SUBSCRIPTION);\n\t\tEXTRA_SUBSCRIPTION = null;\n\t}\n\tif (!!INFO_SUBSCRIPTION) {\n\t\tconsole.debug(\"Unwatching room info...\");\n\t\troom.unsubscribeInfo(INFO_SUBSCRIPTION);\n\t\tINFO_SUBSCRIPTION = null;\n\t}\n\tif (!!QUEUE_SUBSCRIPTION) {\n\t\tconsole.debug(\"Unwatching room queue...\");\n\t\troom.unsubscribeQueue(QUEUE_SUBSCRIPTION);\n\t\tQUEUE_SUBSCRIPTION = null;\n\t}\n};\n\n// ------------------------------------------------------------------\n// ------------------------------------------------------------------\n// ------------------------------------------------------------------\n\nlet PLAYER_TIMER: NodeJS.Timeout | null = null;\n\nconst _watchPlayer = (): AsyncAction => async (\n\tdispatch,\n\tgetState,\n\t{ player }\n) => {\n\tif (!PLAYER_TIMER) {\n\t\tconsole.debug(\"[Room] Watching player...\");\n\t\t_scheduleTimer(dispatch, getState, player, 250);\n\t}\n};\n\nconst _unwatchPlayer = (): AsyncAction => async (\n\tdispatch,\n\tgetState,\n\t{ player }\n) => {\n\tif (PLAYER_TIMER) {\n\t\tconsole.debug(\"[Room] Unwatching player...\");\n\t\tclearTimeout(PLAYER_TIMER);\n\t\tPLAYER_TIMER = null;\n\t}\n\tawait player.stop();\n};\n\n// Don't use setInterval because a step could be triggered before previous one terminated\nconst _scheduleTimer = (\n\tdispatch: Dispatch,\n\tgetState: () => RootState,\n\tplayer: Player,\n\tms: number\n) => {\n\tPLAYER_TIMER = setTimeout(async () => {\n\t\tconst {\n\t\t\troom: { queue, tracks },\n\t\t\tmedias: { medias }\n\t\t} = getState();\n\t\tif (queue) {\n\t\t\tconst { playing, playmode, position } = queue;\n\n\t\t\t// Detect and apply change to queue and player\n\t\t\tconst nextTrackIndex = computePlayerNextPosition(\n\t\t\t\tplaying,\n\t\t\t\tplayer.isPlaying(),\n\t\t\t\tplayer.getPlayingTrackID(),\n\t\t\t\tplayer.getPlayingTrackPosition() % tracks.length,\n\t\t\t\ttracks,\n\t\t\t\tposition\n\t\t\t);\n\n\t\t\tif (nextTrackIndex >= 0) {\n\t\t\t\tconst nextAccess = tracks[nextTrackIndex];\n\t\t\t\tconst nextTrack =\n\t\t\t\t\tmedias[nextAccess.provider][nextAccess.type][nextAccess.id];\n\t\t\t\tconsole.debug(\"Detected play change...\", {\n\t\t\t\t\tnextTrack,\n\t\t\t\t\tnextTrackIndex\n\t\t\t\t});\n\n\t\t\t\ttry {\n\t\t\t\t\tconst [color] = await Promise.all([\n\t\t\t\t\t\tpickColor(nextTrack.album.picture_small),\n\t\t\t\t\t\tplayer.play(\n\t\t\t\t\t\t\tnextTrackIndex,\n\t\t\t\t\t\t\tnextTrack.id,\n\t\t\t\t\t\t\tnextTrack.preview,\n\t\t\t\t\t\t\t0,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tplaymode: playmode\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t)\n\t\t\t\t\t]);\n\t\t\t\t\tdispatch(displayMediaInfo(nextTrack));\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t\tcolor,\n\t\t\t\t\t\t\tqueue: {\n\t\t\t\t\t\t\t\t...queue,\n\t\t\t\t\t\t\t\tposition: nextTrackIndex\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tdispatch(displayError(extractErrorMessage(err)));\n\t\t\t\t}\n\t\t\t} else if (!playing) {\n\t\t\t\tplayer.stop();\n\t\t\t}\n\t\t}\n\n\t\t// Reschedule time\n\t\t// console.debug(\"[Room] Rescheduling\");\n\t\t_scheduleTimer(dispatch, getState, player, ms);\n\t}, ms);\n};\n","import { AsyncAction, trySomething } from \".\";\nimport { lockRoom } from \"./room\";\nimport { displayError } from \"./messages\";\nimport { setRoom } from \"../reducers/room\";\nimport { generateRandomPosition } from \"../utils/player\";\n\n// ------------------------------------------------------------------\n\nexport const startPlayer = ({\n\tpropagate\n}: {\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, queue, tracks }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (queue.playing) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Player] Starting...\", { propagate });\n\t\t\t\tif (!propagate) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t\tqueue: {\n\t\t\t\t\t\t\t\t...queue,\n\t\t\t\t\t\t\t\tplaying: true,\n\t\t\t\t\t\t\t\tposition:\n\t\t\t\t\t\t\t\t\tqueue.playmode === \"shuffle\"\n\t\t\t\t\t\t\t\t\t\t? generateRandomPosition() %\n\t\t\t\t\t\t\t\t\t\t  tracks.length\n\t\t\t\t\t\t\t\t\t\t: queue.position\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t...queue,\n\t\t\t\t\tplaying: true\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const stopPlayer = ({\n\tpropagate\n}: {\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, queue }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (!queue.playing) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Player] Stopping...\", { propagate });\n\t\t\t\tif (!propagate) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t\tqueue: {\n\t\t\t\t\t\t\t\t...queue,\n\t\t\t\t\t\t\t\tplaying: false\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t...queue,\n\t\t\t\t\tplaying: false\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n","import { AsyncAction, trySomething } from \".\";\nimport { displayError } from \"./messages\";\nimport { lockRoom } from \"./room\";\nimport { MediaAccess, findContextFromTrackIndex } from \"../utils/medias\";\nimport { createQueueMerging, createQueueRemoving } from \"../utils/rooms\";\nimport { generateRandomPosition } from \"../utils/player\";\nimport { setRoom } from \"../reducers/room\";\n\n// ------------------------------------------------------------------\n\nexport const clearQueue = ({\n\tpropagate\n}: {\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, queue }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Queue] Clearing...\");\n\t\t\t\tif (!propagate) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t\tqueue: {\n\t\t\t\t\t\t\t\t...queue,\n\t\t\t\t\t\t\t\tplaying: false,\n\t\t\t\t\t\t\t\tmedias: {},\n\t\t\t\t\t\t\t\tposition: 0\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t...queue,\n\t\t\t\t\tmedias: {},\n\t\t\t\t\tplaying: false,\n\t\t\t\t\tposition: 0\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const appendToQueue = (newMedias: MediaAccess[]): AsyncAction => (\n\tdispatch,\n\tgetState\n) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, queue, medias: oldMedias }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (newMedias.length === 0) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Queue] Appending...\", {\n\t\t\t\t\tnewMedias\n\t\t\t\t});\n\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t...queue,\n\t\t\t\t\tmedias: createQueueMerging(oldMedias, newMedias)\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\n// TODO: DECOMPLEXIFY removeFromQueue\nexport const removeFromQueue = ({\n\tposition: removedTrackIndex\n}: {\n\tposition: number;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tmedias: { medias: allMedias },\n\t\t\t\t\troom: { _fbRoom, queue, medias: oldMedias, tracks }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tconst {\n\t\t\t\t\tmediaFirstTrackIndex: removedMediaFirstTrackIndex,\n\t\t\t\t\tmediaIndex: removedMediaIndex,\n\t\t\t\t\tmediaSize: removedTrackCount\n\t\t\t\t} = findContextFromTrackIndex(\n\t\t\t\t\toldMedias,\n\t\t\t\t\tremovedTrackIndex,\n\t\t\t\t\tallMedias\n\t\t\t\t);\n\t\t\t\tif (removedMediaIndex < 0) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconst playingTrackIndex = queue.position;\n\t\t\t\tconsole.debug(\"[Queue] Removing...\", {\n\t\t\t\t\tplayingTrackIndex,\n\t\t\t\t\tremovedMediaIndex,\n\t\t\t\t\tremovedTrackCount,\n\t\t\t\t\tremovedTrackIndex,\n\t\t\t\t\tremovedMediaFirstTrackIndex\n\t\t\t\t});\n\t\t\t\tconst newMedias = createQueueRemoving(\n\t\t\t\t\toldMedias,\n\t\t\t\t\tremovedMediaIndex,\n\t\t\t\t\t1\n\t\t\t\t);\n\t\t\t\tif (Object.keys(newMedias).length === 0) {\n\t\t\t\t\tconsole.debug(\"[Queue] Removing last...\");\n\t\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t\t...queue,\n\t\t\t\t\t\tmedias: {},\n\t\t\t\t\t\tplaying: false,\n\t\t\t\t\t\tposition: 0\n\t\t\t\t\t});\n\t\t\t\t} else if (playingTrackIndex < removedTrackIndex) {\n\t\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t\t...queue,\n\t\t\t\t\t\tmedias: newMedias\n\t\t\t\t\t});\n\t\t\t\t} else if (\n\t\t\t\t\tplayingTrackIndex >= removedMediaFirstTrackIndex &&\n\t\t\t\t\tplayingTrackIndex <\n\t\t\t\t\t\tremovedMediaFirstTrackIndex + removedTrackCount\n\t\t\t\t) {\n\t\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t\t...queue,\n\t\t\t\t\t\tmedias: newMedias,\n\t\t\t\t\t\tposition:\n\t\t\t\t\t\t\tremovedMediaFirstTrackIndex + removedTrackCount ===\n\t\t\t\t\t\t\ttracks.length\n\t\t\t\t\t\t\t\t? removedMediaFirstTrackIndex - 1\n\t\t\t\t\t\t\t\t: removedMediaFirstTrackIndex\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t\t...queue,\n\t\t\t\t\t\tmedias: newMedias,\n\t\t\t\t\t\tposition: playingTrackIndex - removedTrackCount\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const setQueuePosition = ({\n\tposition: newPosition,\n\tpropagate\n}: {\n\tposition: number;\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, queue }\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !queue) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tconst oldPosition = queue.position;\n\t\t\t\tif (oldPosition === newPosition) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[Queue] Setting position...\", {\n\t\t\t\t\toldPosition,\n\t\t\t\t\tnewPosition,\n\t\t\t\t\tpropagate\n\t\t\t\t});\n\t\t\t\tif (!propagate) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tsetRoom({\n\t\t\t\t\t\t\tqueue: {\n\t\t\t\t\t\t\t\t...queue,\n\t\t\t\t\t\t\t\tplaying: true,\n\t\t\t\t\t\t\t\tposition: newPosition\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tawait _fbRoom.updateQueue({\n\t\t\t\t\t...queue,\n\t\t\t\t\tplaying: true, // Important: user setting queue position will start the play\n\t\t\t\t\tposition: newPosition\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const moveToPreviousTrack = ({\n\tpropagate\n}: {\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { queue, tracks }\n\t\t\t\t} = getState();\n\t\t\t\tif (!queue || tracks.length === 0) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tdispatch(\n\t\t\t\t\tsetQueuePosition({\n\t\t\t\t\t\tposition:\n\t\t\t\t\t\t\tqueue.position > 0\n\t\t\t\t\t\t\t\t? queue.position - 1\n\t\t\t\t\t\t\t\t: tracks.length - 1,\n\t\t\t\t\t\tpropagate\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const moveToNextTrack = ({\n\tpropagate\n}: {\n\tpropagate: boolean;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { queue, tracks }\n\t\t\t\t} = getState();\n\t\t\t\tif (!queue || tracks.length === 0) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tdispatch(\n\t\t\t\t\tsetQueuePosition({\n\t\t\t\t\t\tposition:\n\t\t\t\t\t\t\tqueue.playmode === \"shuffle\"\n\t\t\t\t\t\t\t\t? generateRandomPosition() % tracks.length\n\t\t\t\t\t\t\t\t: (queue.position + 1) % tracks.length,\n\t\t\t\t\t\tpropagate\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n","import { RootState } from \"../reducers\";\nimport { PlayMode } from \"../utils/rooms\";\n\n// ------------------------------------------------------------------\n\nexport const selectQueuePosition = (state: RootState): number =>\n\tstate.room.queue?.position || 0;\n\nexport const selectRoomPlaymode = (state: RootState): PlayMode =>\n\tstate.room.queue?.playmode || \"default\";\n\nexport const isRoomPlaying = (state: RootState): boolean =>\n\tstate.room.queue?.playing || false;\n","import React, { FC, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\n//\nimport { QueueList, EmptyQueueList } from \"./QueueList\";\nimport { Dispatch } from \"../../actions\";\nimport { RootState } from \"../../reducers\";\nimport { selectTracks } from \"../../selectors/medias\";\nimport { Track } from \"../../utils/medias\";\nimport { startPlayer, stopPlayer } from \"../../actions/player\";\nimport { setQueuePosition, removeFromQueue } from \"../../actions/queue\";\nimport { openModal } from \"../../reducers/modals\";\nimport { selectQueuePosition } from \"../../selectors/queue\";\nimport { isRoomLoaded, isRoomLocked } from \"../../selectors/room\";\nimport { isRoomPlaying } from \"../../selectors/queue\";\nimport \"./Queue.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Queue: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\n\tconst loaded = useSelector<RootState, boolean>(isRoomLoaded);\n\tconst locked = useSelector<RootState, boolean>(isRoomLocked);\n\tconst playing = useSelector<RootState, boolean>(isRoomPlaying);\n\tconst playingIndex = useSelector<RootState, number>(selectQueuePosition);\n\tconst tracks = useSelector<RootState, Array<Track | null>>(selectTracks);\n\n\tconst onPlay = useCallback(\n\t\t(position: number) => {\n\t\t\tdispatch(startPlayer({ propagate: true }));\n\t\t\tdispatch(setQueuePosition({ position, propagate: true }));\n\t\t},\n\t\t[dispatch]\n\t);\n\n\tconst onRemove = useCallback(\n\t\t(position: number) => dispatch(removeFromQueue({ position })),\n\t\t[dispatch]\n\t);\n\n\tconst onSearch = useCallback(\n\t\t() => dispatch(openModal({ type: \"Room/Search\", props: null })),\n\t\t[dispatch]\n\t);\n\n\tconst onStop = useCallback(\n\t\t() => dispatch(stopPlayer({ propagate: true })),\n\t\t[dispatch]\n\t);\n\n\treturn (\n\t\t<div className=\"Queue\">\n\t\t\t{tracks.length > 0 ? (\n\t\t\t\t<QueueList\n\t\t\t\t\tlocked={locked}\n\t\t\t\t\ttracks={tracks}\n\t\t\t\t\tplaying={playing}\n\t\t\t\t\tplayingIndex={playingIndex}\n\t\t\t\t\tonPlay={onPlay}\n\t\t\t\t\tonRemove={onRemove}\n\t\t\t\t\tonStop={onStop}\n\t\t\t\t/>\n\t\t\t) : (\n\t\t\t\t<EmptyQueueList\n\t\t\t\t\tloaded={loaded}\n\t\t\t\t\tlocked={locked}\n\t\t\t\t\tonSearch={onSearch}\n\t\t\t\t/>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import React, { FC, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\nimport classNames from \"classnames\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { Dispatch } from \"../../actions\";\nimport { RootState } from \"../../reducers\";\nimport { isRoomLocked } from \"../../selectors/room\";\nimport { isRoomPlaying, selectRoomPlaymode } from \"../../selectors/queue\";\nimport { stopPlayer, startPlayer } from \"../../actions/player\";\nimport { moveToPreviousTrack, moveToNextTrack } from \"../../actions/queue\";\nimport { PlayMode } from \"../../utils/rooms\";\nimport { selectTracksCount } from \"../../selectors/medias\";\nimport \"./AudioPlayerControls.scss\";\n\n// ------------------------------------------------------------------\n\nexport const AudioPlayerControls: FC<{\n\tbigPlayer: boolean;\n\tclassName?: string;\n\tpropagate: boolean;\n}> = ({ bigPlayer, className, propagate }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\n\tconst { t } = useTranslation();\n\n\tconst locked = useSelector<RootState, boolean>(isRoomLocked);\n\n\tconst playing = useSelector<RootState, boolean>(isRoomPlaying);\n\n\tconst tracksCount = useSelector<RootState, number>(selectTracksCount);\n\n\tconst playmode = useSelector<RootState, PlayMode>(selectRoomPlaymode);\n\n\tconst onMoveBackward = useCallback(\n\t\t() => dispatch(moveToPreviousTrack({ propagate })),\n\t\t[dispatch, propagate]\n\t);\n\n\tconst onMoveForward = useCallback(\n\t\t() => dispatch(moveToNextTrack({ propagate })),\n\t\t[dispatch, propagate]\n\t);\n\n\tconst onPlay = useCallback(() => dispatch(startPlayer({ propagate })), [\n\t\tdispatch,\n\t\tpropagate\n\t]);\n\n\tconst onStop = useCallback(() => dispatch(stopPlayer({ propagate })), [\n\t\tdispatch,\n\t\tpropagate\n\t]);\n\n\treturn (\n\t\t<div className={classNames(\"AudioPlayerControls\", className)}>\n\t\t\t<div className=\"Control\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={\n\t\t\t\t\t\tlocked || tracksCount === 0 || playmode === \"shuffle\"\n\t\t\t\t\t}\n\t\t\t\t\ticon=\"step-backward\"\n\t\t\t\t\tonClick={onMoveBackward}\n\t\t\t\t\tsize={\"M\"}\n\t\t\t\t\ttitle={t(\"player.backward\")}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"Control\">\n\t\t\t\t{!playing ? (\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={locked || tracksCount === 0}\n\t\t\t\t\t\ticon=\"play\"\n\t\t\t\t\t\tonClick={onPlay}\n\t\t\t\t\t\tsize={bigPlayer ? \"L\" : \"M\"}\n\t\t\t\t\t\ttitle={t(\"player.play\")}\n\t\t\t\t\t/>\n\t\t\t\t) : (\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={locked || tracksCount === 0}\n\t\t\t\t\t\ticon=\"pause\"\n\t\t\t\t\t\tonClick={onStop}\n\t\t\t\t\t\tsize={bigPlayer ? \"L\" : \"M\"}\n\t\t\t\t\t\ttitle={t(\"player.stop\")}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t\t<div className=\"Control\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={locked || tracksCount === 0}\n\t\t\t\t\ticon=\"step-forward\"\n\t\t\t\t\tonClick={onMoveForward}\n\t\t\t\t\tsize={\"M\"}\n\t\t\t\t\ttitle={t(\"player.forward\")}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import React, { FC, useEffect, useState } from \"react\";\nimport { useSelector } from \"react-redux\";\n//\nimport { QUEUE_PLAYER } from \"../../utils/player\";\nimport { RootState } from \"../../reducers\";\nimport { isRoomPlaying } from \"../../selectors/queue\";\nimport \"./Progress.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Progress: FC = () => {\n\tconst [value, setValue] = useState<number>(0);\n\tconst playing = useSelector<RootState, boolean>(isRoomPlaying);\n\n\tuseEffect(() => {\n\t\tlet timer: number = 0;\n\n\t\tif (playing) {\n\t\t\tconst step = () => {\n\t\t\t\tsetValue(\n\t\t\t\t\tMath.floor(QUEUE_PLAYER.getPlayingTrackPercent() * 1000)\n\t\t\t\t);\n\t\t\t\ttimer = requestAnimationFrame(step);\n\t\t\t};\n\t\t\ttimer = requestAnimationFrame(step);\n\t\t}\n\n\t\treturn () => {\n\t\t\tcancelAnimationFrame(timer);\n\t\t};\n\t}, [playing]);\n\n\treturn (\n\t\t<div className=\"Progress\">\n\t\t\t<progress max={1000} value={playing ? value : 0} />\n\t\t</div>\n\t);\n};\n","import React, { FC, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { Dispatch } from \"../../actions\";\nimport { RootState } from \"../../reducers\";\nimport { isRoomLocked } from \"../../selectors/room\";\nimport { lockRoom } from \"../../actions/room\";\nimport { stopPlayer } from \"../../actions/player\";\nimport { confirmModal } from \"../../actions/modals\";\nimport { openModal } from \"../../reducers/modals\";\nimport { clearQueue } from \"../../actions/queue\";\nimport \"./QueueControls.scss\";\n\n// ------------------------------------------------------------------\n\nexport const QueueControls: FC<{\n\tpropagate: boolean;\n\tonHelp?: () => void;\n}> = ({ propagate, onHelp }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { t } = useTranslation();\n\tconst tracksCount = useSelector<RootState, number>(\n\t\tstate => state.room.medias.length\n\t);\n\tconst locked = useSelector<RootState, boolean>(isRoomLocked);\n\tconst onClear = useCallback(() => {\n\t\tdispatch(\n\t\t\tconfirmModal(t(\"rooms.confirm_clear\"), () => {\n\t\t\t\tdispatch(clearQueue({ propagate }));\n\t\t\t\tdispatch(stopPlayer({ propagate }));\n\t\t\t})\n\t\t);\n\t}, [dispatch, t, propagate]);\n\n\tconst onLock = useCallback(() => {\n\t\tdispatch(\n\t\t\tconfirmModal(t(\"rooms.confirm_lock\"), () => {\n\t\t\t\tdispatch(lockRoom());\n\t\t\t})\n\t\t);\n\t}, [dispatch, t]);\n\n\tconst onUnlock = useCallback(() => {\n\t\tdispatch(openModal({ type: \"Room/Unlock\", props: {} }));\n\t}, [dispatch]);\n\n\tconst onSearch = useCallback(\n\t\t() => dispatch(openModal({ type: \"Room/Search\", props: null })),\n\t\t[dispatch]\n\t);\n\n\treturn (\n\t\t<div className=\"QueueControls\">\n\t\t\t{onHelp ? (\n\t\t\t\t<div className=\"Control\">\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"question-circle\"\n\t\t\t\t\t\ttitle={t(\"rooms.tutorial\")}\n\t\t\t\t\t\tonClick={onHelp}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t) : null}\n\t\t\t<div className=\"Control\">\n\t\t\t\t{locked ? (\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"lock\"\n\t\t\t\t\t\tonClick={onUnlock}\n\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\ttitle={t(\"rooms.locked\")}\n\t\t\t\t\t/>\n\t\t\t\t) : (\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"unlock\"\n\t\t\t\t\t\tonClick={onLock}\n\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\ttitle={t(\"rooms.unlocked\")}\n\t\t\t\t\t/>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t\t<div className=\"Control\">\n\t\t\t\t<IconButton\n\t\t\t\t\tonClick={onSearch}\n\t\t\t\t\ticon=\"search\"\n\t\t\t\t\ttitle={t(\"medias.search\")}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"Control\">\n\t\t\t\t<IconButton\n\t\t\t\t\tdisabled={locked || tracksCount === 0}\n\t\t\t\t\tonClick={onClear}\n\t\t\t\t\ticon=\"trash\"\n\t\t\t\t\ttitle={t(\"rooms.clear\")}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { AudioPlayerControls } from \"./AudioPlayerControls\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { Progress } from \"./Progress\";\nimport { QueueControls } from \"./QueueControls\";\nimport \"./RoomControls.scss\";\n\n// ------------------------------------------------------------------\n\nexport const RoomControls: FC<{\n\textended: boolean;\n\tpropagate: boolean;\n\tonHelp?: () => void;\n}> = ({ extended, propagate, onHelp }) => {\n\tconst { t } = useTranslation();\n\n\treturn (\n\t\t<div className=\"RoomControls\">\n\t\t\t{extended ? (\n\t\t\t\t<div className=\"ControlsInner extended\">\n\t\t\t\t\t<AudioPlayerControls\n\t\t\t\t\t\tpropagate={propagate}\n\t\t\t\t\t\tbigPlayer={true}\n\t\t\t\t\t/>\n\t\t\t\t\t<Progress />\n\t\t\t\t\t<QueueControls propagate={propagate} onHelp={onHelp} />\n\t\t\t\t</div>\n\t\t\t) : (\n\t\t\t\t<div className=\"ControlsInner compact\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"question-circle\"\n\t\t\t\t\t\t\ttitle={t(\"rooms.tutorial\")}\n\t\t\t\t\t\t\tonClick={onHelp}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<AudioPlayerControls\n\t\t\t\t\t\tclassName=\"ControlsSet\"\n\t\t\t\t\t\tpropagate={propagate}\n\t\t\t\t\t\tbigPlayer={false}\n\t\t\t\t\t/>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"diamond\"\n\t\t\t\t\t\t\ttitle={t(\"...\")}\n\t\t\t\t\t\t\tonClick={void 0 /* TODO */}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\t\t</div>\n\t);\n};\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport {\n\tSeaBattleBoatData,\n\tAngleToDirection\n} from \"../../utils/games/seabattle\";\nimport { SeaBattleMovementIconMappings } from \"../../utils/games/seabattle/mappings\";\n\n// ------------------------------------------------------------------\n\nexport const SeaBattlePlayerControls: FC<{\n\tboat?: SeaBattleBoatData;\n\tdisabled?: boolean;\n\tonMoveBackward: () => void;\n\tonMoveForward: () => void;\n\tonRotateLeft: () => void;\n\tonRotateRight: () => void;\n}> = ({\n\tboat,\n\tdisabled = false,\n\tonMoveBackward,\n\tonMoveForward,\n\tonRotateLeft,\n\tonRotateRight\n}) => {\n\tconst { t } = useTranslation();\n\n\treturn (\n\t\t<div className=\"SeaBattlePlayerControls SeaBattleControls\">\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon=\"rotate-left\"\n\t\t\t\ttitle={t(\"games.seabattle.turn_left\")}\n\t\t\t\tonClick={onRotateLeft}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={\n\t\t\t\t\tboat\n\t\t\t\t\t\t? SeaBattleMovementIconMappings[\n\t\t\t\t\t\t\t\tAngleToDirection(boat.angle)\n\t\t\t\t\t\t  ].move_backward\n\t\t\t\t\t\t: \"arrow-down\"\n\t\t\t\t}\n\t\t\t\ttitle={t(\"games.seabattle.move_backward\")}\n\t\t\t\tonClick={onMoveBackward}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon={\n\t\t\t\t\tboat\n\t\t\t\t\t\t? SeaBattleMovementIconMappings[\n\t\t\t\t\t\t\t\tAngleToDirection(boat.angle)\n\t\t\t\t\t\t  ].move_forward\n\t\t\t\t\t\t: \"arrow-up\"\n\t\t\t\t}\n\t\t\t\ttitle={t(\"games.seabattle.move_forward\")}\n\t\t\t\tonClick={onMoveForward}\n\t\t\t/>\n\t\t\t<IconButton\n\t\t\t\tdisabled={disabled}\n\t\t\t\ticon=\"rotate-right\"\n\t\t\t\ttitle={t(\"games.seabattle.turn_right\")}\n\t\t\t\tonClick={onRotateRight}\n\t\t\t/>\n\t\t</div>\n\t);\n};\n","import React, { FC } from \"react\";\nimport {\n\tSeaBattleAssetType,\n\tSeaBattleCellData,\n\tGRID_CELL_UNIT_SIZE,\n\tSeaBattlePosition\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const Asset: FC<{\n\tclassName?: string;\n\tonClick?: () => void;\n\tposition: SeaBattlePosition;\n\tstopPropagation?: boolean;\n\ttransform?: string;\n\ttype: SeaBattleAssetType;\n\tvisibility?: string;\n}> = ({\n\tclassName,\n\tonClick,\n\tposition,\n\tstopPropagation = false,\n\ttransform,\n\ttype,\n\tvisibility\n}) => (\n\t<use\n\t\tonClick={e => {\n\t\t\tif (stopPropagation) {\n\t\t\t\te.stopPropagation();\n\t\t\t}\n\t\t\tif (onClick) {\n\t\t\t\tonClick();\n\t\t\t}\n\t\t}}\n\t\tclassName={className}\n\t\thref={`#${type}`}\n\t\ttransform={transform}\n\t\tvisibility={visibility}\n\t\t{...position}\n\t/>\n);\n\n// ------------------------------------------------------------------\n\nexport const Cell: FC<SeaBattleCellData> = ({ type, visibility, ...asset }) => (\n\t<Asset\n\t\tclassName=\"SeaBattleCell\"\n\t\ttype={type}\n\t\tvisibility={visibility}\n\t\tposition={{\n\t\t\tx: asset.position.x * GRID_CELL_UNIT_SIZE,\n\t\t\ty: asset.position.y * GRID_CELL_UNIT_SIZE\n\t\t}}\n\t/>\n);\n","import React, { FC } from \"react\";\n//\nimport { Asset } from \"./Assets\";\nimport {\n\tSeaBattleWeaponData,\n\tSeaBattleWeaponsOffsetMappings,\n\tGRID_CELL_UNIT_SIZE\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const Weapon: FC<SeaBattleWeaponData> = ({ type, ...asset }) => (\n\t<Asset\n\t\tclassName=\"SeaBattleWeapon\"\n\t\ttype={type}\n\t\tposition={{\n\t\t\tx:\n\t\t\t\tSeaBattleWeaponsOffsetMappings[type].x +\n\t\t\t\tasset.position.x * GRID_CELL_UNIT_SIZE,\n\t\t\ty:\n\t\t\t\tSeaBattleWeaponsOffsetMappings[type].y +\n\t\t\t\tasset.position.y * GRID_CELL_UNIT_SIZE\n\t\t}}\n\t/>\n);\n// ------------------------------------------------------------------\n\nexport const Weapons = ({ weapons }: { weapons: SeaBattleWeaponData[] }) => {\n\treturn (\n\t\t<>\n\t\t\t{weapons.map((weapon, index) => (\n\t\t\t\t<Weapon key={index} {...weapon} />\n\t\t\t))}\n\t\t</>\n\t);\n};\n","import React, { FC } from \"react\";\n//\nimport { Asset } from \"./Assets\";\nimport {\n\tSeaBattleHitData,\n\tGRID_CELL_UNIT_SIZE,\n\tHitsOffsetInCellMappings\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const Hit: FC<SeaBattleHitData> = ({ type, ...asset }) => (\n\t<Asset\n\t\tclassName=\"SeaBattleHit\"\n\t\ttype={type}\n\t\tposition={{\n\t\t\tx:\n\t\t\t\tHitsOffsetInCellMappings[type].x +\n\t\t\t\tasset.position.x * GRID_CELL_UNIT_SIZE,\n\t\t\ty:\n\t\t\t\tHitsOffsetInCellMappings[type].y +\n\t\t\t\tasset.position.y * GRID_CELL_UNIT_SIZE\n\t\t}}\n\t/>\n);\n\n// ------------------------------------------------------------------\n\nexport const Hits: FC<{ hits: SeaBattleHitData[] }> = ({ hits }) => {\n\treturn (\n\t\t<>\n\t\t\t{hits.map((hit, index) => (\n\t\t\t\t<Hit key={index} {...hit} />\n\t\t\t))}\n\t\t</>\n\t);\n};\n","import React, { FC } from \"react\";\nimport classNames from \"classnames\";\n//\nimport { Asset } from \"./Assets\";\nimport {\n\tSeaBattleBoatData,\n\tGRID_CELL_UNIT_SIZE,\n\tBoatsOffsetMappings,\n\tHitsOffsetInBoatMappings\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const Boat: FC<{\n\tboat: SeaBattleBoatData;\n\thideFleet: boolean;\n\tonClick?: () => void;\n\tselected: boolean;\n}> = ({\n\tboat: { angle, hits, type, status = \"ok\", ...asset },\n\thideFleet,\n\tonClick,\n\tselected\n}) => (\n\t<g\n\t\tclassName=\"SeaBattleBoatAnim\"\n\t\ttransform={`translate(${\n\t\t\tBoatsOffsetMappings[type].x + asset.position.x * GRID_CELL_UNIT_SIZE\n\t\t}, ${\n\t\t\tBoatsOffsetMappings[type].y + asset.position.y * GRID_CELL_UNIT_SIZE\n\t\t}) rotate(${angle * 90}, 14, 14)`}>\n\t\t{!hideFleet || status === \"ko\" ? (\n\t\t\t<Asset\n\t\t\t\tclassName={classNames(\"SeaBattleBoat\", status, {\n\t\t\t\t\tclickable: !!onClick,\n\t\t\t\t\tselected\n\t\t\t\t})}\n\t\t\t\tonClick={onClick}\n\t\t\t\tstopPropagation={true}\n\t\t\t\tposition={{\n\t\t\t\t\tx: 0,\n\t\t\t\t\ty: 0\n\t\t\t\t}}\n\t\t\t\ttype={type}\n\t\t\t/>\n\t\t) : null}\n\t\t{hits.map((hit, index) => (\n\t\t\t<Asset\n\t\t\t\tkey={index}\n\t\t\t\tclassName=\"SeaBattleHit\"\n\t\t\t\ttype={hit.type}\n\t\t\t\tposition={{\n\t\t\t\t\tx:\n\t\t\t\t\t\tHitsOffsetInBoatMappings[hit.type].x +\n\t\t\t\t\t\thit.position.x * GRID_CELL_UNIT_SIZE,\n\t\t\t\t\ty:\n\t\t\t\t\t\tHitsOffsetInBoatMappings[hit.type].y +\n\t\t\t\t\t\thit.position.y * GRID_CELL_UNIT_SIZE\n\t\t\t\t}}\n\t\t\t/>\n\t\t))}\n\t</g>\n);\n","import React, { FC } from \"react\";\n//\nimport { Boat } from \"./Boats\";\nimport { SeaBattleBoatData } from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const Fleet: FC<{\n\tfleet: SeaBattleBoatData[];\n\thideFleet: boolean;\n\tselectedBoatIndex?: number;\n\tonSelectBoatIndex?: (index: number) => void;\n}> = ({ fleet, hideFleet, selectedBoatIndex, onSelectBoatIndex }) => (\n\t<>\n\t\t{fleet.map((boat, index) => (\n\t\t\t<Boat\n\t\t\t\tkey={index}\n\t\t\t\tboat={boat}\n\t\t\t\thideFleet={hideFleet}\n\t\t\t\tonClick={\n\t\t\t\t\tonSelectBoatIndex && boat.status === \"ok\"\n\t\t\t\t\t\t? () => {\n\t\t\t\t\t\t\t\tconsole.debug(\"[SeaBattle] Selected boat\", {\n\t\t\t\t\t\t\t\t\tboat\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tonSelectBoatIndex(\n\t\t\t\t\t\t\t\t\tindex === selectedBoatIndex ? -1 : index\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t  }\n\t\t\t\t\t\t: void 0\n\t\t\t\t}\n\t\t\t\tselected={index === selectedBoatIndex}\n\t\t\t/>\n\t\t))}\n\t</>\n);\n","import React, { FC } from \"react\";\nimport { GRID_CELL_UNIT_SIZE } from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nconst SEA_COLOR1 = \"#a6dbf8\";\nconst SEA_COLOR2 = \"#50a3db\";\n\n// ------------------------------------------------------------------\n\nexport const BattleAssets: FC = () => (\n\t<defs>\n\t\t<circle id=\"hitted\" cx=\"10\" cy=\"10\" r=\"8\" fill=\"#e52524\" />\n\t\t<circle id=\"missed\" cx=\"10\" cy=\"10\" r=\"8\" fill=\"#fff\" />\n\t\t<polygon\n\t\t\tid=\"crossed\"\n\t\t\tpoints=\"11.98 8.08 20.07 0 24 3.9 15.92 11.98 24 20.07 20.07 24 11.98 15.92 3.9 24 0 20.07 8.08 11.98 0 3.9 3.9 0 11.98 8.08\"\n\t\t\tfillRule=\"evenodd\"\n\t\t/>\n\t\t<path id=\"cell\" d=\"M0,0V40H40V0ZM36,36H4V4H36Z\" />\n\t\t<use id=\"cell-selected\" href=\"#cell\" fill=\"#FF0\" />\n\t\t<use id=\"cell-selection\" href=\"#cell\" fill=\"#555\" />\n\t\t<g id=\"cell-crossed\">\n\t\t\t<use href=\"#cell\" fill=\"#e52524\" />\n\t\t\t<use href=\"#crossed\" fill=\"#e52524\" x=\"8\" y=\"8\" />\n\t\t</g>\n\t\t<path\n\t\t\tid=\"bullet1\"\n\t\t\td=\"M16,4C16,8.46,0,8,0,8V0S16-.46,16,4Z\"\n\t\t\tfill=\"#afafaf\"\n\t\t/>\n\t\t<path\n\t\t\tid=\"bullet2\"\n\t\t\td=\"M16,4C16,8.46,0,8,0,8V0S16-.46,16,4Z\"\n\t\t\tfill=\"#676766\"\n\t\t/>\n\t\t<path\n\t\t\tid=\"bullet3\"\n\t\t\td=\"M16,4C16,8.46,0,8,0,8V0S16-.46,16,4Z\"\n\t\t\tfill=\"#000000\"\n\t\t/>\n\t\t<path\n\t\t\tid=\"mine\"\n\t\t\td=\"M16,9V7H13.77a5.92,5.92,0,0,0-1-2.41L14.35,3,13,1.65,11.39,3.23A5.92,5.92,0,0,0,9,2.23V0H7V2.23a5.92,5.92,0,0,0-2.41,1L3,1.65,1.65,3,3.23,4.61A5.92,5.92,0,0,0,2.23,7H0V9H2.23a5.92,5.92,0,0,0,1,2.41L1.65,13,3,14.35l1.58-1.58a5.92,5.92,0,0,0,2.41,1V16H9V13.77a5.92,5.92,0,0,0,2.41-1L13,14.35,14.35,13l-1.58-1.58a5.92,5.92,0,0,0,1-2.41Z\"\n\t\t\tfill=\"#000000\"\n\t\t/>\n\t\t<path id=\"boat1\" d=\"M28,14C28,19,14,28,14,28H0V0H14S28,9.05,28,14Z\" />\n\t\t<path\n\t\t\tid=\"boat2\"\n\t\t\td=\"M68,14C68,19,51.89,28,51.89,28H0V0H51.89S68,9.05,68,14Z\"\n\t\t/>\n\t\t<path\n\t\t\tid=\"boat3\"\n\t\t\td=\"M108,14C108,19,91.24,28,91.24,28H0V0H91.24S108,9.05,108,14Z\"\n\t\t/>\n\t\t<pattern\n\t\t\tid=\"sea-grid\"\n\t\t\twidth=\"80\"\n\t\t\theight=\"80\"\n\t\t\tpatternUnits=\"userSpaceOnUse\">\n\t\t\t<g>\n\t\t\t\t<rect\n\t\t\t\t\twidth={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\theight={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\tfill={SEA_COLOR1}\n\t\t\t\t\tx=\"0\"\n\t\t\t\t\ty=\"0\"\n\t\t\t\t/>\n\t\t\t\t<rect\n\t\t\t\t\twidth={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\theight={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\tfill={SEA_COLOR2}\n\t\t\t\t\tx={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\ty=\"0\"\n\t\t\t\t/>\n\t\t\t\t<rect\n\t\t\t\t\twidth={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\theight={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\tfill={SEA_COLOR2}\n\t\t\t\t\tx=\"0\"\n\t\t\t\t\ty={GRID_CELL_UNIT_SIZE}\n\t\t\t\t/>\n\t\t\t\t<rect\n\t\t\t\t\twidth={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\theight={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\tfill={SEA_COLOR1}\n\t\t\t\t\tx={GRID_CELL_UNIT_SIZE}\n\t\t\t\t\ty={GRID_CELL_UNIT_SIZE}\n\t\t\t\t/>\n\t\t\t</g>\n\t\t</pattern>\n\t</defs>\n);\n","import { SeaBattlePosition, GRID_CELL_UNIT_SIZE } from \"./games/seabattle\";\n\nexport const getSVGPosition = (\n\tsvg: SVGSVGElement,\n\t{ x, y }: { x: number; y: number }\n) => {\n\tvar pt = svg.createSVGPoint();\n\tpt.x = x;\n\tpt.y = y;\n\tpt = pt.matrixTransform(svg.getScreenCTM()!.inverse());\n\treturn { tx: pt.x, ty: pt.y };\n};\n\nexport const getSVGNormalizedPosition = (\n\tsvg: SVGSVGElement,\n\tposition: SeaBattlePosition\n): SeaBattlePosition => {\n\tconst { tx, ty } = getSVGPosition(svg, position);\n\treturn {\n\t\tx: Math.floor(tx / GRID_CELL_UNIT_SIZE),\n\t\ty: Math.floor(ty / GRID_CELL_UNIT_SIZE)\n\t};\n};\n","import React, { FC, useCallback, useRef, useState } from \"react\";\nimport { Cell } from \"./Assets\";\nimport { Weapons } from \"./Weapons\";\nimport { Hits } from \"./Hits\";\nimport { Fleet } from \"./Fleet\";\nimport { BattleAssets } from \"./BattleAssets\";\nimport { getSVGNormalizedPosition } from \"../../utils/svg\";\nimport {\n\tSeaBattlePosition,\n\tSeaBattleMapData,\n\tSeaBattleAssetVisibility\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\n// Order is important : Weapons under Boats under Hits\nexport const Map: FC<{\n\thideFleet: boolean;\n\tonCellClick?: (position: SeaBattlePosition) => void;\n\tmap?: SeaBattleMapData;\n\tselectedBoatIndex?: number;\n\tonSelectBoatIndex?: (index: number) => void;\n}> = ({\n\thideFleet,\n\tonCellClick,\n\tmap: { fleet, hits, opponentsWeapons } = {\n\t\tfleet: [],\n\t\thits: [],\n\t\topponentsWeapons: [],\n\t\tstatus: \"ok\",\n\t\tuserId: \"\",\n\t\tweapons: {}\n\t},\n\tselectedBoatIndex,\n\tonSelectBoatIndex\n}) => {\n\tconst svg = useRef<SVGSVGElement>(null);\n\n\tconst [selectedPos, setSelectedPos] = useState<SeaBattlePosition>({\n\t\tx: 0,\n\t\ty: 0\n\t});\n\tconst [selectedVis, setSelectedVis] = useState<SeaBattleAssetVisibility>(\n\t\t\"hidden\"\n\t);\n\n\tconst [selectionPos, setSelectionPos] = useState<SeaBattlePosition>({\n\t\tx: 0,\n\t\ty: 0\n\t});\n\tconst [selectionVis, setSelectionVis] = useState<SeaBattleAssetVisibility>(\n\t\t\"hidden\"\n\t);\n\n\tconst onClick = useCallback(\n\t\t(position: SeaBattlePosition) => {\n\t\t\tconst normalizedPos = getSVGNormalizedPosition(\n\t\t\t\tsvg.current!,\n\t\t\t\tposition\n\t\t\t);\n\t\t\tif (\n\t\t\t\tselectedPos.x === normalizedPos.x &&\n\t\t\t\tselectedPos.y === normalizedPos.y\n\t\t\t) {\n\t\t\t\t// Reset\n\t\t\t\tsetSelectedPos({ x: 0, y: 0 });\n\t\t\t\tsetSelectedVis(\"hidden\");\n\t\t\t} else {\n\t\t\t\t// Set\n\t\t\t\tsetSelectedPos(normalizedPos);\n\t\t\t\tsetSelectedVis(\"visible\");\n\t\t\t}\n\t\t\tif (onCellClick) {\n\t\t\t\tonCellClick(normalizedPos);\n\t\t\t}\n\t\t},\n\t\t[onCellClick, selectedPos]\n\t);\n\n\tconst onLeave = useCallback(() => {\n\t\tsetSelectionVis(\"hidden\");\n\t}, []);\n\n\tconst onOver = useCallback((position: SeaBattlePosition) => {\n\t\tsetSelectionPos(getSVGNormalizedPosition(svg.current!, position));\n\t\tsetSelectionVis(\"visible\");\n\t}, []);\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"SeaBattleMap\"\n\t\t\tviewBox=\"0 0 400 400\"\n\t\t\tref={svg}\n\t\t\tonClick={e => onClick({ x: e.clientX, y: e.clientY })}\n\t\t\tonMouseLeave={onLeave}\n\t\t\tonMouseMove={e => onOver({ x: e.clientX, y: e.clientY })}>\n\t\t\t<BattleAssets />\n\t\t\t<rect width=\"400\" height=\"400\" fill=\"url(#sea-grid)\" />\n\t\t\t<Cell\n\t\t\t\ttype=\"cell-selection\"\n\t\t\t\tposition={selectionPos}\n\t\t\t\tvisibility={selectionVis}\n\t\t\t/>\n\t\t\t<Cell\n\t\t\t\ttype=\"cell-selected\"\n\t\t\t\tposition={selectedPos}\n\t\t\t\tvisibility={selectedVis}\n\t\t\t/>\n\t\t\t<Weapons weapons={opponentsWeapons} />\n\t\t\t<Fleet\n\t\t\t\thideFleet={hideFleet}\n\t\t\t\tfleet={fleet}\n\t\t\t\tselectedBoatIndex={selectedBoatIndex}\n\t\t\t\tonSelectBoatIndex={onSelectBoatIndex}\n\t\t\t/>\n\t\t\t<Hits hits={hits} />\n\t\t</svg>\n\t);\n};\n","import { SeaBattleBoatLengthMappings } from \"./mappings\";\nimport {\n\tSeaBattleBoatData,\n\tSeaBattleGrid,\n\tSeaBattleGridCell,\n\tSeaBattlePosition,\n\tSeaBattleDirection,\n\tGRID_CELL_COUNT,\n\tAngleToDirection\n} from \".\";\n\n// ------------------------------------------------------------------\n\nexport const getGridCell = (\n\tgrid: SeaBattleGrid,\n\tpos: SeaBattlePosition\n): SeaBattleGridCell => grid[pos.y][pos.x];\n\nexport const setGridCell = (\n\tgrid: SeaBattleGrid,\n\tpos: SeaBattlePosition,\n\tcell: SeaBattleGridCell\n): void => {\n\tgrid[pos.y][pos.x] = cell;\n};\n\n// ------------------------------------------------------------------\n\nexport const checkPositionInZone = (pos: SeaBattlePosition) =>\n\tpos.x >= 0 &&\n\tpos.x < GRID_CELL_COUNT &&\n\tpos.y >= 0 &&\n\tpos.y < GRID_CELL_COUNT;\n\n// ------------------------------------------------------------------\n\nexport const checkZone = (\n\tboat: SeaBattleBoatData,\n\tnewPos: SeaBattlePosition,\n\tnewDir: SeaBattleDirection\n) => {\n\tif (!checkPositionInZone(newPos)) {\n\t\treturn false;\n\t}\n\tconst offset = SeaBattleBoatLengthMappings[boat.type] - 1;\n\tswitch (newDir) {\n\t\tcase \"N\":\n\t\t\treturn checkPositionInZone({\n\t\t\t\tx: newPos.x,\n\t\t\t\ty: newPos.y - offset\n\t\t\t});\n\t\tcase \"E\":\n\t\t\treturn checkPositionInZone({\n\t\t\t\tx: newPos.x + offset,\n\t\t\t\ty: newPos.y\n\t\t\t});\n\t\tcase \"S\":\n\t\t\treturn checkPositionInZone({\n\t\t\t\tx: newPos.x,\n\t\t\t\ty: newPos.y + offset\n\t\t\t});\n\t\tcase \"W\":\n\t\t\treturn checkPositionInZone({\n\t\t\t\tx: newPos.x - offset,\n\t\t\t\ty: newPos.y\n\t\t\t});\n\t}\n};\n\n// ------------------------------------------------------------------\n\nexport const generateGrid = (\n\tfleet: SeaBattleBoatData[],\n\tmovingBoat?: SeaBattleBoatData\n): SeaBattleGrid => {\n\tconst grid: SeaBattleGrid = Array<SeaBattleGridCell>(GRID_CELL_COUNT)\n\t\t.fill(null)\n\t\t.map(_ => Array<SeaBattleGridCell>(GRID_CELL_COUNT).fill(null));\n\tfor (\n\t\tlet boatIndex = 0, boatCount = fleet.length;\n\t\tboatIndex < boatCount;\n\t\t++boatIndex\n\t) {\n\t\tconst boat = fleet[boatIndex];\n\t\tif (movingBoat === boat) {\n\t\t\tcontinue; // Ignore moving boat\n\t\t}\n\t\tswitch (AngleToDirection(boat.angle)) {\n\t\t\tcase \"N\":\n\t\t\t\tfor (\n\t\t\t\t\tlet boatLocalIndex = 0;\n\t\t\t\t\tboatLocalIndex < SeaBattleBoatLengthMappings[boat.type];\n\t\t\t\t\t++boatLocalIndex\n\t\t\t\t) {\n\t\t\t\t\tsetGridCell(\n\t\t\t\t\t\tgrid,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tx: boat.position.x,\n\t\t\t\t\t\t\ty: boat.position.y - boatLocalIndex\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tboatIndex,\n\t\t\t\t\t\t\tboatLocalIndex,\n\t\t\t\t\t\t\ttype: \"boat\"\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"E\":\n\t\t\t\tfor (\n\t\t\t\t\tlet boatLocalIndex = 0;\n\t\t\t\t\tboatLocalIndex < SeaBattleBoatLengthMappings[boat.type];\n\t\t\t\t\t++boatLocalIndex\n\t\t\t\t) {\n\t\t\t\t\tsetGridCell(\n\t\t\t\t\t\tgrid,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tx: boat.position.x + boatLocalIndex,\n\t\t\t\t\t\t\ty: boat.position.y\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tboatIndex,\n\t\t\t\t\t\t\tboatLocalIndex,\n\t\t\t\t\t\t\ttype: \"boat\"\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"S\":\n\t\t\t\tfor (\n\t\t\t\t\tlet boatLocalIndex = 0;\n\t\t\t\t\tboatLocalIndex < SeaBattleBoatLengthMappings[boat.type];\n\t\t\t\t\t++boatLocalIndex\n\t\t\t\t) {\n\t\t\t\t\tsetGridCell(\n\t\t\t\t\t\tgrid,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tx: boat.position.x,\n\t\t\t\t\t\t\ty: boat.position.y + boatLocalIndex\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tboatIndex,\n\t\t\t\t\t\t\tboatLocalIndex,\n\t\t\t\t\t\t\ttype: \"boat\"\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"W\":\n\t\t\t\tfor (\n\t\t\t\t\tlet boatLocalIndex = 0;\n\t\t\t\t\tboatLocalIndex < SeaBattleBoatLengthMappings[boat.type];\n\t\t\t\t\t++boatLocalIndex\n\t\t\t\t) {\n\t\t\t\t\tsetGridCell(\n\t\t\t\t\t\tgrid,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tx: boat.position.x - boatLocalIndex,\n\t\t\t\t\t\t\ty: boat.position.y\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tboatIndex,\n\t\t\t\t\t\t\tboatLocalIndex,\n\t\t\t\t\t\t\ttype: \"boat\"\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t}\n\t}\n\treturn grid;\n};\n\n// ------------------------------------------------------------------\n\nexport const checkCollisions = (\n\tfleet: SeaBattleBoatData[],\n\tboat: SeaBattleBoatData,\n\tpos: SeaBattlePosition,\n\tdir: SeaBattleDirection\n) => {\n\tconst grid = generateGrid(fleet, boat);\n\t// console.debug(\"[SeaBattle] Collision grid\", grid);\n\tconst length = SeaBattleBoatLengthMappings[boat.type];\n\tswitch (dir) {\n\t\tcase \"N\":\n\t\t\tfor (let i = 0; i < length; ++i) {\n\t\t\t\tif (null !== getGridCell(grid, { x: pos.x, y: pos.y - i })) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"E\":\n\t\t\tfor (let i = 0; i < length; ++i) {\n\t\t\t\tif (null !== getGridCell(grid, { x: pos.x + i, y: pos.y })) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"S\":\n\t\t\tfor (let i = 0; i < length; ++i) {\n\t\t\t\tif (null !== getGridCell(grid, { x: pos.x, y: pos.y + i })) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"W\":\n\t\t\tfor (let i = 0; i < length; ++i) {\n\t\t\t\tif (null !== getGridCell(grid, { x: pos.x - i, y: pos.y })) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t}\n\treturn true;\n};\n\n// ------------------------------------------------------------------\n\nexport const movementIsPossible = (\n\tfleet: SeaBattleBoatData[],\n\tboat: SeaBattleBoatData,\n\tnewPos: SeaBattlePosition,\n\tnewDir: SeaBattleDirection\n) => {\n\tif (!checkZone(boat, newPos, newDir)) {\n\t\tconsole.debug(\"[SeaBattle] Boat blocked by zone\");\n\t\treturn false;\n\t}\n\tif (!checkCollisions(fleet, boat, newPos, newDir)) {\n\t\tconsole.debug(\"[SeaBattle] Boat blocked by collision\");\n\t\treturn false;\n\t}\n\treturn true;\n};\n","import { AsyncAction, trySomething } from \"..\";\nimport { displayError, displaySuccess } from \"../messages\";\nimport {\n\tSeaBattleMovementType,\n\tAngleToDirection,\n\tMAX_PLAYER_COUNT,\n\tSeaBattlePosition,\n\tSeaBattleWeaponType,\n\textractOpponentMaps,\n\tpassBatonToNextPlayer,\n\tcheckUserHasBatton,\n\tdecodeBattle,\n\tencodeBattle\n} from \"../../utils/games/seabattle\";\nimport {\n\tSeaBattleBoatTranslationMappings,\n\tSeaBattleBoatRotationTransformationMappings,\n\tSeaBattleBoatLengthMappings\n} from \"../../utils/games/seabattle/mappings\";\nimport {\n\tmovementIsPossible,\n\tgenerateGrid,\n\tgetGridCell\n} from \"../../utils/games/seabattle/collision\";\nimport { generateFleet } from \"../../utils/games/seabattle/generator\";\nimport { lockRoom } from \"../room\";\n\n// ------------------------------------------------------------------\n\nexport const joinBattle = (): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, extra },\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { userId }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!userId) {\n\t\t\t\t\tdispatch(displayError(\"user.not_connected\"));\n\t\t\t\t\treturn \"connect-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !extra) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\n\t\t\t\tconsole.debug(\"[SeaBattle] Joining battle...\", { userId });\n\t\t\t\tconst battle = decodeBattle(extra);\n\t\t\t\tconst map = battle.maps.find(other => other.userId === userId);\n\t\t\t\tif (map) {\n\t\t\t\t\treturn true; // Nothing to do, user is already in the battle\n\t\t\t\t}\n\t\t\t\tif (Object.keys(battle.maps).length >= MAX_PLAYER_COUNT) {\n\t\t\t\t\tdispatch(displayError(\"games.max_players_count\"));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\t// Warning: Here it could overwrite last update pushed in the battle by other user at the same time\n\t\t\t\t// But there is very few chance for that to happen with small number of players\n\n\t\t\t\tgenerateFleet(battle, userId);\n\t\t\t\tawait _fbRoom.updateExtra(encodeBattle(battle));\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const moveBoat = ({\n\tboatIndex,\n\tmovement\n}: {\n\tboatIndex: number;\n\tmovement: SeaBattleMovementType;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, extra },\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { userId }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !extra) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (!userId) {\n\t\t\t\t\tdispatch(displayError(\"user.not_connected\"));\n\t\t\t\t\treturn \"connect-and-retry\";\n\t\t\t\t}\n\n\t\t\t\tconst battle = decodeBattle(extra);\n\n\t\t\t\tconst playerMap = battle.maps.find(\n\t\t\t\t\tother => other.userId === userId\n\t\t\t\t);\n\t\t\t\tif (!playerMap) {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"[SeaBattle] Cannot find map for current user\"\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tif (!checkUserHasBatton(battle, userId)) {\n\t\t\t\t\tdispatch(displayError(\"games.seabattle.not_your_turn\"));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconst { fleet } = playerMap;\n\t\t\t\tif (boatIndex < 0 || boatIndex >= fleet.length) {\n\t\t\t\t\tconsole.debug(\"[SeaBattle] No boat selected\");\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconst { angle: oldAngle, position: oldPosition, type } = fleet[\n\t\t\t\t\tboatIndex\n\t\t\t\t];\n\n\t\t\t\tconst oldDirection = AngleToDirection(oldAngle);\n\n\t\t\t\tlet newPosition = { ...oldPosition };\n\t\t\t\tif (\n\t\t\t\t\tmovement === \"move_forward\" ||\n\t\t\t\t\tmovement === \"move_backward\"\n\t\t\t\t) {\n\t\t\t\t\tnewPosition.x +=\n\t\t\t\t\t\tSeaBattleBoatTranslationMappings[oldDirection][\n\t\t\t\t\t\t\tmovement\n\t\t\t\t\t\t].x;\n\t\t\t\t\tnewPosition.y +=\n\t\t\t\t\t\tSeaBattleBoatTranslationMappings[oldDirection][\n\t\t\t\t\t\t\tmovement\n\t\t\t\t\t\t].y;\n\t\t\t\t}\n\n\t\t\t\tlet newAngle = oldAngle;\n\t\t\t\tlet newDirection = oldDirection;\n\t\t\t\tif (movement === \"rotate_left\" || movement === \"rotate_right\") {\n\t\t\t\t\tif (movement === \"rotate_left\") {\n\t\t\t\t\t\tnewAngle--;\n\t\t\t\t\t}\n\t\t\t\t\tif (movement === \"rotate_right\") {\n\t\t\t\t\t\tnewAngle++;\n\t\t\t\t\t}\n\t\t\t\t\tnewDirection = AngleToDirection(newAngle);\n\t\t\t\t\tnewPosition.x +=\n\t\t\t\t\t\tSeaBattleBoatRotationTransformationMappings[type][\n\t\t\t\t\t\t\toldDirection\n\t\t\t\t\t\t].x;\n\t\t\t\t\tnewPosition.y +=\n\t\t\t\t\t\tSeaBattleBoatRotationTransformationMappings[type][\n\t\t\t\t\t\t\toldDirection\n\t\t\t\t\t\t].y;\n\t\t\t\t}\n\n\t\t\t\tconst boat = fleet[boatIndex];\n\t\t\t\tif (boat.hits.find(hit => hit.type === \"hitted\")) {\n\t\t\t\t\tconsole.debug(\"[SeaBattle] Hitted boat cannot move...\", {\n\t\t\t\t\t\tboatIndex\n\t\t\t\t\t});\n\t\t\t\t\t// dispatch(\n\t\t\t\t\t// \tdisplayError(\n\t\t\t\t\t// \t\t\"games.seabattle.movement_not_possible_because_hitted\",\n\t\t\t\t\t// \t\t{\n\t\t\t\t\t// \t\t\ttag: INVALID_MOVE_MESSAGE_TAG\n\t\t\t\t\t// \t\t}\n\t\t\t\t\t// \t)\n\t\t\t\t\t// );\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\t!movementIsPossible(fleet, boat, newPosition, newDirection)\n\t\t\t\t) {\n\t\t\t\t\tconsole.debug(\"[SeaBattle] Movement is not possible...\", {\n\t\t\t\t\t\tboatIndex,\n\t\t\t\t\t\tmovement,\n\t\t\t\t\t\toldDirection,\n\t\t\t\t\t\tnewDirection,\n\t\t\t\t\t\toldPosition,\n\t\t\t\t\t\tnewPosition\n\t\t\t\t\t});\n\t\t\t\t\t// dispatch(\n\t\t\t\t\t// \tdisplayError(\"games.seabattle.movement_not_possible\", {\n\t\t\t\t\t// \t\ttag: INVALID_MOVE_MESSAGE_TAG\n\t\t\t\t\t// \t})\n\t\t\t\t\t// );\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconsole.debug(\"[SeaBattle] Moving boat...\", {\n\t\t\t\t\tboatIndex,\n\t\t\t\t\tmovement,\n\t\t\t\t\toldDirection,\n\t\t\t\t\toldPosition,\n\t\t\t\t\tnewDirection,\n\t\t\t\t\tnewPosition\n\t\t\t\t});\n\n\t\t\t\t// Alter battle\n\t\t\t\tboat.angle = newAngle;\n\t\t\t\tboat.position = newPosition;\n\t\t\t\tpassBatonToNextPlayer(battle);\n\t\t\t\tawait _fbRoom.updateExtra(encodeBattle(battle));\n\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const attackOpponent = ({\n\topponentIndex,\n\tposition,\n\tweaponType\n}: {\n\topponentIndex: number;\n\tposition: SeaBattlePosition;\n\tweaponType: SeaBattleWeaponType;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\troom: { _fbRoom, extra },\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { userId }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!_fbRoom || _fbRoom.isLocked() || !extra) {\n\t\t\t\t\tdispatch(displayError(\"rooms.errors.locked\"));\n\t\t\t\t\treturn \"unlock-and-retry\";\n\t\t\t\t}\n\t\t\t\tif (!userId) {\n\t\t\t\t\tdispatch(displayError(\"user.not_connected\"));\n\t\t\t\t\treturn \"connect-and-retry\";\n\t\t\t\t}\n\n\t\t\t\tconst battle = decodeBattle(extra);\n\t\t\t\tconst playerMap = battle.maps.find(\n\t\t\t\t\tother => other.userId === userId\n\t\t\t\t);\n\t\t\t\tif (!playerMap) {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"[SeaBattle] Cannot find map for current user\"\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (!checkUserHasBatton(battle, userId)) {\n\t\t\t\t\tdispatch(displayError(\"games.seabattle.not_your_turn\"));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tif (playerMap.weapons[weaponType] <= 0) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tdisplayError(\"games.seabattle.weapon_not_available\")\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconst opponentMaps = extractOpponentMaps(battle.maps, userId);\n\t\t\t\tif (opponentIndex < 0 || opponentIndex >= opponentMaps.length) {\n\t\t\t\t\tconsole.debug(\"[SeaBattle] Cannot find opponent map\");\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tconst opponentMap = opponentMaps[opponentIndex];\n\t\t\t\tif (opponentMap.userId === userId) {\n\t\t\t\t\tconsole.debug(\"[SeaBattle] Invalid opponent map\");\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tif (opponentMap.status === \"ko\") {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"[SeaBattle] Opponent has already been killed\"\n\t\t\t\t\t);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tconsole.debug(\"[SeaBattle] Attacking opponent...\", {\n\t\t\t\t\topponentIndex,\n\t\t\t\t\tposition,\n\t\t\t\t\tweaponType\n\t\t\t\t});\n\n\t\t\t\tconst grid = generateGrid(opponentMap.fleet);\n\t\t\t\tconst cell = getGridCell(grid, position);\n\n\t\t\t\t// Alter battle\n\t\t\t\tif (null === cell) {\n\t\t\t\t\tdispatch(displayError(\"games.seabattle.missed_opponent\"));\n\t\t\t\t\topponentMap.hits.push({\n\t\t\t\t\t\tposition,\n\t\t\t\t\t\ttype: \"missed\"\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tif (cell.type === \"boat\") {\n\t\t\t\t\t\tconst opponentBoat = opponentMap.fleet[cell.boatIndex];\n\t\t\t\t\t\tif (opponentBoat.status === \"ko\") {\n\t\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\t\tdisplayError(\n\t\t\t\t\t\t\t\t\t\"games.seabattle.ship_already_killed\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst hit = opponentBoat.hits.find(\n\t\t\t\t\t\t\thit => hit.position.x === cell.boatLocalIndex\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (hit) {\n\t\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\t\tdisplayError(\n\t\t\t\t\t\t\t\t\t\"games.seabattle.ship_already_hitted\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\topponentBoat.hits.push({\n\t\t\t\t\t\t\tposition: {\n\t\t\t\t\t\t\t\tx: cell.boatLocalIndex,\n\t\t\t\t\t\t\t\ty: 0\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: \"hitted\"\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\topponentBoat.hits.length ===\n\t\t\t\t\t\t\tSeaBattleBoatLengthMappings[opponentBoat.type]\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\t\tdisplaySuccess(\n\t\t\t\t\t\t\t\t\t\"games.seabattle.killed_opponent_boat\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\topponentBoat.status = \"ko\";\n\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t!opponentMap.fleet.find(\n\t\t\t\t\t\t\t\t\tboat => boat.status === \"ok\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\topponentMap.status = \"ko\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\t\tdisplaySuccess(\n\t\t\t\t\t\t\t\t\t\"games.seabattle.hitted_opponent\"\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\tdisplaySuccess(\"games.seabattle.hitted_weapon\")\n\t\t\t\t\t\t); // TODO: for example a mine\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tplayerMap.weapons[weaponType]--;\n\t\t\t\tpassBatonToNextPlayer(battle);\n\t\t\t\tawait _fbRoom.updateExtra(encodeBattle(battle));\n\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => dispatch(lockRoom())\n\t\t})\n\t);\n","import React, { FC } from \"react\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { useTranslation } from \"react-i18next\";\n\n// ------------------------------------------------------------------\n\nexport const OpponentSelection: FC<{\n\topponentsCount: number;\n\topponentIndex: number;\n\tonSelectPreviousOpponent?: () => void;\n\tonSelectNextOpponent?: () => void;\n}> = ({\n\topponentsCount,\n\topponentIndex,\n\tonSelectPreviousOpponent,\n\tonSelectNextOpponent\n}) => {\n\tconst { t } = useTranslation();\n\n\treturn opponentsCount > 0 ? (\n\t\t<div className=\"SeaBattleOpponentSelection\">\n\t\t\t<IconButton\n\t\t\t\tdisabled={opponentsCount <= 1}\n\t\t\t\ticon=\"caret-left\"\n\t\t\t\ttitle=\"Previous enemy\"\n\t\t\t\tonClick={onSelectPreviousOpponent}\n\t\t\t/>\n\t\t\t<span className=\"SeaBattleOpponentSelectionLabel\">\n\t\t\t\t{t(\"games.seabattle.opponent_index\", {\n\t\t\t\t\tindex: `${opponentIndex + 1} / ${opponentsCount}`\n\t\t\t\t})}\n\t\t\t</span>\n\t\t\t<IconButton\n\t\t\t\tdisabled={opponentsCount <= 1}\n\t\t\t\ticon=\"caret-right\"\n\t\t\t\ttitle=\"Next enemy\"\n\t\t\t\tonClick={onSelectNextOpponent}\n\t\t\t/>\n\t\t</div>\n\t) : (\n\t\t<div className=\"SeaBattleOpponentSelection\">\n\t\t\t<span className=\"SeaBattleOpponentSelectionLabel\">\n\t\t\t\t{t(\"games.no_opponents\")}\n\t\t\t</span>\n\t\t</div>\n\t);\n};\n","import React, { FC, useRef, useCallback, useState } from \"react\";\n//\nimport { getSVGNormalizedPosition } from \"../../utils/svg\";\nimport { BattleAssets } from \"./BattleAssets\";\nimport { Cell } from \"./Assets\";\nimport { Weapons } from \"./Weapons\";\nimport {\n\tSeaBattleAssetVisibility,\n\tSeaBattlePosition,\n\tSeaBattleWeaponTypes,\n\tSeaBattleWeaponType\n} from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const WeaponSelection: FC<{\n\tonSelect?: (type: SeaBattleWeaponType) => void;\n\tweapons: { [type: string]: number };\n\tweaponType: SeaBattleWeaponType;\n}> = ({ onSelect, weapons, weaponType }) => {\n\tconst svg = useRef<SVGSVGElement>(null);\n\n\tconst [selectedPos, setSelectedPos] = useState<number>(\n\t\tSeaBattleWeaponTypes.indexOf(weaponType)\n\t);\n\tconst [selectedVis, setSelectedVis] = useState<SeaBattleAssetVisibility>(\n\t\tselectedPos >= 0 ? \"visible\" : \"hidden\"\n\t);\n\n\tconst [selectionPos, setSelectionPos] = useState<number>(-1);\n\tconst [selectionVis, setSelectionVis] = useState<SeaBattleAssetVisibility>(\n\t\t\"hidden\"\n\t);\n\n\tconst onClick = useCallback(\n\t\t(position: SeaBattlePosition) => {\n\t\t\tconst { x } = getSVGNormalizedPosition(svg.current!, position);\n\t\t\tif (selectedPos !== x && onSelect) {\n\t\t\t\t// Set\n\t\t\t\tsetSelectedPos(x);\n\t\t\t\tsetSelectedVis(\"visible\");\n\t\t\t\tonSelect(SeaBattleWeaponTypes[x]);\n\t\t\t}\n\t\t},\n\t\t[onSelect, selectedPos]\n\t);\n\n\tconst onLeave = useCallback(() => {\n\t\tsetSelectionVis(\"hidden\");\n\t}, []);\n\n\tconst onOver = useCallback(\n\t\t(position: SeaBattlePosition) => {\n\t\t\tif (onSelect) {\n\t\t\t\tsetSelectionPos(\n\t\t\t\t\tgetSVGNormalizedPosition(svg.current!, position).x\n\t\t\t\t);\n\t\t\t\tsetSelectionVis(\"visible\");\n\t\t\t}\n\t\t},\n\t\t[onSelect]\n\t);\n\n\treturn (\n\t\t<svg\n\t\t\tclassName=\"SeaBattleWeaponSelection\"\n\t\t\tviewBox=\"0 0 160 40\"\n\t\t\tref={svg}\n\t\t\tonClick={e => onClick({ x: e.clientX, y: e.clientY })}\n\t\t\tonMouseLeave={onLeave}\n\t\t\tonMouseMove={e => onOver({ x: e.clientX, y: e.clientY })}>\n\t\t\t<BattleAssets />\n\t\t\t<rect width=\"400\" height=\"400\" fill=\"url(#sea-grid)\" />\n\t\t\t<Cell\n\t\t\t\ttype=\"cell-selection\"\n\t\t\t\tposition={{ x: selectionPos, y: 0 }}\n\t\t\t\tvisibility={selectionVis}\n\t\t\t/>\n\t\t\t<Cell\n\t\t\t\ttype=\"cell-selected\"\n\t\t\t\tposition={{ x: selectedPos, y: 0 }}\n\t\t\t\tvisibility={selectedVis}\n\t\t\t/>\n\t\t\t<Weapons\n\t\t\t\tweapons={SeaBattleWeaponTypes.map((type, index) => ({\n\t\t\t\t\topponentId: \"\",\n\t\t\t\t\tposition: { x: index, y: 0 },\n\t\t\t\t\ttype\n\t\t\t\t}))}\n\t\t\t/>\n\t\t\t{SeaBattleWeaponTypes.map((type, index) => (\n\t\t\t\t<Cell\n\t\t\t\t\tkey={index}\n\t\t\t\t\ttype=\"cell-crossed\"\n\t\t\t\t\tposition={{ x: index, y: 0 }}\n\t\t\t\t\tvisibility={!weapons[type] ? \"visible\" : \"hidden\"}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</svg>\n\t);\n};\n","import React, { FC } from \"react\";\n//\nimport { OpponentSelection } from \"./OpponentSelection\";\nimport { WeaponSelection } from \"./WeaponSelection\";\nimport { SeaBattleWeaponType } from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleOpponentControls: FC<{\n\topponentsCount: number;\n\topponentIndex: number;\n\tonSelectPreviousOpponent?: () => void;\n\tonSelectNextOpponent?: () => void;\n\tonSelectWeaponType: (type: SeaBattleWeaponType) => void;\n\tweapons: { [type: string]: number };\n\tweaponType: SeaBattleWeaponType;\n}> = ({\n\topponentsCount,\n\topponentIndex,\n\tonSelectPreviousOpponent,\n\tonSelectNextOpponent,\n\tonSelectWeaponType,\n\tweapons,\n\tweaponType\n}) => (\n\t<div className=\"SeaBattleOpponentControls SeaBattleControls\">\n\t\t<OpponentSelection\n\t\t\topponentsCount={opponentsCount}\n\t\t\topponentIndex={opponentIndex}\n\t\t\tonSelectPreviousOpponent={onSelectPreviousOpponent}\n\t\t\tonSelectNextOpponent={onSelectNextOpponent}\n\t\t/>\n\t\t<WeaponSelection\n\t\t\tonSelect={onSelectWeaponType}\n\t\t\tweapons={weapons}\n\t\t\tweaponType={weaponType}\n\t\t/>\n\t</div>\n);\n","import React, { FC, useState, useEffect, useCallback } from \"react\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { SeaBattlePlayerControls } from \"../../components/SeaBattle/PlayerControls\";\nimport { Map } from \"../../components/SeaBattle/Map\";\nimport { RootState } from \"../../reducers\";\nimport { SeaBattleKeyboardMoveMappings } from \"../../utils/games/seabattle/mappings\";\nimport { Dispatch } from \"../../actions\";\nimport {\n\tmoveBoat,\n\tjoinBattle,\n\tattackOpponent\n} from \"../../actions/games/seabattle\";\nimport { KEY_UP, KEY_DOWN, KEY_LEFT, KEY_RIGHT } from \"../../utils/keyboards\";\nimport { SeaBattleOpponentControls } from \"../../components/SeaBattle/OpponentControls\";\nimport { IconButton } from \"../../components/Common/IconButton\";\nimport {\n\textractBattleInfo,\n\tMAX_PLAYER_COUNT,\n\tSeaBattleMovementType,\n\tSeaBattlePosition,\n\tSeaBattleWeaponType,\n\tAngleToDirection\n} from \"../../utils/games/seabattle\";\nimport { displayInfo } from \"../../actions/messages\";\nimport { openModal } from \"../../reducers/modals\";\nimport { clearMessages } from \"../../reducers/messages\";\nimport \"./SeaBattle.scss\";\n\n// ------------------------------------------------------------------\n\nexport const PLAYER_TURN_MESSAGE_TAG = \"seabattle/player_turn\";\n\n// ------------------------------------------------------------------\n\nexport const SeaBattle: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { t } = useTranslation();\n\tconst [previousMapIndex, setPreviousMapIndex] = useState<number>(-1);\n\tconst [boatIndex, setSelectedBoatIndex] = useState<number>(-1);\n\tconst [opponentIndex, setSelectedOpponent] = useState<number>(0);\n\tconst [weaponType, setSelectedWeaponType] = useState<SeaBattleWeaponType>(\n\t\t\"bullet1\"\n\t);\n\n\tconst userId = useSelector<RootState, string>(\n\t\tstate => state.user.access.userId\n\t);\n\n\tconst extra = useSelector<RootState, string>(\n\t\tstate => state.room.extra || \"\"\n\t);\n\n\tconst {\n\t\tboat,\n\t\tcurrentMapIndex,\n\t\topponentMaps,\n\t\tplayerMap,\n\t\tplayerMapIndex\n\t} = extractBattleInfo({\n\t\textra,\n\t\tuserId,\n\t\tboatIndex\n\t});\n\n\tconst onJoinBattle = useCallback(() => {\n\t\tdispatch(joinBattle());\n\t}, [dispatch]);\n\n\tconst onMove = useCallback(\n\t\t(movement: SeaBattleMovementType) => {\n\t\t\tdispatch(\n\t\t\t\tmoveBoat({\n\t\t\t\t\tboatIndex,\n\t\t\t\t\tmovement\n\t\t\t\t})\n\t\t\t);\n\t\t},\n\t\t[dispatch, boatIndex]\n\t);\n\n\tconst onKeyDown = useCallback(\n\t\t(e: KeyboardEvent) => {\n\t\t\tif (\n\t\t\t\te.repeat ||\n\t\t\t\t(e.keyCode !== KEY_UP &&\n\t\t\t\t\te.keyCode !== KEY_DOWN &&\n\t\t\t\t\te.keyCode !== KEY_LEFT &&\n\t\t\t\t\te.keyCode !== KEY_RIGHT)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\te.preventDefault(); // to prevent scrolling with keyboard\n\t\t\tif (!boat) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tonMove(\n\t\t\t\tSeaBattleKeyboardMoveMappings[AngleToDirection(boat.angle)][\n\t\t\t\t\te.keyCode\n\t\t\t\t]\n\t\t\t);\n\t\t},\n\t\t[onMove, boat]\n\t);\n\n\tconst onConnectUser = useCallback(\n\t\t() => dispatch(openModal({ type: \"User/Create\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onOpponentCellClick = useCallback(\n\t\t(position: SeaBattlePosition) => {\n\t\t\tif (!opponentMaps || opponentMaps.length === 0) {\n\t\t\t\tdispatch(displayInfo(\"games.no_opponents_to_attack\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!weaponType) {\n\t\t\t\tdispatch(displayInfo(\"games.seabattle.no_weapon_selected\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdispatch(attackOpponent({ opponentIndex, position, weaponType }));\n\t\t},\n\t\t[dispatch, opponentIndex, opponentMaps, weaponType]\n\t);\n\n\tuseEffect(() => {\n\t\tdocument.addEventListener(\"keydown\", onKeyDown);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener(\"keydown\", onKeyDown);\n\t\t};\n\t}, [onKeyDown]);\n\n\tuseEffect(() => {\n\t\tif (previousMapIndex !== currentMapIndex) {\n\t\t\tdispatch(clearMessages(PLAYER_TURN_MESSAGE_TAG));\n\t\t\tif (playerMap?.status === \"ko\") {\n\t\t\t\tdispatch(\n\t\t\t\t\topenModal({\n\t\t\t\t\t\ttype: \"SeaBattle/GameOver\",\n\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\tstatus: \"looser\"\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t} else if (opponentMaps && opponentMaps.length > 0) {\n\t\t\t\tif (\n\t\t\t\t\t!opponentMaps.find(\n\t\t\t\t\t\topponentMap => opponentMap.status !== \"ko\"\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\topenModal({\n\t\t\t\t\t\t\ttype: \"SeaBattle/GameOver\",\n\t\t\t\t\t\t\tprops: {\n\t\t\t\t\t\t\t\tstatus: \"winner\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t} else if (currentMapIndex === playerMapIndex) {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tdisplayInfo(\"games.seabattle.player_turn\", {\n\t\t\t\t\t\t\tautoclear: false,\n\t\t\t\t\t\t\tclosable: false,\n\t\t\t\t\t\t\ttag: PLAYER_TURN_MESSAGE_TAG,\n\t\t\t\t\t\t\tweight: 1000000\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tdispatch(\n\t\t\t\t\t\tdisplayInfo(\"games.seabattle.opponent_turn\", {\n\t\t\t\t\t\t\tautoclear: false,\n\t\t\t\t\t\t\tclosable: false,\n\t\t\t\t\t\t\ttag: PLAYER_TURN_MESSAGE_TAG,\n\t\t\t\t\t\t\tweight: 1000000\n\t\t\t\t\t\t})\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tsetPreviousMapIndex(currentMapIndex);\n\t\t}\n\t}, [\n\t\tcurrentMapIndex,\n\t\tdispatch,\n\t\topponentMaps,\n\t\tplayerMap,\n\t\tplayerMapIndex,\n\t\tpreviousMapIndex\n\t]);\n\n\treturn (\n\t\t<div className=\"SeaBattle\">\n\t\t\t<div className=\"SeaBattlePlayer current\">\n\t\t\t\t<SeaBattlePlayerControls\n\t\t\t\t\tboat={boat}\n\t\t\t\t\tdisabled={!boat}\n\t\t\t\t\tonMoveForward={() => onMove(\"move_forward\")}\n\t\t\t\t\tonMoveBackward={() => onMove(\"move_backward\")}\n\t\t\t\t\tonRotateLeft={() => onMove(\"rotate_left\")}\n\t\t\t\t\tonRotateRight={() => onMove(\"rotate_right\")}\n\t\t\t\t/>\n\t\t\t\t{playerMap ? (\n\t\t\t\t\t<Map\n\t\t\t\t\t\tmap={playerMap}\n\t\t\t\t\t\thideFleet={false}\n\t\t\t\t\t\tselectedBoatIndex={boatIndex}\n\t\t\t\t\t\tonSelectBoatIndex={setSelectedBoatIndex}\n\t\t\t\t\t/>\n\t\t\t\t) : (\n\t\t\t\t\t<div className=\"SeaBattleJoin\">\n\t\t\t\t\t\t{opponentMaps &&\n\t\t\t\t\t\topponentMaps.length >= MAX_PLAYER_COUNT ? (\n\t\t\t\t\t\t\t<span>{t(\"games.max_players_count\")}</span>\n\t\t\t\t\t\t) : !userId ? (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<span>{t(\"games.connect_to_join\")}</span>\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\ticon=\"sign-in\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"user.connect\")}\n\t\t\t\t\t\t\t\t\tsize=\"L\"\n\t\t\t\t\t\t\t\t\tdisplayTitle={true}\n\t\t\t\t\t\t\t\t\tonClick={onConnectUser}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<span>{t(\"games.watch_or_join\")}</span>\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\ticon=\"sign-in\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"games.seabattle.join_battle\")}\n\t\t\t\t\t\t\t\t\tsize=\"L\"\n\t\t\t\t\t\t\t\t\tdisplayTitle={true}\n\t\t\t\t\t\t\t\t\tonClick={onJoinBattle}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t\t<div className=\"SeaBattlePlayer other\">\n\t\t\t\t<SeaBattleOpponentControls\n\t\t\t\t\topponentsCount={opponentMaps?.length || 0}\n\t\t\t\t\topponentIndex={opponentIndex}\n\t\t\t\t\tonSelectPreviousOpponent={\n\t\t\t\t\t\topponentMaps && opponentMaps.length > 0\n\t\t\t\t\t\t\t? () =>\n\t\t\t\t\t\t\t\t\tsetSelectedOpponent(\n\t\t\t\t\t\t\t\t\t\topponentIndex === 0\n\t\t\t\t\t\t\t\t\t\t\t? opponentMaps.length - 1\n\t\t\t\t\t\t\t\t\t\t\t: opponentIndex - 1\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t: void 0\n\t\t\t\t\t}\n\t\t\t\t\tonSelectNextOpponent={\n\t\t\t\t\t\topponentMaps && opponentMaps.length > 0\n\t\t\t\t\t\t\t? () =>\n\t\t\t\t\t\t\t\t\tsetSelectedOpponent(\n\t\t\t\t\t\t\t\t\t\t(opponentIndex + 1) %\n\t\t\t\t\t\t\t\t\t\t\topponentMaps?.length\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t: void 0\n\t\t\t\t\t}\n\t\t\t\t\tonSelectWeaponType={setSelectedWeaponType}\n\t\t\t\t\tweapons={playerMap?.weapons || {}}\n\t\t\t\t\tweaponType={weaponType}\n\t\t\t\t/>\n\t\t\t\t<Map\n\t\t\t\t\tmap={\n\t\t\t\t\t\topponentMaps && opponentMaps.length > 0\n\t\t\t\t\t\t\t? opponentMaps[opponentIndex]\n\t\t\t\t\t\t\t: void 0\n\t\t\t\t\t}\n\t\t\t\t\thideFleet={true}\n\t\t\t\t\tonCellClick={onOpponentCellClick}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n","export const KEY_UP = 38;\nexport const KEY_DOWN = 40;\nexport const KEY_LEFT = 37;\nexport const KEY_RIGHT = 39;\n","import { RootState } from \"../reducers\";\n\n// ------------------------------------------------------------------\n\nexport const selectMessages = (state: RootState) =>\n\tObject.values(state.messages).sort((m1, m2) =>\n\t\tm1.weight !== m2.weight ? m1.weight - m2.weight : m1.stamp - m2.stamp\n\t);\n","import React, { FC } from \"react\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\nimport classNames from \"classnames\";\nimport { TransitionGroup, CSSTransition } from \"react-transition-group\";\n//\nimport { Message } from \"../../utils/messages\";\nimport { selectMessages } from \"../../selectors/messages\";\nimport { RootState } from \"../../reducers\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { Dispatch } from \"../../actions\";\nimport { removeMessage } from \"../../reducers/messages\";\nimport \"./Messages.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Messages: FC<{\n\tclassName?: string;\n\tbottomPosition?: string;\n}> = ({ className, bottomPosition }) => {\n\tconst { t } = useTranslation();\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst messages = useSelector<RootState, Message[]>(selectMessages);\n\treturn (\n\t\t<div\n\t\t\tclassName={classNames(\"Messages\", className)}\n\t\t\tstyle={{ bottom: bottomPosition }}>\n\t\t\t<TransitionGroup>\n\t\t\t\t{messages.map(({ closable, extra, id, text, type }) => (\n\t\t\t\t\t<CSSTransition\n\t\t\t\t\t\tkey={id}\n\t\t\t\t\t\tclassNames=\"Message\"\n\t\t\t\t\t\ttimeout={{ enter: 200, exit: 200 }}>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclassName={classNames(\n\t\t\t\t\t\t\t\t\"Message\",\n\t\t\t\t\t\t\t\t\"Message-\" + type\n\t\t\t\t\t\t\t)}>\n\t\t\t\t\t\t\t<div className=\"MessageBody\">\n\t\t\t\t\t\t\t\t{text ? t(text) : null}\n\t\t\t\t\t\t\t\t{extra ? extra() : null}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t{closable ? (\n\t\t\t\t\t\t\t\t<div className=\"MessageActions\">\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\ticon=\"close\"\n\t\t\t\t\t\t\t\t\t\ttitle={t(\"clear\")}\n\t\t\t\t\t\t\t\t\t\tonClick={() =>\n\t\t\t\t\t\t\t\t\t\t\tdispatch(removeMessage(id))\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t) : null}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</CSSTransition>\n\t\t\t\t))}\n\t\t\t</TransitionGroup>\n\t\t</div>\n\t);\n};\n","import React, { FC, useEffect } from \"react\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { useLocation, useParams } from \"react-router-dom\";\nimport classNames from \"classnames\";\nimport qs from \"qs\";\n//\nimport { Head } from \"../components/Room/Head\";\nimport { Queue } from \"../components/Room/Queue\";\nimport { RoomControls } from \"../components/Room/RoomControls\";\nimport { RootState } from \"../reducers\";\nimport { CombinedColor } from \"../utils/colorpicker\";\nimport { exitRoom, enterRoom } from \"../actions/room\";\nimport { Dispatch } from \"../actions\";\nimport { RoomInfo } from \"../utils/rooms\";\nimport { SeaBattle } from \"./games/SeaBattle\";\nimport { Messages } from \"../components/Common/Messages\";\nimport { openModal } from \"../reducers/modals\";\nimport \"./Room.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Room: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { fg, bg } = useSelector<RootState, CombinedColor>(\n\t\tstate => state.room.color\n\t);\n\tconst info = useSelector<RootState, RoomInfo | null>(\n\t\tstate => state.room.info\n\t);\n\n\tconst { search } = useLocation();\n\tconst { dbId, roomId } = useParams<{\n\t\tdbId: string;\n\t\troomId: string;\n\t}>();\n\n\tconst { secret = \"\" } = qs.parse(search.substr(1)) as {\n\t\tsecret?: string;\n\t};\n\n\tuseEffect(() => {\n\t\tdispatch(enterRoom({ dbId, roomId, secret }));\n\n\t\treturn () => {\n\t\t\tdispatch(exitRoom());\n\t\t};\n\t}, [dispatch, dbId, roomId, secret]);\n\n\tuseEffect(() => {\n\t\tdocument.body.className = fg;\n\t\tdocument.body.style.backgroundColor = `rgb(${bg.r}, ${bg.g}, ${bg.b})`;\n\t}, [bg, fg]);\n\n\treturn (\n\t\t<div className={classNames(\"Room\")}>\n\t\t\t<Head />\n\t\t\t{(() => {\n\t\t\t\tif (!info) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tswitch (info.type) {\n\t\t\t\t\tcase \"blind\":\n\t\t\t\t\t\treturn null;\n\t\t\t\t\tcase \"dj\":\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<Queue />\n\t\t\t\t\t\t\t\t<RoomControls\n\t\t\t\t\t\t\t\t\textended={true}\n\t\t\t\t\t\t\t\t\tpropagate={true}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<Messages\n\t\t\t\t\t\t\t\t\tclassName=\"QueueMessages\"\n\t\t\t\t\t\t\t\t\tbottomPosition=\"120px\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t);\n\t\t\t\t\tcase \"seabattle\":\n\t\t\t\t\t\treturn (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<SeaBattle />\n\t\t\t\t\t\t\t\t<RoomControls\n\t\t\t\t\t\t\t\t\textended={false}\n\t\t\t\t\t\t\t\t\tpropagate={false}\n\t\t\t\t\t\t\t\t\tonHelp={() => {\n\t\t\t\t\t\t\t\t\t\tdispatch(\n\t\t\t\t\t\t\t\t\t\t\topenModal({\n\t\t\t\t\t\t\t\t\t\t\t\ttype: \"SeaBattle/Help\",\n\t\t\t\t\t\t\t\t\t\t\t\tprops: null\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t<Messages\n\t\t\t\t\t\t\t\t\tclassName=\"SeaBattleMessages\"\n\t\t\t\t\t\t\t\t\tbottomPosition=\"50px\"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t})()}\n\t\t</div>\n\t);\n};\n","import * as firebase from \"firebase/app\";\nimport \"firebase/database\";\n//\nimport { UserInfo } from \"../users\";\nimport { createOrGetApp } from \".\";\n\n// ------------------------------------------------------------------\n\nexport const FirebaseUser = ({\n\tdbId,\n\tuserId,\n\tsecret\n}: {\n\tdbId: string;\n\tuserId: string;\n\tsecret?: string;\n}) => {\n\tconst app = createOrGetApp(dbId);\n\tconst _user = app.users.child(userId);\n\tconst _info = _user.child(\"info\");\n\tlet _secret = secret || \"\";\n\tlet _values: UserInfo = {\n\t\tname: \"dummy\",\n\t\tonline: false\n\t};\n\n\tconst isLocked = () => !_secret;\n\n\tconst setSecret = (newSecret: string) => {\n\t\tconsole.debug(\"[Firebase] Setting user secret...\", {\n\t\t\toldSecret: _secret,\n\t\t\tnewSecret\n\t\t});\n\t\t_secret = newSecret;\n\t};\n\n\tconst wait = async (): Promise<UserInfo> => {\n\t\ttry {\n\t\t\tconsole.debug(\"[Firebase] Waiting user...\");\n\t\t\tconst info = await _info.once(\"value\");\n\t\t\t_values = info.val();\n\t\t\tupdate({}); // to force online status\n\t\t\treturn _values;\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"user.errors.invalid\");\n\t\t}\n\t};\n\n\tconst subscribeInfo = (cb: (info: UserInfo) => void) => {\n\t\tconsole.debug(\"[Firebase] Subscribing user...\");\n\t\treturn _info.on(\"value\", (snapshot: firebase.database.DataSnapshot) => {\n\t\t\tconst info = snapshot.val() as UserInfo | null;\n\t\t\tif (!info) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcb(info);\n\t\t});\n\t};\n\n\tconst unsubscribeInfo = (handler: any) => {\n\t\tconsole.debug(\"[Firebase] Unsubscribing user...\");\n\t\t_info.off(\"value\", handler);\n\t};\n\n\tconst update = async ({ name }: Partial<Pick<UserInfo, \"name\">>) => {\n\t\tconsole.debug(\"[Firebase] Initializing user...\", { name });\n\t\tif (name !== void 0) {\n\t\t\t_values.name = name;\n\t\t}\n\t\tawait _user.update({\n\t\t\tinfo: {\n\t\t\t\t..._values,\n\t\t\t\tonline: true\n\t\t\t},\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t\tinstallDisconnect();\n\t};\n\n\tconst installDisconnect = () => {\n\t\tconsole.debug(\"[Firebase] Installing user disconnect...\");\n\t\t_user.onDisconnect().cancel();\n\t\t_user.onDisconnect().update({\n\t\t\tinfo: {\n\t\t\t\t..._values,\n\t\t\t\tonline: false\n\t\t\t},\n\t\t\tsecret: _secret,\n\t\t\ttimestamp: firebase.database.ServerValue.TIMESTAMP\n\t\t});\n\t};\n\n\treturn {\n\t\tdbId,\n\t\tuserId,\n\t\tisLocked,\n\t\tsetSecret,\n\t\twait,\n\t\tsubscribeInfo,\n\t\tunsubscribeInfo,\n\t\tupdate\n\t};\n};\n","import { encode, decode } from \"./encoder\";\n\n// ------------------------------------------------------------------\n\nexport type UserInfo = {\n\tname: string;\n\tonline: boolean;\n};\n\nexport type UserAccess = {\n\tdbId: string;\n\tuserId: string;\n\tsecret: string;\n};\n\n// ------------------------------------------------------------------\n\nexport const loadUserAccess = (): UserAccess => {\n\tconst res: UserAccess = {\n\t\tdbId: \"\",\n\t\tuserId: \"\",\n\t\tsecret: \"\"\n\t};\n\tconst s = localStorage.getItem(\"U\");\n\tif (s) {\n\t\ttry {\n\t\t\tconst d = decode<UserAccess>(s);\n\t\t\tif (\n\t\t\t\ttypeof d.dbId === \"string\" &&\n\t\t\t\ttypeof d.userId === \"string\" &&\n\t\t\t\ttypeof d.secret === \"string\"\n\t\t\t) {\n\t\t\t\tres.dbId = d.dbId;\n\t\t\t\tres.userId = d.userId;\n\t\t\t\tres.secret = d.secret;\n\t\t\t\tconsole.debug(\"Loaded user access: \", res);\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tconsole.debug(\"User cannot be loaded: \", err);\n\t\t\tdeleteUserAccess();\n\t\t}\n\t}\n\treturn res;\n};\n\nexport const deleteUserAccess = () => {\n\tlocalStorage.removeItem(\"U\");\n};\n\nexport const saveUserAccess = (access: UserAccess) =>\n\tlocalStorage.setItem(\"U\", encode<UserAccess>(access));\n","import { Reducer } from \"redux\";\nimport {\n\tdeleteUserAccess,\n\tsaveUserAccess,\n\tloadUserAccess,\n\tUserAccess,\n\tUserInfo\n} from \"../utils/users\";\nimport { FirebaseUser } from \"../utils/firebase/user\";\nimport { createAction } from \"../actions\";\n\n// ------------------------------------------------------------------\n\ntype UserAction =\n\t| ReturnType<typeof fetching>\n\t| ReturnType<typeof error>\n\t| ReturnType<typeof resetUser>\n\t| ReturnType<typeof setUser>;\n\nexport const fetching = () => createAction(\"user/FETCHING\");\nexport const error = (error: string) => createAction(\"user/ERROR\", error);\nexport const resetUser = () => createAction(\"user/RESET\");\nexport const setUser = (values: Partial<UserData>) =>\n\tcreateAction(\"user/SET\", values);\n\n// ------------------------------------------------------------------\n\nexport type UserData = {\n\t_fbUser: ReturnType<typeof FirebaseUser> | null;\n\taccess: UserAccess;\n\tinfo: UserInfo | null;\n};\n\nexport type State = UserData & {\n\tfetching: boolean;\n\terror: null | string;\n};\n\nconst INITIAL_STATE: State = {\n\t_fbUser: null,\n\taccess: { dbId: \"\", userId: \"\", secret: \"\" },\n\terror: null,\n\tfetching: false,\n\tinfo: null\n};\n\n// ------------------------------------------------------------------\n\nexport const userReducer: Reducer<State, UserAction> = (\n\tstate = { ...INITIAL_STATE, access: loadUserAccess() },\n\taction: UserAction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"user/FETCHING\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: true,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"user/ERROR\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: false,\n\t\t\t\terror: action.payload\n\t\t\t};\n\t\tcase \"user/SET\": {\n\t\t\tconst copy = {\n\t\t\t\t...state,\n\t\t\t\t...action.payload,\n\t\t\t\tfetching: false,\n\t\t\t\terror: null\n\t\t\t};\n\t\t\tsaveUserAccess(copy.access);\n\t\t\treturn copy;\n\t\t}\n\t\tcase \"user/RESET\":\n\t\t\tdeleteUserAccess();\n\t\t\treturn INITIAL_STATE;\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import { v4 } from \"uuid\";\n//\nimport { AsyncAction, ActionOptions, trySomething } from \".\";\nimport { UserInfo } from \"../utils/users\";\nimport { FirebaseUser } from \"../utils/firebase/user\";\nimport { setUser, resetUser, fetching, error } from \"../reducers/user\";\n\n// ------------------------------------------------------------------\n\nexport const createUser = ({\n\tdbId,\n\tname,\n\tsecret,\n\toptions\n}: {\n\tdbId: string;\n\tname: string;\n\tsecret: string;\n\toptions?: ActionOptions;\n}): AsyncAction => dispatch =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconsole.debug(\"[User] Creating...\");\n\t\t\t\tconst userId = v4();\n\t\t\t\tawait FirebaseUser({ dbId, userId, secret }).update({ name });\n\t\t\t\tdispatch(connectUser({ dbId, userId, secret, options }));\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => {\n\t\t\t\tif (options?.onFailure) {\n\t\t\t\t\toptions.onFailure();\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nlet INFO_SUBSCRIPTION: any = null;\n\nexport const connectUser = ({\n\tdbId,\n\tuserId,\n\tsecret,\n\toptions\n}: {\n\tdbId: string;\n\tuserId: string;\n\tsecret: string;\n\toptions?: ActionOptions;\n}): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tuser: { _fbUser }\n\t\t\t\t} = getState();\n\t\t\t\tif (\n\t\t\t\t\t_fbUser &&\n\t\t\t\t\t_fbUser.dbId === dbId &&\n\t\t\t\t\t_fbUser.userId === userId\n\t\t\t\t) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\n\t\t\t\tdispatch(disconnectUser());\n\n\t\t\t\tdispatch(fetching());\n\n\t\t\t\tconsole.debug(\"[User] Connecting...\", { dbId, userId, secret });\n\t\t\t\tconst newFbUser = FirebaseUser({ dbId, userId, secret });\n\t\t\t\tdispatch(\n\t\t\t\t\tsetUser({\n\t\t\t\t\t\t_fbUser: newFbUser,\n\t\t\t\t\t\taccess: { dbId, userId, secret },\n\t\t\t\t\t\tinfo: await newFbUser.wait()\n\t\t\t\t\t})\n\t\t\t\t);\n\t\t\t\tINFO_SUBSCRIPTION = newFbUser.subscribeInfo(\n\t\t\t\t\t(newInfo: UserInfo) => {\n\t\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\t\"[User] Received user update...\",\n\t\t\t\t\t\t\tnewInfo\n\t\t\t\t\t\t);\n\t\t\t\t\t\tdispatch(setUser({ info: newInfo }));\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t\treturn true;\n\t\t\t},\n\t\t\tonFailure: () => {\n\t\t\t\tdispatch(error(\"Cannot connect\")); // TODO: wording\n\t\t\t\tdispatch(disconnectUser());\n\t\t\t\tif (options?.onFailure) {\n\t\t\t\t\toptions.onFailure();\n\t\t\t\t}\n\t\t\t},\n\t\t\t...options\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const disconnectUser = (): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tuser: {\n\t\t\t\t\t\t_fbUser,\n\t\t\t\t\t\taccess: { dbId, userId, secret }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!dbId && !userId && !secret && !_fbUser) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[User] Disconnecting...\", {\n\t\t\t\t\tdbId,\n\t\t\t\t\tuserId,\n\t\t\t\t\tsecret\n\t\t\t\t});\n\t\t\t\tif (_fbUser) {\n\t\t\t\t\t_fbUser.unsubscribeInfo(INFO_SUBSCRIPTION);\n\t\t\t\t\tINFO_SUBSCRIPTION = null;\n\t\t\t\t}\n\t\t\t\tdispatch(resetUser());\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n\n// ------------------------------------------------------------------\n\nexport const reconnectUser = (): AsyncAction => (dispatch, getState) =>\n\tdispatch(\n\t\ttrySomething({\n\t\t\tonAction: async () => {\n\t\t\t\tconst {\n\t\t\t\t\tuser: {\n\t\t\t\t\t\taccess: { dbId, userId, secret }\n\t\t\t\t\t}\n\t\t\t\t} = getState();\n\t\t\t\tif (!dbId || !userId || !secret) {\n\t\t\t\t\treturn true; // Nothing to do\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"[User] Reconnecting...\", {\n\t\t\t\t\tdbId,\n\t\t\t\t\tuserId,\n\t\t\t\t\tsecret\n\t\t\t\t});\n\t\t\t\tdispatch(connectUser({ dbId, userId, secret }));\n\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t);\n","import React, { FC, useCallback, useEffect } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { Link } from \"react-router-dom\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"../components/Common/IconButton\";\nimport { RootState } from \"../reducers\";\nimport { openModal } from \"../reducers/modals\";\nimport { disconnectUser } from \"../actions/user\";\nimport { clearMessages } from \"../reducers/messages\";\nimport { Messages } from \"../components/Common/Messages\";\nimport { Icon } from \"../components/Common/Icon\";\nimport \"./Splash.scss\";\n\n// ------------------------------------------------------------------\n\nexport const Splash: FC = () => {\n\tconst dispatch = useDispatch();\n\tconst fetching = useSelector<RootState, boolean>(\n\t\tstate => state.user.fetching\n\t);\n\tconst loggedIn = useSelector<RootState, boolean>(\n\t\tstate => !!state.user.access.dbId && !!state.user.access.userId\n\t);\n\tconst { t } = useTranslation();\n\n\tconst onCreateRoom = useCallback(\n\t\t() => dispatch(openModal({ type: \"Room/Create\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onCreateUser = useCallback(\n\t\t() => dispatch(openModal({ type: \"User/Create\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onConnectUser = useCallback(\n\t\t() => dispatch(openModal({ type: \"User/Connect\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onDisconnect = useCallback(() => dispatch(disconnectUser()), [\n\t\tdispatch\n\t]);\n\n\tconst onShowHelp = useCallback(\n\t\t() => dispatch(openModal({ type: \"General/Help\", props: null })),\n\t\t[dispatch]\n\t);\n\n\tuseEffect(() => {\n\t\tdispatch(clearMessages());\n\t}, [dispatch]);\n\n\t/*\n\t<div className=\"PoweredWith\">\n\t\t<span>{t(\"splash.powered_with\")}</span>\n\t\t<a\n\t\t\thref=\"https://www.deezer.com\"\n\t\t\ttarget=\"_blank\"\n\t\t\trel=\"noopener noreferrer\">\n\t\t\t<img\n\t\t\t\tsrc=\"/images/deezer.svg\"\n\t\t\t\theight=\"20px\"\n\t\t\t\ttitle=\"Deezer\"\n\t\t\t\talt=\"Deezer Logo\"\n\t\t\t/>\n\t\t</a>\n\t</div>\n\t*/\n\n\treturn (\n\t\t<>\n\t\t\t<div className=\"Splash\">\n\t\t\t\t<div className=\"Top\">\n\t\t\t\t\t<Link className=\"Logo\" to=\"/\">\n\t\t\t\t\t\t<img\n\t\t\t\t\t\t\tsrc=\"/images/logo.png\"\n\t\t\t\t\t\t\ttitle=\"Party\"\n\t\t\t\t\t\t\talt=\"Party Logo\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\tParty\n\t\t\t\t\t</Link>\n\t\t\t\t\t<div className=\"Description\">{t(\"splash.description\")}</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"Middle\">\n\t\t\t\t\t<div className=\"Menu\">\n\t\t\t\t\t\t{fetching ? (\n\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\t\t\tclassName=\"rotating\"\n\t\t\t\t\t\t\t\t\ticon=\"refresh\"\n\t\t\t\t\t\t\t\t\tsize=\"XL\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"loading\")}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t) : loggedIn ? (\n\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tonClick={onCreateRoom}\n\t\t\t\t\t\t\t\t\ticon=\"play\"\n\t\t\t\t\t\t\t\t\tsize=\"XL\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"rooms.create\")}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<>\n\t\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tonClick={onCreateUser}\n\t\t\t\t\t\t\t\t\t\ticon=\"user-plus\"\n\t\t\t\t\t\t\t\t\t\tsize=\"XL\"\n\t\t\t\t\t\t\t\t\t\ttitle={t(\"user.create\")}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\t\tonClick={onConnectUser}\n\t\t\t\t\t\t\t\t\t\ticon=\"sign-in\"\n\t\t\t\t\t\t\t\t\t\tsize=\"XL\"\n\t\t\t\t\t\t\t\t\t\ttitle={t(\"user.connect\")}\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"Bottom\">\n\t\t\t\t\t<div className=\"Menu\">\n\t\t\t\t\t\t{fetching ? null : loggedIn ? (\n\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\ticon=\"sign-out\"\n\t\t\t\t\t\t\t\t\tonClick={onDisconnect}\n\t\t\t\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"user.disconnect\")}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t) : (\n\t\t\t\t\t\t\t<div className=\"MenuItem\">\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\ticon=\"question-circle\"\n\t\t\t\t\t\t\t\t\tonClick={onShowHelp}\n\t\t\t\t\t\t\t\t\tsize=\"L\"\n\t\t\t\t\t\t\t\t\ttitle={t(\"help.help\")}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Messages />\n\t\t</>\n\t);\n};\n","import React, { FC, FormEvent, ReactNode, useCallback } from \"react\";\nimport classNames from \"classnames\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"../Common/IconButton\";\nimport { useSelector, useDispatch } from \"react-redux\";\nimport { RootState } from \"../../reducers\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal, closeModal } from \"../../reducers/modals\";\n\n// ------------------------------------------------------------------\n\nexport const Modal: FC<{\n\tchildren: ReactNode;\n\tclassName?: string;\n\ttitle: string;\n\trenderFoot?: () => React.ReactNode;\n\tonSubmit?: () => void;\n}> = ({ children, className, title, renderFoot, onSubmit }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { t } = useTranslation();\n\tconst has_prev_modal = useSelector<RootState, boolean>(\n\t\tstate => state.modals.stack.length > 1\n\t);\n\n\tconst onClose = useCallback(() => dispatch(closeModal()), [dispatch]);\n\n\tconst onPop = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\treturn (\n\t\t<form\n\t\t\tclassName={classNames(\"Modal\", className)}\n\t\t\tonSubmit={(event: FormEvent<HTMLFormElement>) => {\n\t\t\t\tevent.preventDefault();\n\t\t\t\tif (onSubmit) {\n\t\t\t\t\tonSubmit();\n\t\t\t\t}\n\t\t\t}}>\n\t\t\t<div className=\"ModalHead\">\n\t\t\t\t<IconButton\n\t\t\t\t\tkind=\"special\"\n\t\t\t\t\tclassName={classNames(\"ModalHeadBack\", {\n\t\t\t\t\t\thidden: !has_prev_modal\n\t\t\t\t\t})}\n\t\t\t\t\ticon=\"angle-left\"\n\t\t\t\t\ttitle=\"Back\"\n\t\t\t\t\tonClick={onPop}\n\t\t\t\t/>\n\t\t\t\t<div className=\"ModalTitle\">{title}</div>\n\t\t\t\t<IconButton\n\t\t\t\t\tkind=\"special\"\n\t\t\t\t\tclassName=\"ModalHeadClose\"\n\t\t\t\t\tonClick={onClose}\n\t\t\t\t\ttitle={t(\"cancel\")}\n\t\t\t\t\ticon=\"times\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div className=\"ModalBody\">{children}</div>\n\t\t\t<div className=\"ModalFoot\">{renderFoot && renderFoot()}</div>\n\t\t</form>\n\t);\n};\n","import React, { FC, ReactNode } from \"react\";\nimport classNames from \"classnames\";\n//\nimport { Modal } from \"./Modal\";\nimport \"./FormModal.scss\";\n\n// ------------------------------------------------------------------\n\nexport const FormModal: FC<{\n\tchildren: ReactNode;\n\tclassName?: string;\n\tonSubmit: () => void;\n\trenderButtons: () => React.ReactNode;\n\ttitle: string;\n}> = ({ children, className, renderButtons, title, onSubmit }) => (\n\t<Modal\n\t\tclassName={classNames(\"FormModal\", className)}\n\t\ttitle={title}\n\t\trenderFoot={renderButtons}\n\t\tonSubmit={onSubmit}>\n\t\t{children}\n\t</Modal>\n);\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { IconButton } from \"./IconButton\";\n\n// ------------------------------------------------------------------\n\nexport const CancelButton: FC<{ onClick: () => void }> = ({ onClick }) => {\n\tconst { t } = useTranslation();\n\treturn (\n\t\t<IconButton\n\t\t\tonClick={onClick}\n\t\t\ttitle={t(\"cancel\")}\n\t\t\tkind=\"default\"\n\t\t\ticon=\"ban\"\n\t\t/>\n\t);\n};\n","import React, { FC, useCallback } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport { useDispatch } from \"react-redux\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal } from \"../../reducers/modals\";\n\n// ------------------------------------------------------------------\n\nexport type ConfirmModalProps = {\n\tquestion: string;\n\tonCanceled?: () => void;\n\tonConfirmed: () => void;\n};\n\nexport const ConfirmModal: FC<ConfirmModalProps> = ({\n\tquestion,\n\tonCanceled,\n\tonConfirmed\n}) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { t } = useTranslation();\n\n\tconst onCancel = useCallback(() => {\n\t\tdispatch(popModal());\n\t\tif (onCanceled) {\n\t\t\tonCanceled();\n\t\t}\n\t}, [dispatch, onCanceled]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"confirm\")}\n\t\t\tonSubmit={onConfirmed}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ttitle={t(\"confirm\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"plus\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onCancel} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t{question}\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, forwardRef, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { copyToClipboard } from \"../../utils/clipboard\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { displaySuccess } from \"../../actions/messages\";\n\n// ------------------------------------------------------------------\n\nexport const ModalField = ({ children }: { children?: React.ReactNode }) => (\n\t<div className=\"ModalField\">{children}</div>\n);\n\n// ------------------------------------------------------------------\n\nexport const InputField = forwardRef(\n\t(\n\t\tprops: { label: string } & React.DetailedHTMLProps<\n\t\t\tReact.InputHTMLAttributes<HTMLInputElement>,\n\t\t\tHTMLInputElement\n\t\t>,\n\t\tref: React.Ref<HTMLInputElement>\n\t) => (\n\t\t<ModalField>\n\t\t\t<div className=\"XXX\">\n\t\t\t\t<label htmlFor={props.id}>{props.label}</label>\n\t\t\t\t<input ref={ref} {...props} />\n\t\t\t</div>\n\t\t</ModalField>\n\t)\n);\n\n// ------------------------------------------------------------------\n\nexport const SECRET_FIELD_SIZE = 36;\n\nexport const SecretField: FC<{\n\tid: string;\n\tlabel: string;\n\tonChange: (value: string) => void;\n\tplaceholder: string;\n\tvalue: string;\n}> = ({ id, label, onChange, placeholder, value }) => {\n\tconst dispatch = useDispatch();\n\tconst { t } = useTranslation();\n\n\tconst onCopyToClipboard = useCallback(async () => {\n\t\tawait copyToClipboard(value);\n\t\tdispatch(displaySuccess(\"secret_copied_to_clipboard\"));\n\t}, [dispatch, value]);\n\n\treturn (\n\t\t<ModalField>\n\t\t\t<div className=\"XXX\">\n\t\t\t\t<label htmlFor={id}>{label}</label>\n\t\t\t\t<div\n\t\t\t\t\tstyle={{\n\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\tflexDirection: \"row\",\n\t\t\t\t\t\tjustifyContent: \"space-between\"\n\t\t\t\t\t}}>\n\t\t\t\t\t<input\n\t\t\t\t\t\tstyle={{\n\t\t\t\t\t\t\tflexGrow: 1,\n\t\t\t\t\t\t\tmarginRight: \"0.5rem\"\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tid={id}\n\t\t\t\t\t\ttype=\"password\"\n\t\t\t\t\t\tautoComplete=\"password\"\n\t\t\t\t\t\tplaceholder={placeholder}\n\t\t\t\t\t\tmaxLength={SECRET_FIELD_SIZE}\n\t\t\t\t\t\tminLength={SECRET_FIELD_SIZE}\n\t\t\t\t\t\trequired={true}\n\t\t\t\t\t\tvalue={value}\n\t\t\t\t\t\tonChange={e => onChange(e.target.value)}\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"clipboard\"\n\t\t\t\t\t\tonClick={onCopyToClipboard}\n\t\t\t\t\t\tsize=\"M\"\n\t\t\t\t\t\ttitle={t(\"copy_to_clipboard\")}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</ModalField>\n\t);\n};\n\n// ------------------------------------------------------------------\n\nexport const SelectField = forwardRef(\n\t(\n\t\tprops: {\n\t\t\tlabel: string;\n\t\t\toptions: Array<{ id: string; label: string }>;\n\t\t} & React.DetailedHTMLProps<\n\t\t\tReact.InputHTMLAttributes<HTMLSelectElement>,\n\t\t\tHTMLSelectElement\n\t\t>,\n\t\tref: React.Ref<HTMLSelectElement>\n\t) => (\n\t\t<ModalField>\n\t\t\t<div className=\"XXX\">\n\t\t\t\t<label htmlFor={props.id}>{props.label}</label>\n\t\t\t\t<select ref={ref} {...props}>\n\t\t\t\t\t{props.options\n\t\t\t\t\t\t.sort((a, b) => a.label.localeCompare(b.label))\n\t\t\t\t\t\t.map(option => (\n\t\t\t\t\t\t\t<option key={option.id} value={option.id}>\n\t\t\t\t\t\t\t\t{option.label}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t</select>\n\t\t\t</div>\n\t\t</ModalField>\n\t)\n);\n","import React, { FC, useRef, useState, useEffect, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport { popModal } from \"../../reducers/modals\";\nimport { displayError } from \"../../actions/messages\";\nimport { connectUser } from \"../../actions/user\";\nimport { Dispatch, ActionOptions } from \"../../actions\";\nimport { SECRET_FIELD_SIZE, InputField } from \"../Modals/ModalFields\";\nimport { selectUserDatabaseId } from \"../../config/firebase\";\n\n// ------------------------------------------------------------------\n\nexport type ConnectUserModalProps = { options?: ActionOptions };\n\nexport const ConnectUserModal: FC<ConnectUserModalProps> = ({ options }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst [userId, setUserId] = useState(\"\");\n\tconst [secret, setSecret] = useState(\"\");\n\tconst userIdRef = useRef<HTMLInputElement>(null);\n\tconst { t } = useTranslation();\n\n\tuseEffect(() => {\n\t\tif (userIdRef.current) {\n\t\t\tuserIdRef.current.focus();\n\t\t}\n\t}, [userIdRef]);\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onConnect = useCallback(() => {\n\t\tif (userId.trim().length === 0) {\n\t\t\tdispatch(displayError(\"user.id_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tif (secret.trim().length === 0) {\n\t\t\tdispatch(displayError(\"user.secret_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tdispatch(\n\t\t\tconnectUser({\n\t\t\t\tdbId: selectUserDatabaseId(),\n\t\t\t\tuserId,\n\t\t\t\tsecret,\n\t\t\t\toptions: {\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tif (options && options.onSuccess) {\n\t\t\t\t\t\t\toptions.onSuccess();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdispatch(popModal());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}, [dispatch, userId, secret, options]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"user.connection\")}\n\t\t\tonSubmit={onConnect}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tuserId.trim().length === 0 ||\n\t\t\t\t\t\t\tuserId.length !== 36 ||\n\t\t\t\t\t\t\tsecret.length !== SECRET_FIELD_SIZE\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttitle={t(\"user.connect\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"check\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-userId\"\n\t\t\t\tlabel={t(\"user.id\")}\n\t\t\t\ttype=\"text\"\n\t\t\t\tplaceholder={t(\"user.id_placeholder\")}\n\t\t\t\tmaxLength={36}\n\t\t\t\tminLength={36}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={userId}\n\t\t\t\tref={userIdRef}\n\t\t\t\tonChange={e => setUserId(e.target.value)}\n\t\t\t/>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-secret\"\n\t\t\t\tlabel={t(\"user.secret\")}\n\t\t\t\ttype=\"password\"\n\t\t\t\tautoComplete=\"password\"\n\t\t\t\tplaceholder={t(\"user.secret_placeholder\")}\n\t\t\t\tmaxLength={36}\n\t\t\t\tminLength={36}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={secret}\n\t\t\t\tonChange={e => setSecret(e.target.value)}\n\t\t\t/>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, useState, useRef, useEffect, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\nimport { v4 } from \"uuid\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport {\n\tInputField,\n\tSecretField,\n\tSECRET_FIELD_SIZE,\n\tSelectField\n} from \"../Modals/ModalFields\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal } from \"../../reducers/modals\";\nimport { createRoom } from \"../../actions/room\";\nimport { displayError } from \"../../actions/messages\";\nimport { RoomType, RoomTypes, DEFAULT_ROOM_TYPE } from \"../../utils/rooms\";\nimport { selectRoomDatabaseId } from \"../../config/firebase\";\n\n// ------------------------------------------------------------------\n\nlet ROOM_COUNTER = 1;\n\n// ------------------------------------------------------------------\n\nexport type CreateRoomModalProps = {\n\ttype?: RoomType;\n};\n\nexport const CreateRoomModal: FC<CreateRoomModalProps> = ({\n\ttype: defaultType = DEFAULT_ROOM_TYPE\n}) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst [name, setName] = useState(\"\");\n\tconst [secret, setSecret] = useState(v4());\n\tconst [type, setType] = useState<RoomType>(defaultType);\n\tconst nameRef = useRef<HTMLInputElement>(null);\n\tconst { t } = useTranslation();\n\n\tuseEffect(() => {\n\t\tsetName(`${t(\"rooms.room\")} ${ROOM_COUNTER}`);\n\t\tif (nameRef.current) {\n\t\t\tnameRef.current.focus();\n\t\t}\n\t}, [t, nameRef]);\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onCreate = useCallback(() => {\n\t\tif (name.trim().length === 0) {\n\t\t\tdispatch(displayError(\"rooms.name_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tif (secret.trim().length === 0) {\n\t\t\tdispatch(displayError(\"rooms.secret_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tdispatch(\n\t\t\tcreateRoom({\n\t\t\t\tdbId: selectRoomDatabaseId(),\n\t\t\t\tname,\n\t\t\t\tsecret,\n\t\t\t\ttype,\n\t\t\t\toptions: {\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tdispatch(popModal());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t\tROOM_COUNTER++;\n\t}, [dispatch, name, secret, type]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"rooms.room_creation\")}\n\t\t\tonSubmit={onCreate}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tname.trim().length === 0 ||\n\t\t\t\t\t\t\tsecret.length !== SECRET_FIELD_SIZE\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttitle={t(\"rooms.create\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"check\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-name\"\n\t\t\t\tlabel={t(\"rooms.name\")}\n\t\t\t\ttype=\"text\"\n\t\t\t\tplaceholder={t(\"rooms.name_placeholder\")}\n\t\t\t\tmaxLength={100}\n\t\t\t\tminLength={2}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={name}\n\t\t\t\tref={nameRef}\n\t\t\t\tonChange={e => setName(e.target.value)}\n\t\t\t/>\n\t\t\t<SecretField\n\t\t\t\tid=\"modal-secret\"\n\t\t\t\tlabel={t(\"rooms.key\")}\n\t\t\t\tplaceholder={t(\"rooms.key_placeholder\")}\n\t\t\t\tvalue={secret}\n\t\t\t\tonChange={setSecret}\n\t\t\t/>\n\t\t\t<SelectField\n\t\t\t\tid=\"modal-type\"\n\t\t\t\tlabel={t(\"rooms.type\")}\n\t\t\t\tplaceholder={t(\"rooms.type_placeholder\")}\n\t\t\t\toptions={RoomTypes.map(type => ({\n\t\t\t\t\tid: type,\n\t\t\t\t\tlabel: t(`rooms.types.${type}`)\n\t\t\t\t}))}\n\t\t\t\tvalue={type}\n\t\t\t\tonChange={e => setType(e.target.value as RoomType)}\n\t\t\t/>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, useState, useEffect, useRef, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\nimport { v4 } from \"uuid\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport {\n\tSecretField,\n\tSECRET_FIELD_SIZE,\n\tInputField\n} from \"../Modals/ModalFields\";\nimport { popModal } from \"../../reducers/modals\";\nimport { displayError } from \"../../actions/messages\";\nimport { createUser } from \"../../actions/user\";\nimport { Dispatch, ActionOptions } from \"../../actions\";\nimport { selectUserDatabaseId } from \"../../config/firebase\";\n\n// ------------------------------------------------------------------\n\nlet USER_COUNTER = 1;\n\n// ------------------------------------------------------------------\n\nexport type CreateUserModalProps = { options?: ActionOptions };\n\nexport const CreateUserModal: FC<CreateUserModalProps> = ({ options }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst [name, setName] = useState(\"\");\n\tconst [secret, setSecret] = useState(v4());\n\tconst nameRef = useRef<HTMLInputElement>(null);\n\tconst { t } = useTranslation();\n\n\tuseEffect(() => {\n\t\tsetName(`${t(\"user.user\")} ${USER_COUNTER}`);\n\t\tif (nameRef.current) {\n\t\t\tnameRef.current.focus();\n\t\t}\n\t}, [t, nameRef]);\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onCreate = useCallback(() => {\n\t\tif (name.trim().length === 0) {\n\t\t\tdispatch(displayError(\"user.name_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tif (secret.trim().length === 0) {\n\t\t\tdispatch(displayError(\"user.secret_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tdispatch(\n\t\t\tcreateUser({\n\t\t\t\tdbId: selectUserDatabaseId(),\n\t\t\t\tname,\n\t\t\t\tsecret,\n\t\t\t\toptions: {\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tif (options && options.onSuccess) {\n\t\t\t\t\t\t\toptions.onSuccess();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdispatch(popModal());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t\tUSER_COUNTER++;\n\t}, [dispatch, name, secret, options]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"user.user_creation\")}\n\t\t\tonSubmit={onCreate}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\tname.trim().length === 0 ||\n\t\t\t\t\t\t\tsecret.length !== SECRET_FIELD_SIZE\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttitle={t(\"user.create\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"check\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-name\"\n\t\t\t\tlabel={t(\"user.name\")}\n\t\t\t\ttype=\"text\"\n\t\t\t\tplaceholder={t(\"user.name_placeholder\")}\n\t\t\t\tmaxLength={100}\n\t\t\t\tminLength={2}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={name}\n\t\t\t\tref={nameRef}\n\t\t\t\tonChange={e => setName(e.target.value)}\n\t\t\t/>\n\t\t\t<SecretField\n\t\t\t\tid=\"modal-secret\"\n\t\t\t\tlabel={t(\"user.secret\")}\n\t\t\t\tplaceholder={t(\"user.secret_placeholder\")}\n\t\t\t\tvalue={secret}\n\t\t\t\tonChange={newSecret => setSecret(newSecret)}\n\t\t\t/>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, useCallback } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useDispatch } from \"react-redux\";\n//\nimport { Modal } from \"../Modals/Modal\";\nimport { openModal } from \"../../reducers/modals\";\nimport { Dispatch } from \"../../actions\";\nimport { IconButton } from \"../Common/IconButton\";\nimport \"./HelpModal.scss\";\n\n// ------------------------------------------------------------------\n\nexport const HelpModal: FC = () => {\n\tconst { t } = useTranslation();\n\tconst dispatch = useDispatch<Dispatch>();\n\n\tconst onCreateRoom = useCallback(\n\t\t() => dispatch(openModal({ type: \"Room/Create\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onJoinRoom = useCallback(\n\t\t() => dispatch(openModal({ type: \"Room/Join\", props: null })),\n\t\t[dispatch]\n\t);\n\n\tconst onCreateUser = useCallback(\n\t\t() => dispatch(openModal({ type: \"User/Create\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\tconst onConnectUser = useCallback(\n\t\t() => dispatch(openModal({ type: \"User/Connect\", props: {} })),\n\t\t[dispatch]\n\t);\n\n\treturn (\n\t\t<Modal className=\"HelpModal\" title={t(\"help.help\")}>\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">{t(\"help.rules\")}</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"help.rule1\")}&nbsp;\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"user-plus\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"user.create\")}\n\t\t\t\t\t\t\tonClick={onCreateUser}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"help.rule1b\")}&nbsp;\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"sign-in\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"user.connect\")}\n\t\t\t\t\t\t\tonClick={onConnectUser}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"help.rule2\")}&nbsp;\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"play\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"rooms.create\")}\n\t\t\t\t\t\t\tonClick={onCreateRoom}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"help.rule2b\")}&nbsp;\n\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\ticon=\"sign-in\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"rooms.join\")}\n\t\t\t\t\t\t\tonClick={onJoinRoom}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">{t(\"help.notes\")}</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>{t(\"help.note1\")}</li>\n\t\t\t\t\t<li>{t(\"help.note2\")}</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\t\t</Modal>\n\t);\n};\n","import React, { FC, useCallback } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { Icon } from \"../Common/Icon\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { useDispatch } from \"react-redux\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal, openModal } from \"../../reducers/modals\";\nimport { useHistory } from \"react-router-dom\";\nimport \"./GameOverModal.scss\";\n\n// ------------------------------------------------------------------\n\nexport type SeaBattleGameOverModalProps = {\n\tstatus: \"looser\" | \"winner\";\n};\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleGameOverModal: FC<SeaBattleGameOverModalProps> = ({\n\tstatus\n}) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst history = useHistory();\n\tconst { t } = useTranslation();\n\n\tconst onRestart = useCallback(() => {\n\t\tdispatch(\n\t\t\topenModal({ type: \"Room/Create\", props: { type: \"seabattle\" } })\n\t\t);\n\t}, [dispatch]);\n\n\tconst onExit = useCallback(() => {\n\t\thistory.push(\"/\");\n\t\tdispatch(popModal());\n\t}, [dispatch, history]);\n\n\treturn (\n\t\t<FormModal\n\t\t\tclassName=\"SeaBattleGameOverModal\"\n\t\t\tonSubmit={onRestart}\n\t\t\ttitle={t(\"games.gameover\")}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ttitle={t(\"restart\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"repeat\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ttitle={t(\"exit\")}\n\t\t\t\t\t\ticon=\"home\"\n\t\t\t\t\t\tonClick={onExit}\n\t\t\t\t\t/>\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<div>\n\t\t\t\t<Icon\n\t\t\t\t\ticon={status === \"winner\" ? \"trophy\" : \"anchor\"}\n\t\t\t\t\tsize=\"L\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t{t(\n\t\t\t\t\tstatus === \"winner\"\n\t\t\t\t\t\t? \"games.seabattle.you_won1\"\n\t\t\t\t\t\t: \"games.seabattle.you_lost1\"\n\t\t\t\t)}\n\t\t\t</div>\n\t\t\t<div>\n\t\t\t\t{t(\n\t\t\t\t\tstatus === \"winner\"\n\t\t\t\t\t\t? \"games.seabattle.you_won2\"\n\t\t\t\t\t\t: \"games.seabattle.you_lost2\"\n\t\t\t\t)}\n\t\t\t</div>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC } from \"react\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { Modal } from \"../Modals/Modal\";\nimport { Icon } from \"../Common/Icon\";\nimport { WeaponSelection } from \"./WeaponSelection\";\nimport \"./HelpModal.scss\";\n\n// ------------------------------------------------------------------\n\nexport const SeaBattleHelpModal: FC = () => {\n\tconst { t } = useTranslation();\n\treturn (\n\t\t<Modal className=\"SeaBattleHelpModal\" title={t(\"help.help\")}>\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">\n\t\t\t\t\t{t(\"games.seabattle.help.you_can\")}\n\t\t\t\t</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.move_boat\")}</li>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.attack_opponent\")}</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">\n\t\t\t\t\t{t(\"games.seabattle.help.to_move\")}\n\t\t\t\t</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.select_boat\")}</li>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.move_with_keyboard\")}</li>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"games.seabattle.help.or_use_the_buttons\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"rotate-left\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.turn_left\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.turn_left\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"rotate-right\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.turn_right\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.turn_right\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"arrow-down\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.move_down\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.move_down\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"arrow-up\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.move_up\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.move_up\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"arrow-left\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.move_left\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.move_left\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<Icon\n\t\t\t\t\t\t\ticon=\"arrow-right\"\n\t\t\t\t\t\t\tsize=\"S\"\n\t\t\t\t\t\t\ttitle={t(\"games.seabattle.move_right\")}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t&nbsp;{t(\"games.seabattle.move_right\")}\n\t\t\t\t\t</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">\n\t\t\t\t\t{t(\"games.seabattle.help.to_attack\")}\n\t\t\t\t</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>\n\t\t\t\t\t\t{t(\"games.seabattle.help.select_weapon\")}\n\t\t\t\t\t\t<br />\n\t\t\t\t\t\t<WeaponSelection\n\t\t\t\t\t\t\tweapons={{\n\t\t\t\t\t\t\t\tbullet1: 1,\n\t\t\t\t\t\t\t\tbullet2: 1,\n\t\t\t\t\t\t\t\tbullet3: 0,\n\t\t\t\t\t\t\t\tmine: 1\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\tweaponType={\"bullet1\"}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</li>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.click_opponent_cell\")}</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\n\t\t\t<div className=\"HelpModalSection\">\n\t\t\t\t<div className=\"HelpModalSectionTitle\">\n\t\t\t\t\t{t(\"games.seabattle.help.to_react\")}\n\t\t\t\t</div>\n\t\t\t\t<ul>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.missed_hit\")}</li>\n\t\t\t\t\t<li>{t(\"games.seabattle.help.hitted_hit\")}</li>\n\t\t\t\t</ul>\n\t\t\t</div>\n\t\t</Modal>\n\t);\n};\n","import React, { FC, ReactNode } from \"react\";\n//\nimport { Media } from \"../../utils/medias\";\nimport { ModalField } from \"../Modals/ModalFields\";\nimport { IconButton } from \"../Common/IconButton\";\n\n// ------------------------------------------------------------------\n\nexport const SearchResultCategory: FC<{\n\titems: Media[];\n\tlabel: string;\n\tonViewMore: () => void;\n\tcb: (item: Media) => ReactNode;\n}> = ({ items, label, onViewMore, cb }) =>\n\titems.length > 0 ? (\n\t\t<>\n\t\t\t<ModalField>\n\t\t\t\t<div className=\"XXX\">\n\t\t\t\t\t<label>{label}</label>\n\t\t\t\t</div>\n\t\t\t</ModalField>\n\t\t\t{items.map(item => (\n\t\t\t\t<ModalField key={item.id}>\n\t\t\t\t\t<div className=\"SearchResultItem\">{cb(item)}</div>\n\t\t\t\t</ModalField>\n\t\t\t))}\n\t\t\t<ModalField>\n\t\t\t\t<div className=\"XXX\">\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\ticon=\"ellipsis-h\"\n\t\t\t\t\t\tonClick={onViewMore}\n\t\t\t\t\t\ttitle=\"View more...\"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</ModalField>\n\t\t</>\n\t) : null;\n","import React, { FC, useRef, useState, useEffect, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport { searchMedias } from \"../../utils/providers\";\nimport { Media } from \"./Medias\";\nimport {\n\tMEDIA_TYPE_DEFINITIONS,\n\tMediaType,\n\tProviderType\n} from \"../../utils/medias\";\nimport { SearchResults } from \"../../utils/providers\";\nimport { SearchResultCategory } from \"./SearchResultCategory\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal } from \"../../reducers/modals\";\nimport { previewMedia } from \"../../actions/medias\";\nimport { isRoomLocked } from \"../../selectors/room\";\nimport { RootState } from \"../../reducers\";\nimport { ModalField } from \"../Modals/ModalFields\";\nimport { PREVIEW_PLAYER } from \"../../utils/player\";\nimport { appendToQueue } from \"../../actions/queue\";\nimport \"./SearchModal.scss\";\n\n// ------------------------------------------------------------------\n\nconst SEARCH_RESULTS_COUNT = 5;\nconst VIEW_MORE_RESULTS_COUNT = 50;\n\n// ------------------------------------------------------------------\n\nexport const SearchModal: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst { t } = useTranslation();\n\tconst queryRef = useRef<HTMLInputElement>(null);\n\tconst locked = useSelector<RootState, boolean>(isRoomLocked);\n\tconst [playingMediaId, setPlayingMediaId] = useState(\"\");\n\tconst [playingMediaProvider, setPlayingMediaProvider] = useState<\n\t\tProviderType\n\t>(\"deezer\");\n\tconst [playingMediaType, setPlayingMediaType] = useState<MediaType>(\n\t\t\"track\"\n\t);\n\tconst [query, setQuery] = useState(\"\");\n\tconst [results, setResults] = useState<SearchResults>({\n\t\tdeezer: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t},\n\t\tspotify: {\n\t\t\talbum: [],\n\t\t\tplaylist: [],\n\t\t\ttrack: []\n\t\t}\n\t});\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onSearch = useCallback(async () => {\n\t\tif (query.trim().length > 0) {\n\t\t\tsetResults(\n\t\t\t\tawait searchMedias(query, {\n\t\t\t\t\tlimit: SEARCH_RESULTS_COUNT\n\t\t\t\t})\n\t\t\t);\n\t\t}\n\t}, [query]);\n\n\tconst onSelect = useCallback(\n\t\t(provider: ProviderType, type: MediaType, id: string) =>\n\t\t\tdispatch(appendToQueue([{ provider, type, id }])),\n\t\t[dispatch]\n\t);\n\n\tconst onStartPreview = useCallback(\n\t\t(provider: ProviderType, type: MediaType, id: string) => {\n\t\t\tdispatch(previewMedia({ provider, type, id }));\n\t\t\tsetPlayingMediaId(id);\n\t\t\tsetPlayingMediaProvider(provider);\n\t\t\tsetPlayingMediaType(type);\n\t\t},\n\t\t[dispatch]\n\t);\n\n\tconst onStopPreview = useCallback(async () => {\n\t\tconsole.debug(\"Stop previewing...\");\n\t\tawait PREVIEW_PLAYER.stop();\n\t\tsetPlayingMediaId(\"\");\n\t\tsetPlayingMediaProvider(\"deezer\");\n\t\tsetPlayingMediaType(\"track\");\n\t}, []);\n\n\tconst onViewMore = useCallback(\n\t\tasync (providerType: ProviderType, mediaType: MediaType) => {\n\t\t\tsetResults(\n\t\t\t\tawait searchMedias(\n\t\t\t\t\tquery,\n\t\t\t\t\t{\n\t\t\t\t\t\tlimit: VIEW_MORE_RESULTS_COUNT\n\t\t\t\t\t},\n\t\t\t\t\tproviderType,\n\t\t\t\t\tmediaType\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\t\t[query, setResults]\n\t);\n\n\tuseEffect(() => {\n\t\tif (queryRef.current) {\n\t\t\tqueryRef.current.focus();\n\t\t}\n\t\treturn () => {\n\t\t\tconsole.debug(\"Stop previewing...\");\n\t\t\t/*await*/ PREVIEW_PLAYER.stop();\n\t\t};\n\t}, [dispatch]);\n\n\treturn (\n\t\t<FormModal\n\t\t\tclassName=\"SearchModal\"\n\t\t\ttitle={t(\"medias.medias_search\")}\n\t\t\tonSubmit={onSearch}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={query.trim().length === 0}\n\t\t\t\t\t\ttitle={t(\"medias.search\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"search\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<ModalField>\n\t\t\t\t<input\n\t\t\t\t\tid=\"modal-query\"\n\t\t\t\t\ttype=\"text\"\n\t\t\t\t\tplaceholder={t(\"medias.search_placeholder\")}\n\t\t\t\t\tmaxLength={100}\n\t\t\t\t\tminLength={2}\n\t\t\t\t\trequired={true}\n\t\t\t\t\tvalue={query}\n\t\t\t\t\tref={queryRef}\n\t\t\t\t\tonChange={e => setQuery(e.target.value)}\n\t\t\t\t/>\n\t\t\t</ModalField>\n\t\t\t{MEDIA_TYPE_DEFINITIONS.map(({ label, provider, type }) => (\n\t\t\t\t<SearchResultCategory\n\t\t\t\t\tkey={`${provider}.${type}`}\n\t\t\t\t\tlabel={t(label)}\n\t\t\t\t\titems={results[provider][type]}\n\t\t\t\t\tonViewMore={() => onViewMore(provider, type)}\n\t\t\t\t\tcb={media => (\n\t\t\t\t\t\t<Media\n\t\t\t\t\t\t\tactions={\n\t\t\t\t\t\t\t\t<IconButton\n\t\t\t\t\t\t\t\t\tdisabled={locked}\n\t\t\t\t\t\t\t\t\ttitle={t(\"medias.add\")}\n\t\t\t\t\t\t\t\t\ticon=\"plus\"\n\t\t\t\t\t\t\t\t\tonClick={() =>\n\t\t\t\t\t\t\t\t\t\tonSelect(provider, type, media.id)\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmedia={media}\n\t\t\t\t\t\t\tplayable={true}\n\t\t\t\t\t\t\tplaying={\n\t\t\t\t\t\t\t\tplayingMediaProvider === provider &&\n\t\t\t\t\t\t\t\tplayingMediaType === type &&\n\t\t\t\t\t\t\t\tplayingMediaId === media.id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonPlay={() =>\n\t\t\t\t\t\t\t\tonStartPreview(provider, type, media.id)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tonStop={onStopPreview}\n\t\t\t\t\t\t/>\n\t\t\t\t\t)}\n\t\t\t\t/>\n\t\t\t))}\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, useState, useRef, useEffect, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport { InputField, SelectField } from \"../Modals/ModalFields\";\nimport { Dispatch } from \"../../actions\";\nimport { popModal } from \"../../reducers/modals\";\nimport { displayError } from \"../../actions/messages\";\nimport { enterRoom } from \"../../actions/room\";\nimport config, { selectRoomDatabaseId } from \"../../config/firebase\";\n\n// ------------------------------------------------------------------\n\nexport const JoinRoomModal: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst [dbId, setDbId] = useState(selectRoomDatabaseId());\n\tconst [roomId, setRoomId] = useState(\"\");\n\tconst roomIdRef = useRef<HTMLInputElement>(null);\n\tconst { t } = useTranslation();\n\n\tuseEffect(() => {\n\t\tif (roomIdRef.current) {\n\t\t\troomIdRef.current.focus();\n\t\t}\n\t}, [roomIdRef]);\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onJoin = useCallback(() => {\n\t\tif (dbId.trim().length === 0) {\n\t\t\tdispatch(displayError(\"rooms.id_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tif (roomId.trim().length === 0) {\n\t\t\tdispatch(displayError(\"rooms.id_is_invalid\"));\n\t\t\treturn;\n\t\t}\n\t\tdispatch(\n\t\t\tenterRoom({\n\t\t\t\tdbId,\n\t\t\t\troomId,\n\t\t\t\tsecret: \"\",\n\t\t\t\toptions: {\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tdispatch(popModal());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}, [dispatch, roomId, dbId]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"rooms.room_join\")}\n\t\t\tonSubmit={onJoin}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={\n\t\t\t\t\t\t\troomId.trim().length === 0 || roomId.length !== 36\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttitle={t(\"rooms.join\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"check\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<SelectField\n\t\t\t\tid=\"modal-serverId\"\n\t\t\t\tlabel={t(\"rooms.server_id\")}\n\t\t\t\tplaceholder={t(\"rooms.server_id_placeholder\")}\n\t\t\t\toptions={config.dbIDs\n\t\t\t\t\t.sort((s1, s2) => s1.localeCompare(s2))\n\t\t\t\t\t.map(otherId => ({\n\t\t\t\t\t\tid: otherId,\n\t\t\t\t\t\tlabel: otherId\n\t\t\t\t\t}))}\n\t\t\t\tvalue={dbId}\n\t\t\t\tonChange={e => setDbId(e.target.value)}\n\t\t\t/>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-roomId\"\n\t\t\t\tlabel={t(\"rooms.id\")}\n\t\t\t\ttype=\"text\"\n\t\t\t\tplaceholder={t(\"rooms.id_placeholder\")}\n\t\t\t\tmaxLength={36}\n\t\t\t\tminLength={36}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={roomId}\n\t\t\t\tref={roomIdRef}\n\t\t\t\tonChange={e => setRoomId(e.target.value)}\n\t\t\t/>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, useRef, useState, useEffect, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { useTranslation } from \"react-i18next\";\n//\nimport { FormModal } from \"../Modals/FormModal\";\nimport { IconButton } from \"../Common/IconButton\";\nimport { CancelButton } from \"../Common/CancelButton\";\nimport { Dispatch, ActionOptions } from \"../../actions\";\nimport { popModal } from \"../../reducers/modals\";\nimport { unlockRoom } from \"../../actions/room\";\nimport { SECRET_FIELD_SIZE, InputField } from \"../Modals/ModalFields\";\n\n// ------------------------------------------------------------------\n\nexport type UnlockRoomModalProps = { options?: ActionOptions };\n\nexport const UnlockRoomModal: FC<UnlockRoomModalProps> = ({ options }) => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst [secret, setSecret] = useState(\"\");\n\tconst secretRef = useRef<HTMLInputElement>(null);\n\tconst { t } = useTranslation();\n\n\tuseEffect(() => {\n\t\tif (secretRef.current) {\n\t\t\tsecretRef.current.focus();\n\t\t}\n\t}, [secretRef]);\n\n\tconst onClose = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tconst onUnlock = useCallback(() => {\n\t\tdispatch(\n\t\t\tunlockRoom({\n\t\t\t\tsecret,\n\t\t\t\toptions: {\n\t\t\t\t\tonSuccess: () => {\n\t\t\t\t\t\tif (options && options.onSuccess) {\n\t\t\t\t\t\t\toptions.onSuccess();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdispatch(popModal());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t);\n\t}, [dispatch, secret, options]);\n\n\treturn (\n\t\t<FormModal\n\t\t\ttitle={t(\"rooms.room_unlocking\")}\n\t\t\tonSubmit={onUnlock}\n\t\t\trenderButtons={() => (\n\t\t\t\t<>\n\t\t\t\t\t<IconButton\n\t\t\t\t\t\tdisabled={secret.length !== SECRET_FIELD_SIZE}\n\t\t\t\t\t\ttitle={t(\"rooms.unlock\")}\n\t\t\t\t\t\tkind=\"primary\"\n\t\t\t\t\t\ticon=\"unlock\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t/>\n\t\t\t\t\t<CancelButton onClick={onClose} />\n\t\t\t\t</>\n\t\t\t)}>\n\t\t\t<InputField\n\t\t\t\tid=\"modal-secret\"\n\t\t\t\tlabel={t(\"rooms.key\")}\n\t\t\t\ttype=\"password\"\n\t\t\t\tautoComplete=\"password\"\n\t\t\t\tplaceholder={t(\"rooms.key_placeholder\")}\n\t\t\t\tmaxLength={36}\n\t\t\t\tminLength={36}\n\t\t\t\trequired={true}\n\t\t\t\tvalue={secret}\n\t\t\t\tref={secretRef}\n\t\t\t\tonChange={e => setSecret(e.target.value)}\n\t\t\t/>\n\t\t</FormModal>\n\t);\n};\n","import React, { FC, MouseEvent, useState, useEffect, useCallback } from \"react\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { CSSTransition } from \"react-transition-group\";\n//\nimport { Dispatch } from \"../../actions\";\nimport { RootState } from \"../../reducers\";\nimport { ModalPrereq, popModal } from \"../../reducers/modals\";\nimport { ConfirmModal } from \"./ConfirmModal\";\nimport { ConnectUserModal } from \"../Users/ConnectUserModal\";\nimport { CreateRoomModal } from \"../Room/CreateRoomModal\";\nimport { CreateUserModal } from \"..//Users/CreateUserModal\";\nimport { HelpModal } from \"./HelpModal\";\nimport { SeaBattleGameOverModal } from \"../SeaBattle/GameOverModal\";\nimport { SeaBattleHelpModal } from \"../SeaBattle/HelpModal\";\nimport { SearchModal } from \"../Room/SearchModal\";\nimport { JoinRoomModal } from \"../Room/JoinRoomModal\";\nimport { UnlockRoomModal } from \"../Room/UnlockRoomModal\";\nimport \"./index.scss\";\n\n// ------------------------------------------------------------------\n\nconst TRANSITION_TIMEOUT = 300;\n\n// ------------------------------------------------------------------\n\nexport const getModal = (prereq?: ModalPrereq) => {\n\tif (prereq) {\n\t\tswitch (prereq.type) {\n\t\t\t// General\n\t\t\tcase \"General/Confirm\":\n\t\t\t\treturn <ConfirmModal {...prereq.props} />;\n\t\t\tcase \"General/Help\":\n\t\t\t\treturn <HelpModal />;\n\t\t\t// User\n\t\t\tcase \"User/Connect\":\n\t\t\t\treturn <ConnectUserModal {...prereq.props} />;\n\t\t\tcase \"User/Create\":\n\t\t\t\treturn <CreateUserModal {...prereq.props} />;\n\t\t\t// Room\n\t\t\tcase \"Room/Create\":\n\t\t\t\treturn <CreateRoomModal {...prereq.props} />;\n\t\t\tcase \"Room/Join\":\n\t\t\t\treturn <JoinRoomModal />;\n\t\t\tcase \"Room/Search\":\n\t\t\t\treturn <SearchModal />;\n\t\t\tcase \"Room/Unlock\":\n\t\t\t\treturn <UnlockRoomModal {...prereq.props} />;\n\t\t\t// SeaBattle\n\t\t\tcase \"SeaBattle/GameOver\":\n\t\t\t\treturn <SeaBattleGameOverModal {...prereq.props} />;\n\t\t\tcase \"SeaBattle/Help\":\n\t\t\t\treturn <SeaBattleHelpModal />;\n\t\t}\n\t}\n\treturn null;\n};\n\n// ------------------------------------------------------------------\n\nexport const Modals: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\tconst prereq = useSelector<RootState, ModalPrereq | undefined>(state =>\n\t\tstate.modals.stack.length > 0\n\t\t\t? state.modals.stack[state.modals.stack.length - 1]\n\t\t\t: void 0\n\t);\n\n\tconst [currPrereq, setCurrPrereq] = useState<ModalPrereq | undefined>(\n\t\tvoid 0\n\t);\n\tconst [prevPrereq, setPrevPrereq] = useState<ModalPrereq | undefined>(\n\t\tvoid 0\n\t);\n\n\tconst onPopModal = useCallback(() => dispatch(popModal()), [dispatch]);\n\n\tuseEffect(() => {\n\t\tconst keyDown = (e: KeyboardEvent) => {\n\t\t\tif (e.keyCode === 27) {\n\t\t\t\tonPopModal();\n\t\t\t}\n\t\t};\n\n\t\tdocument.addEventListener(\"keydown\", keyDown);\n\n\t\treturn () => {\n\t\t\tdocument.removeEventListener(\"keydown\", keyDown);\n\t\t};\n\t}, [onPopModal]);\n\n\tuseEffect(() => {\n\t\t// Hide current modal before showing new one (if there is a new one)\n\t\tsetCurrPrereq(void 0);\n\t\tsetPrevPrereq(prereq);\n\t}, [prereq]);\n\n\tuseEffect(() => {\n\t\tif (prereq) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tsetCurrPrereq(prereq);\n\t\t\t}, TRANSITION_TIMEOUT);\n\t\t}\n\t}, [prereq]);\n\n\tconst modal = getModal(currPrereq || prevPrereq);\n\treturn (\n\t\t<CSSTransition\n\t\t\tin={!!currPrereq}\n\t\t\ttimeout={TRANSITION_TIMEOUT}\n\t\t\tunmountOnExit={true}>\n\t\t\t<div\n\t\t\t\tclassName=\"ModalOverlay\"\n\t\t\t\tonClick={e => {\n\t\t\t\t\t// Clicking overlay will close current modal\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tonPopModal();\n\t\t\t\t}}>\n\t\t\t\t{modal && (\n\t\t\t\t\t<div\n\t\t\t\t\t\tclassName=\"ModalWrapper\"\n\t\t\t\t\t\trole=\"dialog\"\n\t\t\t\t\t\tonClick={(e: MouseEvent) => {\n\t\t\t\t\t\t\t// Clicking wrapper modal will not progagate to overlay which would close current modal\n\t\t\t\t\t\t\te.stopPropagation();\n\t\t\t\t\t\t}}>\n\t\t\t\t\t\t{modal}\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\t\t</CSSTransition>\n\t);\n};\n","import { Reducer } from \"redux\";\nimport { createAction } from \"../actions\";\n\n// ------------------------------------------------------------------\n\ntype AppAction = ReturnType<typeof resetApp> | ReturnType<typeof setApp>;\n\nexport const resetApp = () => createAction(\"app/RESET\");\nexport const setApp = (values: Partial<State>) =>\n\tcreateAction(\"app/SET\", values);\n\n// ------------------------------------------------------------------\n\nexport type State = {\n\tonline: boolean;\n};\n\nconst INITIAL_STATE: State = {\n\tonline: navigator.onLine\n};\n\n// ------------------------------------------------------------------\n\nexport const appReducer: Reducer<State, AppAction> = (\n\tstate = INITIAL_STATE,\n\taction: AppAction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"app/SET\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\t...action.payload\n\t\t\t};\n\t\tcase \"app/RESET\":\n\t\t\treturn INITIAL_STATE;\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import React, { FC, useEffect, useCallback } from \"react\";\nimport { useDispatch } from \"react-redux\";\nimport { Redirect, Route, Switch } from \"react-router-dom\";\n//\nimport { Room } from \"./Room\";\nimport { Splash } from \"./Splash\";\nimport { Modals } from \"../components/Modals\";\nimport { reconnectUser } from \"../actions/user\";\nimport { Dispatch } from \"../actions\";\nimport { setApp } from \"../reducers/app\";\nimport \"./App.scss\";\n\n// ------------------------------------------------------------------\n\nexport const App: FC = () => {\n\tconst dispatch = useDispatch<Dispatch>();\n\n\tconst onOnlineStatusChange = useCallback(() => {\n\t\tdispatch(setApp({ online: navigator.onLine }));\n\t}, [dispatch]);\n\n\tuseEffect(() => {\n\t\twindow.addEventListener(\"online\", onOnlineStatusChange);\n\t\twindow.addEventListener(\"offline\", onOnlineStatusChange);\n\n\t\tdispatch(reconnectUser());\n\n\t\treturn () => {\n\t\t\twindow.removeEventListener(\"online\", onOnlineStatusChange);\n\t\t\twindow.removeEventListener(\"offline\", onOnlineStatusChange);\n\t\t};\n\t}, [dispatch, onOnlineStatusChange]);\n\n\treturn (\n\t\t<div className=\"App\">\n\t\t\t<Modals />\n\t\t\t<Switch>\n\t\t\t\t<Route\n\t\t\t\t\texact={true}\n\t\t\t\t\tpath=\"/room/:dbId/:roomId\"\n\t\t\t\t\tcomponent={Room}\n\t\t\t\t/>\n\t\t\t\t<Route exact={true} path=\"/\" component={Splash} />\n\t\t\t\t<Redirect to=\"/\" />\n\t\t\t</Switch>\n\t\t</div>\n\t);\n};\n","export default {\n\taudio: {\n\t\terrors: {\n\t\t\tcannot_decode_audio_data: \"Audio buffer cannot be decoded\",\n\t\t\tcannot_load_audio_buffer: \"Audio buffer loading failed\"\n\t\t}\n\t},\n\tsplash: {\n\t\tCGU: \"CGU\",\n\t\tpowered_with: \"Powered with\",\n\t\tdescription: \"Collaborative & Musical Experimentations\"\n\t},\n\thelp: {\n\t\thelp: \"Help\",\n\t\trules: \"Rules:\",\n\t\trule1: \"Create an account\",\n\t\trule1b: \"or connect\",\n\t\trule2: \"Create a room\",\n\t\trule2b: \"or join one\",\n\t\tnotes: \"Notes:\",\n\t\tnote1:\n\t\t\t\"A room is protected with a secret: it can be accessed without its secret but then no action can be done in it.\",\n\t\tnote2: \"No personal data is accessed or stored.\"\n\t},\n\tuser: {\n\t\terrors: {\n\t\t\tinvalid: \"User is invalid\"\n\t\t},\n\t\tuser: \"User\",\n\t\tconfirm_disconnect: \"Are you sure you want to disconnect?\",\n\t\tconnect: \"Connect\",\n\t\tconnection: \"Connection\",\n\t\tcreate: \"Create a user\",\n\t\tdisconnect: \"Disconnect\",\n\t\tid: \"User ID\",\n\t\tid_is_invalid: \"ID is invalid\",\n\t\tid_placeholder: \"User ID...\",\n\t\tname_is_invalid: \"Name is invalid\",\n\t\tname_placeholder: \"User Name...\",\n\t\tname: \"User Name\",\n\t\tsecret_is_invalid: \"Secret is invalid\",\n\t\tsecret_placeholder: \"User Secret...\",\n\t\tsecret: \"User Secret\",\n\t\tuser_creation: \"User Registration\",\n\t\tnot_connected: \"No user is identified\"\n\t},\n\trooms: {\n\t\terrors: {\n\t\t\tinvalid: \"Room is invalid\",\n\t\t\tlocked: \"Room is locked\"\n\t\t},\n\t\ttypes: {\n\t\t\tblind: \"Blind Test\",\n\t\t\tdj: \"DJ\",\n\t\t\tseabattle: \"Sea Battle\"\n\t\t},\n\t\tclear: \"Clear all tracks\",\n\t\tconfirm_clear: \"Are you sure you want to remove all tracks?\",\n\t\tconfirm_exit: \"Are you sure you want to leave the room?\",\n\t\tconfirm_lock: \"Are you sure you want to lock the room?\",\n\t\tcopy_link: \"Copy Room Link to Clipboard\",\n\t\tcreate: \"Create a room\",\n\t\tempty: \"It's empty here, you should add some tracks...\",\n\t\tempty_for_now: \"It's empty here, the owner has to fill it..\",\n\t\texit: \"Exit Room\",\n\t\tid: \"Room ID\",\n\t\tid_placeholder: \"Room ID...\",\n\t\tserver_id: \"Server ID\",\n\t\tserver_id_placeholder: \"Server ID...\",\n\t\tkey_placeholder: \"Room Key...\",\n\t\ttype_placeholder: \"Room Type...\",\n\t\tkey: \"Room Key\",\n\t\ttype: \"Room Type\",\n\t\tjoin: \"Join a Room\",\n\t\tlink_copied_to_clipboard: \"Room link has been copied to clipboard\",\n\t\tloading: \"Loading...\",\n\t\tlocked: \"Locked (click to unlock)\",\n\t\tname_is_invalid: \"Name is invalid\",\n\t\tname_placeholder: \"Room Name...\",\n\t\tname: \"Room Name\",\n\t\troom_creation: \"Room Creation\",\n\t\troom_join: \"Room Access\",\n\t\troom_unlocking: \"Room Unlocking\",\n\t\troom: \"Room\",\n\t\tsecret_is_invalid: \"Secret is invalid\",\n\t\tunlock: \"Unlock\",\n\t\tunlocked: \"Unlocked (click to lock)\",\n\t\tmedia_count: \"{{count}} media\",\n\t\tmedia_count_plural: \"{{count}} medias\",\n\t\ttrack_count: \"{{count}} track\",\n\t\ttrack_count_plural: \"{{count}} tracks\"\n\t},\n\tmedias: {\n\t\tby: \"by {{artist}}\",\n\t\tadd: \"Add\",\n\t\tremove: \"Remove\",\n\t\tsearch: \"Search Media\",\n\t\tsearch_placeholder: \"Search...\",\n\t\tmedias_search: \"Media Search\",\n\t\tdeezer: {\n\t\t\talbums: \"Deezer Albums\",\n\t\t\tplaylists: \"Deezer Playlists\",\n\t\t\ttracks: \"Deezer Tracks\"\n\t\t},\n\t\tspotify: {\n\t\t\talbums: \"Spotify Albums\",\n\t\t\tplaylists: \"Spotify Playlists\",\n\t\t\ttracks: \"Spotify Tracks\"\n\t\t}\n\t},\n\tplayer: {\n\t\tbackward: \"Backward\",\n\t\tforward: \"Forward\",\n\t\tplay: \"Play\",\n\t\tplaying: \"Playing\",\n\t\tstop: \"Stop\"\n\t},\n\tcancel: \"Cancel\",\n\tclear: \"Clear\",\n\tcopy_to_clipboard: \"Copy to Clipboard\",\n\tloading: \"Loading...\",\n\tsecret_copied_to_clipboard: \"Secret has been copied to clipboard\",\n\n\t// --------------------------------------------------------------\n\n\tgames: {\n\t\tseabattle: {\n\t\t\thelp: {\n\t\t\t\tyou_can: \"At each turn, you can:\",\n\t\t\t\tmove_boat: \"Move one of your ship\",\n\t\t\t\tattack_opponent: \"Attack an opponent\",\n\t\t\t\t//\n\t\t\t\tto_move: \"To move:\",\n\t\t\t\tselect_boat: \"Select one of your ship\",\n\t\t\t\tmove_with_keyboard: \"Move it with the keyboard\",\n\t\t\t\tor_use_the_buttons: \"Or move it using buttons\",\n\t\t\t\t//\n\t\t\t\tto_attack: \"To attack:\",\n\t\t\t\tselect_weapon: \"Select one your weapon\",\n\t\t\t\tclick_opponent_cell: \"Click on opponent grid\",\n\t\t\t\t//\n\t\t\t\tto_react: \"To react following an attack:\",\n\t\t\t\thitted_hit: \"Red dot = opponent hitted\",\n\t\t\t\tmissed_hit: \"White dot = opponent missed\"\n\t\t\t},\n\t\t\tturn_left: \"Turn Left\",\n\t\t\tturn_right: \"Turn Right\",\n\t\t\tmove_forward: \"Move Forward\",\n\t\t\tmove_backward: \"Move Backward\",\n\t\t\tmove_down: \"Move Down\",\n\t\t\tmove_left: \"Move Left\",\n\t\t\tmove_right: \"Move Right\",\n\t\t\tmove_up: \"Move Up\",\n\t\t\tmovement_not_possible: \"This movement is not possible!\",\n\t\t\tmovement_not_possible_because_hitted: \"A hitted ship cannot move!\",\n\t\t\topponent_index: \"Opponent {{index}}\",\n\t\t\tjoin_battle: \"Join the battle\",\n\t\t\tship_already_hitted: \"Ship is already hitten at this position\",\n\t\t\tship_already_killed: \"Ship has already been killed\",\n\t\t\thitted_opponent: \"You've hitted opponent ship\",\n\t\t\tkilled_opponent_boat: \"You've destroyed opponent ship\",\n\t\t\tmissed_opponent: \"You've missed opponent ship\",\n\t\t\tno_weapon_selected: \"Select a weapon to attack\",\n\t\t\tweapon_not_available: \"Selected weapon is not available\",\n\t\t\tnot_your_turn: \"This is not your turn\",\n\t\t\topponent_turn: \"It's your opponent turn to play\",\n\t\t\tplayer_turn: \"It's your turn to move or attack\",\n\t\t\tyou_lost1: \"You lost!\",\n\t\t\tyou_lost2: \"All your ships have been destroyed\",\n\t\t\tyou_won1: \"You won!\",\n\t\t\tyou_won2: \"All opponent ships have been destroyed\"\n\t\t},\n\t\tgameover: \"Game Over\",\n\t\tmax_players_count: \"Maximum players number has been already reached\",\n\t\tno_opponents: \"No opponents\",\n\t\tno_opponents_to_attack: \"There is no opponent to attack...\",\n\t\tconnect_to_join: \"You have to connect to join...\",\n\t\twatch_or_join: \"You can watch or...\"\n\t}\n};\n","export default {\n\taudio: {\n\t\terrors: {\n\t\t\tcannot_decode_audio_data: \"Le buffer audio ne peut pas être décodé\",\n\t\t\tcannot_load_audio_buffer: \"Le buffer audio ne peut pas être chargé\"\n\t\t}\n\t},\n\tsplash: {\n\t\tCGU: \"CGU\",\n\t\tpowered_with: \"Utilise\",\n\t\tdescription: \"Expérimentations collaboratives et musicales\"\n\t},\n\thelp: {\n\t\thelp: \"Aide\",\n\t\trules: \"Règles :\",\n\t\trule1: \"Créez un compte\",\n\t\trule1b: \"ou connectez-vous\",\n\t\trule2: \"Créez une salle\",\n\t\trule2b: \"ou rejoignez en une\",\n\t\tnotes: \"Notes :\",\n\t\tnote1:\n\t\t\t\"Un salle est protégée par un secret : elle peut être accédée sans son secret mais aucune action ne pourra y être réalisée.\",\n\t\tnote2: \"Aucune donnée personnelle n'est manipulée ou stockée.\"\n\t},\n\tuser: {\n\t\terrors: {\n\t\t\tinvalid: \"L'utilisateur est invalide\"\n\t\t},\n\t\tuser: \"Utilisateur\",\n\t\tconfirm_disconnect: \"Êtes-vous sûr(e) de vouloir vous déconnecter ?\",\n\t\tconnect: \"Se connecter\",\n\t\tconnection: \"Connexion\",\n\t\tcreate: \"Créer un utilisateur\",\n\t\tdisconnect: \"Se déconnecter\",\n\t\tid: \"Identifiant\",\n\t\tid_is_invalid: \"L'identifiant est invalide\",\n\t\tid_placeholder: \"Identifiant...\",\n\t\tname_is_invalid: \"Le nom est invalide\",\n\t\tname_placeholder: \"Nom...\",\n\t\tname: \"Nom\",\n\t\tsecret_is_invalid: \"Le secret est invalide\",\n\t\tsecret_placeholder: \"Secret...\",\n\t\tsecret: \"Secret\",\n\t\tuser_creation: \"Création d'un utilisateur\",\n\t\tnot_connected: \"Aucun utilisateur identifié\"\n\t},\n\trooms: {\n\t\terrors: {\n\t\t\tinvalid: \"La salle est invalide\",\n\t\t\tlocked: \"La salle est verrouillée\"\n\t\t},\n\t\ttypes: {\n\t\t\tblind: \"Blind Test\",\n\t\t\tdj: \"DJ\",\n\t\t\tseabattle: \"Bataille Navale\"\n\t\t},\n\t\tclear: \"Supprimer toutes les pistes\",\n\t\tconfirm_clear:\n\t\t\t\"Êtes-vous sûr(e) de vouloir supprimer toutes les pistes ?\",\n\t\tconfirm_exit: \"Êtes-vous sûr(e) de vouloir quitter la salle ?\",\n\t\tconfirm_lock: \"Êtes-vous sûr(e) de vouloir verrouiller la salle ?\",\n\t\tcopy_link: \"Copier le lien de la salle dans le presse-papier\",\n\t\tcreate: \"Créer une salle\",\n\t\tempty: \"Cette salle est vide, vous devriez ajouter quelques pistes...\",\n\t\tempty_for_now: \"Cette salle est pour le moment vide...\",\n\t\texit: \"Quitter la salle\",\n\t\tid: \"Identifiant de la salle\",\n\t\tid_placeholder: \"Identifiant de la salle...\",\n\t\tserver_id: \"Identifiant du serveur\",\n\t\tserver_id_placeholder: \"Identifiant du serveur...\",\n\t\tkey_placeholder: \"Clef...\",\n\t\ttype_placeholder: \"Type...\",\n\t\tkey: \"Clef\",\n\t\ttype: \"Type\",\n\t\tjoin: \"Rejoindre une salle\",\n\t\tloading: \"Chargement...\",\n\t\tlink_copied_to_clipboard:\n\t\t\t\"Le lien de la salle a été copié dans le presse-papier\",\n\t\tlocked: \"Verrouillée (cliquer pour déverrouiller)\",\n\t\tname_is_invalid: \"Le nom est invalide\",\n\t\tname_placeholder: \"Nom...\",\n\t\tname: \"Nom\",\n\t\troom: \"Salle\",\n\t\troom_creation: \"Création d'une salle\",\n\t\troom_join: \"Rejoindre une salle\",\n\t\troom_unlocking: \"Déverrouillage de la salle\",\n\t\tsecret_is_invalid: \"Le secret is invalide\",\n\t\tunlock: \"Déverrouiller\",\n\t\tunlocked: \"Déverrouillée (cliquer pour verrouiller)\",\n\t\tmedia_count: \"{{count}} media\",\n\t\tmedia_count_plural: \"{{count}} medias\",\n\t\ttrack_count: \"{{count}} piste\",\n\t\ttrack_count_plural: \"{{count}} pistes\"\n\t},\n\tmedias: {\n\t\tby: \"par {{artist}}\",\n\t\tadd: \"Ajouter\",\n\t\tremove: \"Supprimer\",\n\t\tsearch: \"Chercher des médias\",\n\t\tsearch_placeholder: \"Recherche...\",\n\t\tmedias_search: \"Recherche de médias\",\n\t\tdeezer: {\n\t\t\talbums: \"Deezer Albums\",\n\t\t\tplaylists: \"Deezer Playlists\",\n\t\t\ttracks: \"Deezer Pistes\"\n\t\t},\n\t\tspotify: {\n\t\t\talbums: \"Spotify Albums\",\n\t\t\tplaylists: \"Spotify Playlists\",\n\t\t\ttracks: \"Spotify Pistes\"\n\t\t}\n\t},\n\tplayer: {\n\t\tbackward: \"Piste précédente\",\n\t\tforward: \"Piste suivante\",\n\t\tplay: \"Lire\",\n\t\tplaying: \"En cours de lecture\",\n\t\tstop: \"Arrêter\"\n\t},\n\tcancel: \"Annuler\",\n\tclear: \"Supprimer\",\n\tcopy_to_clipboard: \"Copier dans le presse-papier\",\n\tloading: \"Chargement...\",\n\tsecret_copied_to_clipboard: \"Le secret a été copié dans le presse-papier\",\n\n\t// --------------------------------------------------------------\n\n\tgames: {\n\t\tseabattle: {\n\t\t\thelp: {\n\t\t\t\tyou_can: \"À chaque tour, vous pouvez :\",\n\t\t\t\tmove_boat: \"Déplacer un de vos navires\",\n\t\t\t\tattack_opponent: \"Attaquer un de vos ennemis\",\n\t\t\t\t//\n\t\t\t\tto_move: \"Pour réaliser un déplacements :\",\n\t\t\t\tselect_boat: \"Sélectionnez un de vos navires\",\n\t\t\t\tmove_with_keyboard: \"Déplacez le avec le clavier\",\n\t\t\t\tor_use_the_buttons: \"Ou utilisez les boutons :\",\n\t\t\t\t//\n\t\t\t\tto_attack: \"Pour réaliser une attaque :\",\n\t\t\t\tselect_weapon: \"Sélectionnez une de vos armes\",\n\t\t\t\tclick_opponent_cell: \"Cliquez sur la grille ennemi\",\n\t\t\t\t//\n\t\t\t\tto_react: \"Pour réagir à une attaque :\",\n\t\t\t\thitted_hit: \"Rond rouge = ennemi blessé\",\n\t\t\t\tmissed_hit: \"Rond blanc = ennemi raté\"\n\t\t\t},\n\t\t\tturn_left: \"Tourner à gauche\",\n\t\t\tturn_right: \"Tourner à droite\",\n\t\t\tmove_forward: \"Avancer\",\n\t\t\tmove_backward: \"Reculer\",\n\t\t\tmove_down: \"Aller vers le bas\",\n\t\t\tmove_left: \"Aller vers la gauche\",\n\t\t\tmove_right: \"Aller vers la droite\",\n\t\t\tmove_up: \"Aller vers le haut\",\n\t\t\tmovement_not_possible: \"Ce déplacement est impossible !\",\n\t\t\tmovement_not_possible_because_hitted:\n\t\t\t\t\"Un navire touché ne peut plus se déplacer !\",\n\t\t\topponent_index: \"Adversaire {{index}}\",\n\t\t\tjoin_battle: \"Participer à la bataille\",\n\t\t\tship_already_hitted: \"Le navire est touché touché à cette position\",\n\t\t\tship_already_killed: \"Le navire a déjà été tué\",\n\t\t\thitted_opponent: \"Vous avez touché un navire ennemi\",\n\t\t\tkilled_opponent_boat: \"Vous avez détruit un navire ennemi\",\n\t\t\tmissed_opponent: \"Vous n'avez pas touché de navire ennemi\",\n\t\t\tno_weapon_selected: \"Sélectionnez une arme pour attaquer\",\n\t\t\tweapon_not_available: \"L'arme sélectionnée n'est plus disponible\",\n\t\t\tnot_your_turn: \"Ce n'est pas à votre tour de jouer\",\n\t\t\topponent_turn: \"C'est au tour de votre adversaire de jouer\",\n\t\t\tplayer_turn: \"C'est à votre tour de bouger ou d'attaquer\",\n\t\t\tyou_lost1: \"Perdu !\",\n\t\t\tyou_lost2: \"Tous vos navires ont été abattus\",\n\t\t\tyou_won1: \"Gagné !\",\n\t\t\tyou_won2: \"Tous les navires ennemis ont été abattus\"\n\t\t},\n\t\tgameover: \"Game Over\",\n\t\tmax_players_count: \"Le nombre maximal de joueurs est déjà atteint\",\n\t\tno_opponents: \"Aucun ennemi\",\n\t\tno_opponents_to_attack: \"Il n'y aucun ennemi à attaquer ...\",\n\t\tconnect_to_join: \"Vous devez vous connecter pour participer ...\",\n\t\twatch_or_join: \"Vous pouvez regarder ou ...\"\n\t}\n};\n","import i18next from \"i18next\";\nimport { initReactI18next } from \"react-i18next\";\n//\nimport en from \"../locales/en\";\nimport fr from \"../locales/fr\";\n\n// --------------------------------------------------------------\n\ntype Language = \"en\" | \"fr\";\n\n// --------------------------------------------------------------\n\nexport const changeLanguage = (language: Language) =>\n\ti18next.changeLanguage(language);\n\n// --------------------------------------------------------------\n\nexport const initLocales = async (): Promise<void> =>\n\tnew Promise((resolve, reject) => {\n\t\tconsole.debug(\"Initializing language...\", {\n\t\t\tcurrent: navigator.language || (navigator as any).userLanguage\n\t\t});\n\t\ti18next.use(initReactI18next).init(\n\t\t\t{\n\t\t\t\tfallbackLng: \"en\",\n\t\t\t\tlng: navigator.language || (navigator as any).userLanguage,\n\t\t\t\tresources: {\n\t\t\t\t\ten: { translation: en },\n\t\t\t\t\t\"en-US\": { translation: en },\n\t\t\t\t\tfr: { translation: fr },\n\t\t\t\t\t\"fr-FR\": { translation: fr }\n\t\t\t\t},\n\t\t\t\tinterpolation: {\n\t\t\t\t\tescapeValue: false, // react is already safe from xss\n\t\t\t\t\tformat: (value, format, lng) => {\n\t\t\t\t\t\t// if (format === \"uppercase\") return value.toUpperCase();\n\t\t\t\t\t\t// if (value instanceof Date) return moment(value).format(format);\n\t\t\t\t\t\treturn value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\terror => {\n\t\t\t\tif (error) reject(error);\n\t\t\t\tresolve();\n\t\t\t}\n\t\t);\n\t});\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n\twindow.location.hostname === \"localhost\" ||\n\t\t// [::1] is the IPv6 localhost address.\n\t\twindow.location.hostname === \"[::1]\" ||\n\t\t// 127.0.0.0/8 are considered localhost for IPv4.\n\t\twindow.location.hostname.match(\n\t\t\t/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n\t\t)\n);\n\nexport function register(config?: RegistrationOptions) {\n\tif (process.env.NODE_ENV === \"production\" && \"serviceWorker\" in navigator) {\n\t\tconsole.debug(\"PWA register 1\", process.env.PUBLIC_URL);\n\t\t// The URL constructor is available in all browsers that support SW.\n\t\tconst publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n\t\tif (publicUrl.origin !== window.location.origin) {\n\t\t\tconsole.debug(\"PWA register 2\");\n\t\t\t// Our service worker won't work if PUBLIC_URL is on a different origin\n\t\t\t// from what our page is served on. This might happen if a CDN is used to\n\t\t\t// serve assets; see https://github.com/facebook/create-react-app/issues/2374\n\t\t\treturn;\n\t\t}\n\n\t\twindow.addEventListener(\"load\", () => {\n\t\t\tconst swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\t\t\tconsole.debug(\"PWA register 3\");\n\t\t\tif (isLocalhost) {\n\t\t\t\tconsole.debug(\"PWA register 4\");\n\t\t\t\t// This is running on localhost. Let's check if a service worker still exists or not.\n\t\t\t\tcheckValidServiceWorker(swUrl, config);\n\n\t\t\t\t// Add some additional logging to localhost, pointing developers to the\n\t\t\t\t// service worker/PWA documentation.\n\t\t\t\tnavigator.serviceWorker.ready.then(() => {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"This web app is being served cache-first by a service \" +\n\t\t\t\t\t\t\t\"worker. To learn more, visit https://bit.ly/CRA-PWA\"\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tconsole.debug(\"PWA register 5\");\n\t\t\t\t// Is not localhost. Just register service worker\n\t\t\t\tregisterValidSW(swUrl, config);\n\t\t\t}\n\t\t});\n\t}\n}\n\nfunction registerValidSW(swUrl: string, config?: RegistrationOptions) {\n\tconsole.debug(\"PWA registerValidSW 1\");\n\tnavigator.serviceWorker\n\t\t.register(swUrl)\n\t\t.then(registration => {\n\t\t\tconsole.debug(\"PWA registerValidSW 2\");\n\t\t\tregistration.onupdatefound = () => {\n\t\t\t\tconsole.debug(\"PWA registerValidSW 3\");\n\t\t\t\tconst installingWorker = registration.installing;\n\t\t\t\tif (installingWorker == null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconsole.debug(\"PWA registerValidSW 4\");\n\t\t\t\tinstallingWorker.onstatechange = () => {\n\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\"PWA registerValidSW 5\",\n\t\t\t\t\t\tinstallingWorker.state\n\t\t\t\t\t);\n\t\t\t\t\tif (installingWorker.state === \"installed\") {\n\t\t\t\t\t\tif (navigator.serviceWorker.controller) {\n\t\t\t\t\t\t\tconsole.debug(\"PWA registerValidSW 6\");\n\t\t\t\t\t\t\t// At this point, the updated precached content has been fetched,\n\t\t\t\t\t\t\t// but the previous service worker will still serve the older\n\t\t\t\t\t\t\t// content until all client tabs are closed.\n\t\t\t\t\t\t\tconsole.debug(\n\t\t\t\t\t\t\t\t\"New content is available and will be used when all \" +\n\t\t\t\t\t\t\t\t\t\"tabs for this page are closed. See https://bit.ly/CRA-PWA.\"\n\t\t\t\t\t\t\t);\n\n\t\t\t\t\t\t\t// Execute callback\n\t\t\t\t\t\t\tif (config && (config as any).onUpdate) {\n\t\t\t\t\t\t\t\t(config as any).onUpdate(registration);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.debug(\"PWA registerValidSW 7\");\n\t\t\t\t\t\t\t// At this point, everything has been precached.\n\t\t\t\t\t\t\t// It's the perfect time to display a\n\t\t\t\t\t\t\t// \"Content is cached for offline use.\" message.\n\t\t\t\t\t\t\tconsole.debug(\"Content is cached for offline use.\");\n\n\t\t\t\t\t\t\t// Execute callback\n\t\t\t\t\t\t\tif (config && (config as any).onSuccess) {\n\t\t\t\t\t\t\t\t(config as any).onSuccess(registration);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t};\n\t\t})\n\t\t.catch(error => {\n\t\t\tconsole.error(\"Error during service worker registration:\", error);\n\t\t});\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: RegistrationOptions) {\n\tconsole.debug(\"PWA checkValidServiceWorker 1\");\n\t// Check if the service worker can be found. If it can't reload the page.\n\tfetch(swUrl, {\n\t\theaders: { \"Service-Worker\": \"script\" }\n\t})\n\t\t.then(response => {\n\t\t\t// Ensure service worker exists, and that we really are getting a JS file.\n\t\t\tconst contentType = response.headers.get(\"content-type\");\n\t\t\tconsole.debug(\n\t\t\t\t\"PWA checkValidServiceWorker 2\",\n\t\t\t\tcontentType,\n\t\t\t\tresponse.status\n\t\t\t);\n\t\t\tif (\n\t\t\t\tresponse.status === 404 ||\n\t\t\t\t(contentType != null &&\n\t\t\t\t\tcontentType.indexOf(\"javascript\") === -1)\n\t\t\t) {\n\t\t\t\t// No service worker found. Probably a different app. Reload the page.\n\t\t\t\tnavigator.serviceWorker.ready.then(registration => {\n\t\t\t\t\tregistration.unregister().then(() => {\n\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t// Service worker found. Proceed as normal.\n\t\t\t\tregisterValidSW(swUrl, config);\n\t\t\t}\n\t\t})\n\t\t.catch(() => {\n\t\t\tconsole.debug(\n\t\t\t\t\"No internet connection found. App is running in offline mode.\"\n\t\t\t);\n\t\t});\n}\n\nexport function unregister() {\n\tif (\"serviceWorker\" in navigator) {\n\t\tnavigator.serviceWorker.ready\n\t\t\t.then(registration => {\n\t\t\t\tregistration.unregister();\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tconsole.error(error.message);\n\t\t\t});\n\t}\n}\n","import { Reducer } from \"redux\";\n//\nimport { createAction } from \"../../actions\";\nimport { SeaBattleData } from \"../../utils/games/seabattle\";\n\n// ------------------------------------------------------------------\n\ntype SeaBattleAction =\n\t| ReturnType<typeof fetching>\n\t| ReturnType<typeof error>\n\t| ReturnType<typeof reset>\n\t| ReturnType<typeof set>;\n\nexport const fetching = () => createAction(\"games/seabattle/FETCHING\");\nexport const error = (error: string) =>\n\tcreateAction(\"games/seabattle/ERROR\", error);\nexport const reset = () => createAction(\"games/seabattle/RESET\", error);\nexport const set = (data: SeaBattleData) =>\n\tcreateAction(\"games/seabattle/SET\", data);\n\n// ------------------------------------------------------------------\n\nexport type State = {\n\tfetching: boolean;\n\terror: null | string;\n\tbattle: SeaBattleData;\n};\n\nconst INITIAL_STATE: State = {\n\terror: null,\n\tfetching: false,\n\tbattle: { currentMapIndex: 0, maps: [] }\n};\n\n// ------------------------------------------------------------------\n\nexport const seabattleReducer: Reducer<State, SeaBattleAction> = (\n\tstate = { ...INITIAL_STATE },\n\taction: SeaBattleAction\n): State => {\n\tswitch (action.type) {\n\t\tcase \"games/seabattle/FETCHING\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: true,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"games/seabattle/ERROR\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tfetching: false,\n\t\t\t\terror: action.payload\n\t\t\t};\n\t\tcase \"games/seabattle/SET\":\n\t\t\treturn {\n\t\t\t\t...state,\n\t\t\t\tbattle: action.payload,\n\t\t\t\tfetching: false,\n\t\t\t\terror: null\n\t\t\t};\n\t\tcase \"games/seabattle/RESET\":\n\t\t\treturn INITIAL_STATE;\n\t\tdefault:\n\t\t\treturn state;\n\t}\n};\n","import { combineReducers } from \"redux\";\nimport { seabattleReducer as seabattle } from \"./seabattle\";\n\nexport type GamesState = ReturnType<typeof gamesReducer>;\n\nexport const gamesReducer = combineReducers({\n\tseabattle\n});\n","import { combineReducers } from \"redux\";\nimport { appReducer as app } from \"./app\";\nimport { gamesReducer as games } from \"./games\";\nimport { mediasReducer as medias } from \"./medias\";\nimport { messagesReducer as messages } from \"./messages\";\nimport { modalsReducer as modals } from \"./modals\";\nimport { roomReducer as room } from \"./room\";\nimport { userReducer as user } from \"./user\";\n\nexport type RootState = ReturnType<typeof rootReducer>;\n\nexport const rootReducer = combineReducers({\n\tapp,\n\tgames,\n\tmedias,\n\tmessages,\n\tmodals,\n\troom,\n\tuser\n});\n","import { composeWithDevTools } from \"redux-devtools-extension\";\nimport { applyMiddleware, createStore, compose } from \"redux\";\nimport thunk from \"redux-thunk\";\n//\nimport { rootReducer, RootState } from \"../reducers\";\nimport { QUEUE_PLAYER } from \"./player\";\n\n// ------------------------------------------------------------------\n\nexport const initStore = (initialState?: RootState) => {\n\tconst composeEnhancers =\n\t\tprocess.env.NODE_ENV === \"development\"\n\t\t\t? composeWithDevTools({})\n\t\t\t: compose;\n\n\tconst store = createStore(\n\t\trootReducer,\n\t\tinitialState,\n\t\tcomposeEnhancers(\n\t\t\tapplyMiddleware(\n\t\t\t\tthunk.withExtraArgument({\n\t\t\t\t\tplayer: QUEUE_PLAYER\n\t\t\t\t})\n\t\t\t)\n\t\t)\n\t);\n\n\treturn {\n\t\tdispatch: store.dispatch.bind(store),\n\t\tgetState: store.getState.bind(store),\n\t\tstore\n\t};\n};\n","import * as React from \"react\";\nimport * as ReactDOM from \"react-dom\";\nimport { Provider } from \"react-redux\";\nimport { Route, HashRouter } from \"react-router-dom\";\n//\nimport { App } from \"./pages/App\";\nimport { initLocales } from \"./utils/i18n\";\nimport { register as registerServiceWorker } from \"./serviceWorker\";\nimport { initStore } from \"./utils/redux\";\nimport \"./index.scss\";\n\n// ------------------------------------------------------------------\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nregisterServiceWorker();\n\n// ------------------------------------------------------------------\n\nconst init = async () => {\n\tinitLocales();\n\treturn initStore();\n};\n\n// ------------------------------------------------------------------\n\ninit().then(({ store }) => {\n\tReactDOM.render(\n\t\t<Provider store={store}>\n\t\t\t<HashRouter>\n\t\t\t\t<Route path=\"/\" component={App} />\n\t\t\t</HashRouter>\n\t\t</Provider>,\n\t\tdocument.getElementById(\"root\")\n\t);\n});\n","export const encode = <T>(data: T) =>\n\tBuffer.from(JSON.stringify(data)).toString(\"base64\");\n\nexport const decode = <T>(data: string) =>\n\tJSON.parse(Buffer.from(data, \"base64\").toString(\"ascii\")) as T;\n"],"sourceRoot":""}